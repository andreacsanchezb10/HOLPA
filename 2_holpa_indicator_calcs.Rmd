---
title: "HOLPA farm-household indicator calculation"
output:
  html_document: default
  pdf_document: default
date: "2024-04-18"
editor_options: 
  chunk_output_type: console
---
## Specify settings to use for data analysis

The user needs to specify which country to analyse, where the cleaned HOLPA survey data are saved, and any country/landscape specific conversion parameters.

```{r set user parameters, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr) # for piping
library(tidyverse) #for formatting data
library(ggplot2) # for plots
library(readr) 
library(reshape2) # for changing data layout
library(stringr) # for wrapping text

### Set parameters ####

# Specify country being processed (specify ONE only. You will need to rerun the code to process each country)

#country <- "burkina"
#country <- "india"
#country <- "laos"
#country <- "kenya"
#country <- "peru"
#country <- "senegal"
#country <- "tunisia"
country <- "zimbabwe"

# Alter these parameters as needed for your country/landscape of analysis

# for KPI4 nutrient use, to convert L/ha to kg/ha, set Specific Gravity value
#https://icl-growingsolutions.com/en-gb/turf-landscape/knowledge-hub/nutrient-calculations/ 
nut_conversion_l_to_kg <- 1.23 

# replace these file paths with the location where your data are saved:

global.data.path <- "C:/Users/sjones/OneDrive - CGIAR/Documents/HOLPA/"

bur.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Burkina/burkina_data_clean/bur/"
ind.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/India/india_data_clean/ind/"
ken.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Kenya/kenya_data_clean/ken/"
lao.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Laos/laos_data_clean/lao/"
per.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Peru/peru_data_clean/per/"
sen.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Senegal/senegal_data_clean/sen/"
tun.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Tunisia/tunisia_data_clean/tun/"
zwe.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Zimbabwe/zimbabwe_data_clean/zwe/"


```

## Import data

Run this chunk to import the relevant HOLPA datasets.

```{r import data,include=FALSE}

#### Import data ####

# function to import cleaned data
import.data <- function(country_short,country.data.path){
  cn <- read_csv(paste0(country.data.path,country_short,"_context_format.csv"),show_col_types = FALSE)
  ae <- read_csv(paste0(country.data.path,country_short,"_agroecology_format.csv"),show_col_types = FALSE)
  ae_scores <- read_csv(paste0(country.data.path,country_short,"_agroecology_score.csv"),show_col_types = FALSE)
  pf <- read_csv(paste0(country.data.path,country_short,"_performance_format.csv"),show_col_types = FALSE)
  fw <- read_csv(paste0(country.data.path,country_short,"_fieldwork_format.csv"),show_col_types = FALSE)

# reshape and classify fieldwork data to enable join with household
# (!!! fieldwork indicator extraction work in progress - not finished !!!)
  fw <- melt(fw[,c(1,2,33:length(fw))],id.vars=c("kobo_farmer_id","country"),variable.name="name_question",value.name="name_choice")
  fw <- fw %>%
  mutate(indicator = case_when(
    grepl("tree", name_question) ~ "biodiversity_trees",
    grepl("biodiv", name_question) ~ "biodiversity",
    grepl("1_201", name_question) ~ "biodiversity_landscape", # landscape complexity
    grepl("1_202", name_question) ~ "biodiversity_landscape", # landscape complexity
    grepl("1_203", name_question) ~ "biodiversity_landscape", # landscape complexity
    grepl("1_301", name_question) ~ "crop_health_fw",
    grepl("1_302", name_question) ~ "crop_health_fw",
    grepl("1_303", name_question) ~ "crop_health_fw",
    grepl("1_111", name_question) ~ "soil_health_prac", # practice
    grepl("1_112", name_question) ~ "soil_health_fw",
    grepl("1_113", name_question) ~ "soil_health_prac", # practice
    grepl("1_114", name_question) ~ "soil_health_fw",
    grepl("1_115", name_question) ~ "soil_health_prac", # practice
    grepl("1_116", name_question) ~ "soil_health_fw",
    .default = NA)) %>%
    mutate(subindicator = case_when(
      name_question %in% c("_1_202_1","_1_203_1","_1_204_1") ~ "landscape_pc_nat",
      name_question %in% c("trees_count_1","trees_count_2","trees_count_3") ~ "tree_abundance",
      name_question %in% c("trees_richness_1","trees_richness_2","trees_richness_3") ~ "tree_richness",
      name_question %in% c("_1_111_2","_1_113_2","_1_115_3") ~ "fw_farm_practice",
      name_question %in% c("_1_301_1","_1_302_1","_1_303_1") ~ "crop_appearance",
      name_question %in% c("_1_301_2","_1_302_2","_1_303_2") ~ "crop_growth",
      name_question %in% c("_1_301_3","_1_302_3","_1_303_3") ~ "crop_disease",
      name_question %in% c("_1_301_4","_1_302_4","_1_303_4") ~ "crop_pest",
      name_question %in% c("_1_301_5","_1_302_5","_1_303_5") ~ "crop_enemy",
      name_question %in% c("_1_301_6","_1_302_6","_1_303_6") ~ "crop_weed",
      name_question %in% c("_1_301_7","_1_302_7","_1_303_7") ~ "crop_natural",
      name_question %in% c("_1_301_8","_1_302_8","_1_303_8") ~ "crop_management",
      .default = NA))

country_data <- ae %>% full_join(cn) %>% full_join(pf) %>% full_join(fw)  %>% left_join(ae_scores) %>% unique()
assign(paste0(country_short,"_data"),country_data,envir=.GlobalEnv)
}

if(country == "burkina"){
  import.data("bur",bur.data.path)
  d <- bur_data
  if(country=="india"){
    import.data("ind",ind.data.path)
    d <- ind_data
    if(country=="laos"){
      import.data("lao",lao.data.path)
      d <- lao_data
      if(country=="kenya"){
        import.data("ken",ken.data.path)
        d <- ken_data
        if(country=="peru"){
          import.data("per",per.data.path)
          d <- per_data
           if(country=="senegal"){
             import.data("sen",sen.data.path)
             d <- sen_data
             if(country=="tunisia"){
               import.data("tun",tun.data.path)
               d <- tun_data
               if(country == "zimbabwe"){
                 import.data("zwe",zwe.data.path)
                 d <- zwe_data
               }
             }
           }
        }
      }
    }
  }
}
```


## Calculate agroecology indicator scores
Agroecology adherence indicator scores are pre-calculated in another code (which needs transferring to here).

```{r agroecology indicator calcs, include=TRUE, echo=FALSE}
#### Overall agroecology score ####

d <- d %>%
  mutate(module = ifelse(indicator %in% c("extra_economic_diversification/economic","extra_participation"), "performance", module)) %>%
  mutate(subindicator = ifelse(is.na(subindicator),indicator,subindicator)) %>%
  mutate(subindicator_label = NA) %>%
  mutate(score = ifelse(score_agroecology_module=="no_answer",NA,score_agroecology_module)) %>%
  mutate(score = as.numeric(score)) %>% 
  mutate(score_label = label_score_agroecology_module) %>%
  mutate(indicator_order = ifelse(module=="agroecology",sub('_.*', "", indicator),NA)) %>%
  mutate(indicator_order = as.numeric(indicator_order)) %>%
  select(-c(score_agroecology_module,label_score_agroecology_module))

d_ae_summary <- d %>%
  filter(module == "agroecology") %>%
  group_by(kobo_farmer_id,module) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "score_ae_overall",
         indicator_order=14)

d <- d %>% full_join(d_ae_summary,by=c("kobo_farmer_id","module","indicator","indicator_order", "score"),keep=NULL) 

```
## Calculate Key Performance Indicator scores
Key performance indicator scores are calculated here from survey responses.

```{r KPI calcs, include=TRUE, echo=FALSE}

#### Performance KPI1 crop health ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="crop_health")
#table(temp$label_question)
#table(temp$name_question)
#table(temp$label_question,temp$name_question)

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "What percentage of the total crop production was lost or damaged in the last 12 months [add country meaning]","crop_loss",
                               ifelse(label_question=="What was the main cause of crop loss or damage?", "crop_loss_cause", subindicator))) %>%
  
  #mutate(subindicator = ifelse(name_question =="_3_4_2_1_8_2","crop_loss",
  #                             ifelse(name_question == "_3_4_2_1_8_3","crop_loss_cause",subindicator))) %>%
  
  mutate(subindicator_label = ifelse(subindicator=="crop_loss", "Total crop production lost or damaged in last 12 months (%)", subindicator_label)) %>% 
  mutate(indicator = ifelse(subindicator=="crop_loss" & module=="performance", "kpi1_crop_health", indicator)) %>%
    mutate(indicator_order = ifelse(indicator =="kpi1_crop_health", 1, indicator_order))

# Remove out of bounds responses
d <- d %>% 
  mutate(score = ifelse(indicator == "kpi1_crop_health", as.numeric(name_choice), score)) %>% 
  mutate(score = ifelse(indicator == "kpi1_crop_health" & score>100,NA,score)) %>%
  mutate(module = ifelse(indicator == "kpi1_crop_health","performance kpi",module))

ggplot(d %>% filter(indicator=="kpi1_crop_health"),aes(x=score))+
  geom_histogram()

### Performance KPI1b Crop health from fieldwork ####

### Performance KPI2 animal health ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="animal_health")
#table(temp$label_question)
#table(temp$name_choice)
#table(temp$label_choice)
#table(temp$name_question,temp$label_question)

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "What was the extent of injury, illness or death of livestock due to diseases in the last 12 months","livestock_loss",
                               ifelse(label_question=="Over the past 12 months [add country meaning], how did you manage livestock diseases","livestock_disease_management",subindicator))) %>%
  #mutate(subindicator = ifelse(name_question %in% c( "_1_4_3_8/1","_1_4_3_8/2","_1_4_3_8/3","_1_4_3_8/4","_1_4_3_8/5","_1_4_3_8/6","_1_4_3_8/7","_1_4_3_8/8"),"livestock_loss", ifelse(name_question %in% c("_1_4_3_8/1","_1_4_3_8/2","_1_4_3_8/3","_1_4_3_8/4","_1_4_3_8/5","_1_4_3_8/6","_1_4_3_8/7","_1_4_3_8/8"),"livestock_disease_management",subindicator))) %>%
    mutate(subindicator_label = ifelse(subindicator=="livestock_loss","Extent of livestock injury, illness or death due to diseases in last 12 months (score 1-5)",subindicator_label)) %>%
  mutate(score = ifelse(subindicator =="livestock_loss" & label_choice=="None",5,
                        ifelse(subindicator =="livestock_loss" & label_choice=="Low",3.66,
                               ifelse(subindicator =="livestock_loss" & label_choice=="Medium",2.33,
                                      ifelse(subindicator =="livestock_loss" & label_choice=="High",1,score))))) %>%
  
  mutate(score_label = ifelse(subindicator =="livestock_loss" & label_choice=="None","No livestock injury, illness or death",
                        ifelse(subindicator =="livestock_loss" & label_choice=="Low","Low level of livestock injury, illness or death",
                               ifelse(subindicator =="livestock_loss" & label_choice=="Medium","Medium level of livestock injury, illness or death",
                                      ifelse(subindicator =="livestock_loss" & label_choice=="High","High level of livestock injury, illness or death",score_label))))) %>%
  
  mutate(indicator = ifelse(subindicator=="livestock_loss" & module=="performance","kpi2_animal_health",indicator)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi2_animal_health", 2, indicator_order))  %>%
  mutate(module = ifelse(indicator == "kpi2_animal_health","performance kpi",module))

ggplot(d %>% filter(indicator=="kpi2_animal_health"),aes(x=score))+
  geom_histogram()

#table(d$indicator,d$module)

### Performance KPI3 soil health ####
#temp <- d %>% filter(indicator =="soil_health")
#table(temp$label_question)
#table(temp$subindicator)
#table(temp$name_choice,temp$label_question)
#table(temp$label_choice,temp$name_choice)
#table(temp$label_choice_short,temp$name_choice)
#table(temp$label_choice_short,temp$score)

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "How would you describe the fertility of your soil on your farmland?","soil_fertility",
                               ifelse(label_question=="How would you describe the level of soil erosion problem on your farmland?","soil_erosion",subindicator))) %>%
  
  # NOTE that soil erosion label_choice is the 'wrong' way around, i.e. lower scores are better         
  mutate(score = ifelse(subindicator=="soil_erosion" & name_choice=="0",5,
                        ifelse(subindicator=="soil_erosion" & name_choice=="1",3,
                               ifelse(subindicator=="soil_erosion" & name_choice=="2",1,score)))) %>%
  
  # soil fertility
  mutate(score = ifelse(subindicator=="soil_fertility" & name_choice=="0",1,
                        ifelse(subindicator=="soil_fertility" & name_choice=="1",2.33,
                               ifelse(subindicator=="soil_fertility" & name_choice=="2",3.66,
                                      ifelse(subindicator=="soil_fertility" & name_choice=="3",5,score)))))

# combine soil erosion and fertility scores
temp_kpi_calc <- d %>% filter(subindicator %in% c("soil_erosion","soil_fertility")) %>%
  mutate(score = as.numeric(score)) %>%
  group_by(kobo_farmer_id,country) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "kpi3_soil_health",
         subindicator = "soil_health_overall")

d <- d %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(subindicator_label = ifelse(subindicator=="soil_health_overall","Perceived soil erosion and fertility from 1 (infertile and major soil erosion) to 3 (highly fertile with no soil erosion)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi3_soil_health",3,indicator_order)) %>%
  mutate(module = ifelse(indicator == "kpi3_soil_health","performance kpi",module))

ggplot(d %>% filter(indicator %in% c("kpi3_soil_health")),aes(x=score))+
  geom_histogram()

table(d$indicator,d$module)

### Performance KPI3b soil carbon from fieldwork  ####

#### Performance KPI4 nutrient use ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="nutrient_use") # or inputs
#sort(unique(temp$subindicator))

area_unit <- d %>% filter(indicator =="nutrient_use") %>% filter(label_question =="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}") %>% select(label_choice) %>% unique()
area_unit <- area_unit$label_choice

d <- d %>% 
  # chemical fertilizers
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify applied unit:","nut_chem_unit",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the amount applied","nut_chem_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}","nut_chem_area",subindicator)) %>%
  
  # organic fertilisers generated on-farm
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify applied unit:" ,"nut_orgF_unit",subindicator))  %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify the amount applied:","nut_orgF_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}" , "nut_orgF_area",subindicator)) %>%
  
  # organic fertilizers from other sources
    mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify applied unit:","nut_org_unit",subindicator))  %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify the amount applied" ,"nut_org_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}","nut_org_area",subindicator)) 

# Put into wide format to align associated data
temp_kpi_calc <- d %>% filter(indicator =="nutrient_use") %>%
  filter(subindicator %in% c("nut_chem_unit","nut_chem_quantity","nut_chem_area",
                             "nut_orgF_unit","nut_orgF_quantity","nut_orgF_area",
                             "nut_org_unit","nut_org_quantity","nut_org_area")) %>%
  dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="name_choice") 

# check which units are present
sort(unique(temp_kpi_calc$nut_chem_unit)) 
sort(unique(temp_kpi_calc$nut_org_unit)) 
sort(unique(temp_kpi_calc$nut_orgF_unit)) 

# Calculate nutrient use per unit area
temp_kpi_calc <- temp_kpi_calc %>%
    mutate_at(c("nut_chem_quantity","nut_chem_area",
              "nut_org_quantity","nut_org_area",
              "nut_orgF_quantity","nut_orgF_area"), ~ifelse(is.na(.),0,as.numeric(.))) %>%
  
  # kilograms
  mutate(nut_chem_kg_area = ifelse(nut_chem_quantity>0 & nut_chem_unit =="Kilograms", nut_chem_quantity/nut_chem_area, 0),
         nut_org_kg_area = ifelse(nut_org_quantity>0 & nut_org_unit =="Kilograms", nut_org_quantity/nut_org_area, 0),
         nut_orgF_kg_area = ifelse(nut_orgF_quantity>0 & nut_orgF_unit =="Kilograms", nut_orgF_quantity/nut_orgF_area, 0)) %>%
  
    # litres
  mutate(nut_chem_lt_area_converted = ifelse(nut_chem_quantity>0 & nut_chem_unit %in% c("Liters","Litres" ,"litres","liters"), nut_chem_quantity/nut_chem_area* nut_conversion_l_to_kg, 0)) %>%
  
  # specify area units
  mutate(area_unit = area_unit) %>%
  
  # Total amounts
  mutate(nut_quantity_kg_ha = nut_chem_kg_area + nut_chem_lt_area_converted + nut_org_kg_area + nut_orgF_kg_area) %>%
  mutate(nut_quantity_kg_ha = ifelse(area_unit %in% c("acres","in acres","Acres"), nut_quantity_kg_ha * 0.404686,nut_quantity_kg_ha)) 

temp_kpi_calc <- temp_kpi_calc %>% mutate(indicator = "kpi4_nutrient_use",
                                          subindicator = "nutrient_use", 
                                          score = nut_quantity_kg_ha)

# Add this back into the main dataset
temp_kpi_calc <- temp_kpi_calc %>%
  select(kobo_farmer_id,country,indicator,subindicator,score)

d <- d %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(subindicator_label = ifelse(indicator=="kpi4_nutrient_use","Fertilizer use (kg/ha)",subindicator_label),
         indicator_order = ifelse(indicator =="kpi4_nutrient_use",4,indicator_order)) %>%
    mutate(module = ifelse(indicator == "kpi4_nutrient_use","performance kpi",module))

ggplot(d %>% filter(indicator %in% c("kpi4_nutrient_use")),aes(x=score))+
  geom_histogram()

table(d$indicator,d$module)

### Performance KPI5a biodiversity - animals ####

### Performance KPI5b biodiversity - trees ####

### Performance KPI6a biodiversity - abd species ####

### Performance KPI6b biodiversity - abd varietal ####

### Performance KPI7 biodiversity - complexity ####

### Performance KPI8 climate mitigation ####

### Performance KPI9 water use ####

### Performance KPI10 energy use ####

### Performance KPI11 income ####

### Performance KPI11b income stability ####

### Performance KPI11c income-expenditures ####

### Performance KPI11d income sufficiency ####

### Performance KPI12 yield gap ####

### Performance KPI13 labour productivity ####

### Performance KPI14 climate resilience ####

### Performance KPI15 diet quality ####

### Performance KPI16 farmer agency ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="farmer_agency")
#sort(unique(temp$label_question))

d <- d %>% 
  # household agency
    mutate(subindicator = ifelse(label_question ==  "On which step of the ladder would you position the majority of women in your household today?"   ,"agency_hh_f",subindicator)) %>%
  mutate(subindicator = ifelse(label_question ==  "On which step of the ladder would you position the majority of men in your household today?"    ,"agency_hh_m",subindicator)) 
  
  # Put into wide format to align associated data
temp_kpi_calc <- d %>% filter(subindicator %in% c("agency_hh_f","agency_hh_m")) %>%
  dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="name_choice") 

# Calculate indicators of interest
temp_kpi_calc <- temp_kpi_calc %>%
    mutate_at(c("agency_hh_f","agency_hh_m"), ~as.numeric(.)) %>%
  mutate(agency_hh = median(c(agency_hh_f,agency_hh_m),na.rm=T)) %>%
  mutate(indicator = "kpi16_farmer_agency",
         subindicator = "agency_hh",
         score = agency_hh)

temp_kpi_calc <-  temp_kpi_calc %>% 
    select(kobo_farmer_id,country,indicator,subindicator,score)

d <- d %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(module = ifelse(indicator =="kpi16_farmer_agency","performance kpi",module))  %>%
  mutate(subindicator_label = ifelse(indicator == "kpi16_farmer_agency","Perceived household agency (median for men and women) to make decisions from 1 (no power or freedom) to 5 (total power and freedom)",subindicator_label))

ggplot(d %>% filter(indicator %in% c("kpi16_farmer_agency")),aes(x=score))+
  geom_histogram()

### Performance KPI17a land tenure security and KPI17b land owned as share of total used ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="land_tenure_security")
#sort(unique(temp$label_question))

d <- d %>% 
  # total land
  mutate(subindicator = ifelse(label_question ==  "What is the total area in hectares (or acres) of land (agricultural or not) that your household: Currently OWNS:"    ,"land_owned_hh",subindicator)) %>%
  mutate(subindicator = ifelse(label_question ==  "What is the total area in hectares (or acres) of land (agricultural or not) that your household: Currently LEASES from another person:" ,"land_leased_hh",subindicator)) %>% 
  mutate(subindicator = ifelse(label_question ==  "What is the total area in hectares (or acres) of land (agricultural or not) that your household: Currently HOLDS USE RIGHTS, either alone or jointly with someone else:" ,"land_rights_hh",subindicator)) %>%
  
  # land owned
  mutate(subindicator = ifelse(label_question == "From the ${_1_4_1_1_1} ${_1_4_1_1_calculate} of land that your household OWNS, please specify how much is owned by: A FEMALE member/members:" ,"land_owned_f",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="From the ${_1_4_1_1_1} ${_1_4_1_1_calculate} of land that your household OWNS, please specify how much is owned by: A MALE member/members:" ,"land_owned_m",subindicator)) %>%
  
  # land leased
  mutate(subindicator = ifelse(label_question=="From the ${_1_4_1_1_2} ${_1_4_1_1_calculate} of land that your household LEASES from another person, please specify how much is rented by: A FEMALE member/members:" ,"land_leased_f",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="From the ${_1_4_1_1_2} ${_1_4_1_1_calculate} of land that your household LEASES from another person, please specify how much is rented by: A MALE member/members:"  ,"land_leased_m",subindicator)) %>%
  
    # land use rights
  mutate(subindicator = ifelse(label_question=="From the ${_1_4_1_1_3} ${_1_4_1_1_calculate} of land (agricultural or not) that your household HOLDS USE RIGHTS, either alone or jointly with someone else, please specify how much is held by: A FEMALE member/members:" ,"land_rights_f",subindicator)) %>%
  mutate(subindicator = ifelse(label_question== "From the ${_1_4_1_1_3} ${_1_4_1_1_calculate} of land (agricultural or not) that your household HOLDS USE RIGHTS, either alone or jointly with someone else, please specify how much is held by: A MALE member/members:", "land_rights_m",subindicator)) %>%
  
  # land area that is vulnerable
    mutate(subindicator = ifelse(label_question=="What is the total area of your land that could be affected?"  ,"land_vulnerable_area",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="Do you perceive that you could involuntarily lose ownership or use rights to any of the land (agricultural or not) you currently own or hold use rights to in the next 5 years?" ,"land_security_perceived",subindicator)) %>%
  
  # For perceived loss of land access, make sure that name_choice values are in format 5 = no risk of loss, 1 = high risk of loss
  mutate(name_choice = ifelse(subindicator=="land_security_perceived" & label_choice=="Extremely likely",1,
                ifelse(subindicator=="land_security_perceived" & label_choice == "Very likely",2,
                       ifelse(subindicator=="land_security_perceived" & label_choice == "Moderately likely",3,
                              ifelse(subindicator=="land_security_perceived" & label_choice == "Slightly likely" ,4,
                                     ifelse(subindicator=="land_security_perceived" & label_choice == "Not at all" ,5,name_choice)))))) 

# Put into wide format to align associated data
temp_kpi_calc <- d %>% filter(indicator =="land_tenure_security") %>%
  dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="name_choice") 

# Calculate indicators of interest

temp_kpi_calc <- temp_kpi_calc %>%
    mutate_at(c("land_leased_f" , "land_leased_hh"    ,   "land_leased_m" ,       "land_owned_f"     ,    "land_owned_hh"   ,  "land_owned_m"  ,       "land_rights_f",        "land_rights_hh" ,      "land_rights_m" ,  "land_vulnerable_area","land_security_perceived"), ~ifelse(is.na(.),0,as.numeric(.))) %>%
  
  mutate(land_vulnerable_share = land_vulnerable_area/(land_owned_hh+land_leased_hh + land_rights_hh)*100) %>%
  mutate(land_vulnerable_share = ifelse(land_vulnerable_share>100,100,land_vulnerable_share)) %>%
  mutate(land_owned_share = land_owned_hh/(land_owned_hh+land_leased_hh + land_rights_hh)*100) %>%
   mutate(land_owned_share = ifelse(land_owned_share>100,100,land_owned_share)) %>%
  mutate(land_security_perceived_weighted = ifelse(land_vulnerable_share>0 & !is.na(land_vulnerable_share),land_security_perceived * (land_vulnerable_share/100),land_security_perceived)) %>%
  # cap the minimum to a score of 1
  mutate(land_security_perceived_weighted = ifelse(land_security_perceived_weighted<1,1,land_security_perceived_weighted))

temp_kpi_calc <- temp_kpi_calc %>% 
  melt(id.vars=c("kobo_farmer_id","country","indicator"), measure.vars=c("land_owned_share","land_security_perceived","land_security_perceived_weighted"),variable.name="subindicator",value.name="score") 

# Add this back into the main dataset

temp_kpi_calc <- temp_kpi_calc %>%
  select(kobo_farmer_id,country,indicator,subindicator,score) %>%
  mutate(indicator = ifelse(subindicator == "land_security_perceived_weighted", "kpi17_land_tenure", indicator)) %>%
  mutate(indicator = ifelse(subindicator=="land_owned_share","kpi17b_land_tenure",indicator)) 
    
d <- d %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(subindicator_label = ifelse(indicator=="kpi17_land_tenure","Perceived land tenure security from 1 = (Extremely likely to lose access to all land) to 5 (Not at all likely to lose access to any land)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi17_land_tenure",17.1,indicator_order)) %>%
  mutate(subindicator_label = ifelse(indicator=="kpi17b_land_tenure","Share of household land that is owned (%)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi17b_land_tenure",17.2,indicator_order)) %>%
  mutate(module = ifelse(indicator %in%  c("kpi17_land_tenure", "kpi17b_land_tenure"), "performance kpi",module))
  
ggplot(d %>% filter(indicator %in% c("kpi17_land_tenure")),aes(x=score))+
  geom_histogram()  
ggplot(d %>% filter(indicator %in% c("kpi17b_land_tenure")),aes(x=score))+
  geom_histogram()  

table(d$indicator,d$module)

### Performance KPI18 human wellbeing ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="wellbeing")
#sort(unique(temp$subindicator))
#sort(unique(temp$label_question))
#sort(unique(temp$label_choice))

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "How satisfied are you with feeling part of your community?" ,"satisfaction_community",
                               ifelse(label_question == "How satisfied are you with how safe you feel?" , "satisfaction_safety",
                                      ifelse(label_question =="How satisfied are you with the amount of time you have to do the things that you like doing?","satisfaction_time",
                                             ifelse(label_question == "How satisfied are you with the quality of your local environment?", "satisfaction_environment",
                                                    ifelse(label_question == "How satisfied are you with what you are achieving in life?","satisfaction_achievements",
                                                           ifelse(label_question=="How satisfied are you with your economic security?", "satisfaction_economic",
                                                                  ifelse(label_question== "How satisfied are you with your health?","satisfaction_health",
                                                                         ifelse(label_question=="How satisfied are you with your nutritional security?","satisfaction_nutritional",
                                                                                ifelse(label_question=="How satisfied are you with your occupation?" ,"satisfaction_occupation",
                                                                                       ifelse(label_question=="How satisfied are you with your personal relationships?" ,"satisfaction_relationships",
                                                                                              ifelse(label_question=="How satisfied are you with your standard of living?","satisfaction_livingstandard",
                                                                                                     ifelse(label_question=="Thinking about your own life and personal circumstances, how satisfied are you with your life as a whole?","satisfaction_overall",subindicator))))))))))))) %>%
  mutate(score = ifelse(indicator=="wellbeing" & label_choice=="Completely satisfied.",5,
                ifelse(indicator=="wellbeing" & label_choice == "Somewhat satisfied.",4,
                       ifelse(indicator=="wellbeing" & label_choice == "Neutral",3,
                              ifelse(indicator=="wellbeing" & label_choice == "Somewhat dissatisfied.",2,
                                     ifelse(indicator=="wellbeing" & label_choice == "Completely dissatisfied.",1,score)))))) 

temp_kpi_calc <- d %>% filter(indicator=="wellbeing") %>%
  mutate(score = as.numeric(score)) %>%
  group_by(kobo_farmer_id, country, indicator) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "kpi18_human_wellbeing",
           subindicator = "wellbeing_average")

d <- d %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(subindicator_label = ifelse(indicator=="kpi18_human_wellbeing","Perceived life satisfaction from 1 (Completely dissatisfied) to 5 (Completely satisfied)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi18_human_wellbeing",18,indicator_order)) %>%
  mutate(module = ifelse(indicator == "kpi18_human_wellbeing","performance kpi",module))

ggplot(d %>% filter(indicator %in% c("kpi18_human_wellbeing")),aes(x=score))+
  geom_histogram()  

```


### Transfrom KPIs to unform 1 to 100 scale
```{r KPI scaling, include=TRUE, echo=FALSE}

#table(d$indicator)

# Make function to transform KPI scores from 0 to 100 scale
#indicators_scaled <- d[0,]
indicators_scaled <- data.frame(kobo_farmer_id=as.numeric(NA),
                      indicator=as.character(NA),
                      indicator_order=as.numeric(NA),
                      subindicator = as.character(NA), 
                      subindicator_label = as.character(NA),
                      score=as.numeric(NA),
                      score_scaled=as.numeric(NA))
indicators_scaled <- indicators_scaled[-1,]

indicator_scaling <- function(data, ind, method, min=NA,max=NA){
  data_subset <- data %>% filter(indicator %in% c(ind))
  # no scaling needed (e.g. scores in %)
  if(method =="none"){
  data_subset$score_scaled <- as.numeric(data_subset$score)
  }
  # scaling based on min and max values recorded in they survey
  if(method =="data_driven"){
  ind_min <- min(as.numeric(data_subset$score),na.rm=TRUE)
  ind_max <- max(as.numeric(data_subset$score),na.rm=TRUE)
  data_subset$score_scaled <- (data_subset$score - ind_min)/(ind_max - ind_min)*100
  }
  # scaling based on ore-defined min and max values 
  if(method =="set"){
  ind_min <- as.numeric(min)
  ind_max <- as.numeric(max)
  data_subset$score_scaled <- (data_subset$score - ind_min)/(ind_max - ind_min)*100
  }
  data_subset <- data_subset %>% select(c("kobo_farmer_id","indicator","indicator_order","subindicator","subindicator_label", "score", "score_scaled"))
  indicators_scaled <- indicators_scaled %>% rbind(data_subset)
  assign("indicators_scaled",indicators_scaled,envir = globalenv())
  rm(data, ind, method, min,max)
}

indicator_scaling(data = d, ind="kpi1_crop_health",method="none")
indicator_scaling(data = d, ind="kpi2_animal_health", method="set", min=1,max=5)
indicator_scaling(data = d, ind="kpi3_soil_health",method="set",min=1,max=5)
indicator_scaling(data = d, ind="kpi4_nutrient_use", method="data_driven")
indicator_scaling(data = d, ind="kpi16_farmer_agency", method="set",min=1,max=5)
indicator_scaling(data = d, ind="kpi17_land_tenure", method="set",min=1,max=5)
indicator_scaling(data = d, ind="kpi17b_land_tenure", method="none")
indicator_scaling(data = d, ind="kpi18_human_wellbeing", method="set",min=1, max=5)

indicators_scaled <- indicators_scaled %>%
  mutate(theme_short = ifelse(indicator %in% c("kpi1_crop_health","kpi2_animal_health","kpi3_soil_health","kpi4_nutrient_use"),"AGR",
                        ifelse(indicator %in% (c("kpi16_farmer_agency","kpi17_land_tenure","kpi17b_land_tenure","kpi18_human_wellbeing")),"SOC","CHECK"))) %>%
  mutate(indicator = factor(indicator, levels=unique(indicator)[order(indicator_order,theme_short)]))

# Add scaled scores to main dataset
d <- d %>% left_join(indicators_scaled)

d <- d %>% mutate(score_scaled = ifelse(module=="agroecology",score,score_scaled))

```


## Extract context indicators of interest 

HOLPA collects data on multiple context, agroecology, and performance themes. For the context module, there are several indicators per theme and several measurements per indicator. We need to separate and name the indicators and measurements to include them into the analysis.

```{r context variables, include=TRUE, echo=FALSE}

# ERRORS:
#temp <- temp %>% filter(kobo_farmer_id == 274186917) # MISSING from context (no district information)
# 	name_question == _4_1_1_6_1 is wrongly assigned to context section

#### Location ####
#temp <- d[d$indicator =="location",] 
#sort(unique(temp[temp$subindicator=="District",]$name_choice))
d <- d %>% 
  mutate(subindicator = ifelse(label_question == "Please specify the COUNTRY","Country",subindicator),
         subindicator = ifelse(label_question == "Please specify the LOCALITY or DISTRICT","District",subindicator),
         subindicator = ifelse(label_question == "Please specify the VILLAGE","Village",subindicator),
         subindicator = ifelse(label_question == "Please specify the GPS point","GPS",subindicator)) %>%
  # create dummy variable to allow district to be added to factor analysis
  mutate(score = ifelse(subindicator=="District" & name_choice == "mbire",1,
                        ifelse(subindicator=="District" & name_choice == "murehwa",2,
                               ifelse(subindicator=="District" & !(name_choice %in% c("mbire", "murehwa")),NA,score))))

#### Access to markets and more ####
# This is a select one question - sort if using
#temp <- d[d$indicator =="accessibility",] 
#sort(unique(temp$label_question))

#### Age community ####
#temp <- d[d$indicator =="age_community",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "For how many years have you lived in this community?","Time_in_community",subindicator)) %>%
  mutate(score = ifelse(subindicator=="Time_in_community",as.numeric(name_choice),score))

#### Age DOB ####
#temp <- d[d$indicator =="age_dob",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Year of birth","Age_years",subindicator)) %>%
  mutate(score = ifelse(subindicator=="Age_years",as.numeric(name_choice),score))

#### Agroecology understanding ####
#temp <- d_cn[d_cn$indicator =="agroecology_knowledge",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Do you know what Agroecology means?","Ae_understanding",subindicator)) %>%
  mutate(subindicator_label = ifelse(name_choice=="0" & subindicator == "Ae_understanding","No",
                                     ifelse(name_choice=="1" & subindicator == "Ae_understanding","Some",
                                            ifelse(name_choice=="2" & subindicator == "Ae_understanding","Yes",subindicator_label)))) %>%
    mutate(score = ifelse(subindicator=="Ae_understanding",as.numeric(name_choice), score)) 

#### Insurance against losses ####
#temp <- d[d$indicator =="climate_resilience",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Do you have insurance against agricultural losses?","Insurance_ag_losses",subindicator)) %>%
  mutate(subindicator= ifelse(label_question=="What is covered, e.g. losses to crops/livestock/buildings from weather events, pest outbreaks, market shocks?","Insurance_ag_losses_detail",subindicator)) %>%
  mutate(subindicator_label = ifelse(name_choice=="0" & subindicator == "Insurance_ag_losses","No",
                                     ifelse(name_choice=="1" & subindicator == "Insurance_ag_losses","Some",
                                            ifelse(name_choice=="2" & subindicator == "Insurance_ag_losses","Yes",label_choice_short)))) %>%
    mutate(score = ifelse(subindicator=="Insurance_ag_losses",as.numeric(name_choice),score))
           
#### CONTINUE HERE to sort context variables as needed ####
# credit_access
# education
# literacy
# gender
# household_labour
# income (this is a performance indicator too)
# training
# membership
# personal_factors
# societal_factor
# climate_rainfall_change
# climate_temp

# USE THIS pattern:
#sort(unique(d$indicator))
#temp <- d[d$indicator =="climate_resilience",] 
#table(temp$label_choice,temp$subindicator)
#table(temp$label_choice,temp$name_choice)
#table(temp$label_choice,temp$label_choice_short)

#### Attach key context variables to rest of data in wide format ####

d_cn_wide <- d %>%
  filter(module=="context") %>%
  select(c("kobo_farmer_id", "subindicator","score")) %>%
  filter(subindicator %in% c("District","Age_years","Time_in_community","Ae_understanding", "Insurance_ag_losses"))  %>% 
  pivot_wider(names_from=c(subindicator),
              values_from=c(score),
              #values_from=c(name_choice), # OR use score here if everything needs to be numeric
              names_sort=TRUE,
              #names_glue="{subindicator}_{.value}",
              names_vary = "slowest")

d_wide <- d %>% filter(!(module=="context")) %>%
  left_join(d_cn_wide,by="kobo_farmer_id",relationship="many-to-many") 

d_wide <- d_wide %>% mutate(indicator = factor(indicator,levels=unique(indicator[order(indicator_order)])))

# Save data for re-use in next script
write.csv(d,paste0(zwe.data.path,"zwe_indicators.csv"),row.names=FALSE)
write.csv(d_wide,paste0(zwe.data.path,"zwe_indicators_wide.csv"),row.names=FALSE)

```

