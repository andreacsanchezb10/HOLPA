---
title: "HOLPA farm-household data analysis"
output:
  html_document: default
  pdf_document: default
date: "2024-04-18"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr) # for piping
library(tidyverse) #for formatting data
library(ggplot2) # for plots
library(readr)
library(reshape2)

global.data.path <- "C:/Users/sjones/OneDrive - CGIAR/Documents/HOLPA/"
zwe.data.path <- "C:/Users/sjones/OneDrive - CGIAR/Documents/HOLPA/"
#data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/"

zwe_ae <- read_csv("zwe/zwe_agroecology_format.csv",show_col_types = FALSE)
zwe_cn <- read_csv("zwe/zwe_context_format.csv",show_col_types = FALSE)
zwe_pf <- read_csv("zwe/zwe_performance_format.csv",show_col_types = FALSE)

zwe_data <- zwe_ae %>% full_join(zwe_cn) %>% full_join(zwe_pf)

zwe_ae_scores <- read_csv("zwe/zwe_agroecology_score.csv",show_col_types = FALSE)

zwe_data <- zwe_data %>% left_join(zwe_ae_scores) %>% unique()



```
## Calculate agroecology indicator scores
Indicator scores are pre-calculated in another code (which needs transferring to here).

```{r agroecology indicator calcs, include=TRUE, echo=FALSE}
#### Overall agroecology score ####
d <- zwe_data

d <- d %>%
  mutate(subindicator = label_question) %>%
  mutate(subindicator_label = NA) %>%
  mutate(score = ifelse(score_agroecology_module=="no_answer",NA,score_agroecology_module)) %>%
  mutate(score = as.numeric(score)) %>% 
  mutate(score_label = label_score_agroecology_module) %>%
  mutate(indicator_order = ifelse(module=="agroecology",sub('_.*', "", indicator),NA)) %>%
  mutate(indicator_order = as.numeric(indicator_order))

d_ae_summary <- d %>%
  filter(module == "agroecology") %>%
  group_by(kobo_farmer_id,module) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "score_ae_overall",
         indicator_order=14)

d <- d %>% full_join(d_ae_summary) 

#d <- d %>% 
#  mutate(score = ifelse(module != "agroecology" & type %in% #c("integer","decimal"),as.numeric(name_choice),score)) 

```
## Calculate Key Performance Indicator scores
Indicator scores need to be calculated from survey responses.

```{r KPI calcs, include=TRUE, echo=FALSE}

#### Performance KPI1 crop health ####
sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="crop_health")
#table(temp$label_question)
#table(temp$name_question)
#table(temp$label_question,temp$name_question)

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "What percentage of the total crop production was lost or damaged in the last 12 months [add country meaning]","crop_loss",
                               ifelse(label_question=="What was the main cause of crop loss or damage?","crop_loss_cause",subindicator))) %>%
  #mutate(subindicator = ifelse(name_question =="_3_4_2_1_8_2","crop_loss",
  #                             ifelse(name_question == "_3_4_2_1_8_3","crop_loss_cause",subindicator))) %>%
  mutate(subindicator_label = ifelse(subindicator=="crop_loss","Total crop production lost or damaged in last 12 months (%)",subindicator_label)) %>%
  mutate(indicator = ifelse(subindicator=="crop_loss","kpi1_crop_health",indicator),
         indicator_order = ifelse(indicator =="kpi1_crop_health",1,indicator_order))

# Remove out of bounds responses
d <- d %>% mutate(score = ifelse(indicator =="kpi1_crop_health",as.numeric(name_choice),score)) %>% mutate(score = ifelse(score>100,NA,score))

ggplot(d %>% filter(indicator=="kpi1_crop_health"),aes(x=country,y=score))+
  geom_boxplot()

### Performance KPI2 animal health ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="animal_health")
#table(temp$label_question)
#table(temp$name_choice)
#table(temp$label_choice)
#table(temp$name_question,temp$label_question)

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "What was the extent of injury, illness or death of livestock due to diseases in the last 12 months","livestock_loss",
                               ifelse(label_question=="Over the past 12 months [add country meaning], how did you manage livestock diseases","livestock_disease_management",subindicator))) %>%
  #mutate(subindicator = ifelse(name_question %in% c( "_1_4_3_8/1","_1_4_3_8/2","_1_4_3_8/3","_1_4_3_8/4","_1_4_3_8/5","_1_4_3_8/6","_1_4_3_8/7","_1_4_3_8/8"),"livestock_loss", ifelse(name_question %in% c("_1_4_3_8/1","_1_4_3_8/2","_1_4_3_8/3","_1_4_3_8/4","_1_4_3_8/5","_1_4_3_8/6","_1_4_3_8/7","_1_4_3_8/8"),"livestock_disease_management",subindicator))) %>%
    mutate(subindicator_label = ifelse(subindicator=="livestock_loss","Extent of livestock injury, illness or death due to diseases in last 12 months (score 1-5)",subindicator_label)) %>%
  mutate(score = ifelse(subindicator =="livestock_loss" & label_choice=="None",5,
                        ifelse(subindicator =="livestock_loss" & label_choice=="Low",3.66,
                               ifelse(subindicator =="livestock_loss" & label_choice=="Medium",2.33,
                                      ifelse(subindicator =="livestock_loss" & label_choice=="High",1,score))))) %>%
  
  mutate(score_label = ifelse(subindicator =="livestock_loss" & label_choice=="None","No livestock injury, illness or death",
                        ifelse(subindicator =="livestock_loss" & label_choice=="Low","Low level of livestock injury, illness or death",
                               ifelse(subindicator =="livestock_loss" & label_choice=="Medium","Medium level of livestock injury, illness or death",
                                      ifelse(subindicator =="livestock_loss" & label_choice=="High","High level of livestock injury, illness or death",score_label))))) %>%
  
  mutate(indicator = ifelse(subindicator=="livestock_loss","kpi2_animal_health",indicator),
         indicator_order = ifelse(subindicator =="livestock_loss",2,indicator_order)) 


ggplot(d %>% filter(indicator=="kpi2_animal_health"),aes(x=country,y=score))+
  geom_boxplot()

### Performance KPI3 soil health ####
#temp <- d %>% filter(indicator =="soil_health")
#table(temp$label_question)
#table(temp$subindicator)
#table(temp$name_choice,temp$label_question)
#table(temp$label_choice,temp$name_choice)
#table(temp$label_choice_short,temp$name_choice)
#table(temp$label_choice_short,temp$score)

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "How would you describe the fertility of your soil on your farmland?","soil_fertility",
                               ifelse(label_question=="How would you describe the level of soil erosion problem on your farmland?","soil_erosion",subindicator))) %>%
  
  # NOTE that soil erosion label_choice is the 'wrong' way around, i.e. lower scores are better         
  mutate(score = ifelse(subindicator=="soil_erosion" & name_choice=="0",5,
                        ifelse(subindicator=="soil_erosion" & name_choice=="1",3,
                               ifelse(subindicator=="soil_erosion" & name_choice=="2",1,score)))) %>%
  
  # soil fertility
  mutate(score = ifelse(subindicator=="soil_fertility" & name_choice=="0",1,
                        ifelse(subindicator=="soil_fertility" & name_choice=="1",2.33,
                               ifelse(subindicator=="soil_fertility" & name_choice=="2",3.66,
                                      ifelse(subindicator=="soil_fertility" & name_choice=="3",5,score)))))

# combine soil erosion and fertility scores
temp_kpi_calc <- d %>% filter(subindicator %in% c("soil_erosion","soil_fertility")) %>%
  mutate(score = as.numeric(score)) %>%
  group_by(kobo_farmer_id, country, module) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "soil_health",
         subindicator = "soil_health_overall")

d <- d %>% full_join(temp_kpi_calc) %>%
  mutate(indicator = ifelse(subindicator=="soil_health_overall","kpi3_soil_health",indicator),
         subindicator_label = ifelse(subindicator=="kpi3_soil_health","Perceived soil erosion and fertility from 1 (infertile and major soil erosion) to 3 (highly fertile with no soil erosion)",subindicator_label),
         indicator_order = ifelse(indicator =="kpi3_soil_health",3,indicator_order))

ggplot(d %>% filter(indicator %in% c("kpi3_soil_health")),aes(x=indicator,y=score))+
  geom_violin()


### Performance KPI4 nutrient use ####
sort(unique(d$indicator))
temp <- d %>% filter(indicator =="nutrient_use")
sort(unique(temp$subindicator))
table(temp$label_question)
table(temp$subindicator)
table(temp$name_choice,temp$label_question)
table(temp$label_choice,temp$name_choice)
table(temp$name_question,temp$label_question)

area_unit <- d %>% filter(indicator =="nutrient_use") %>% filter(label_question =="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}") %>% select(label_choice) %>% unique()

area_unit <- area_unit$label_choice

d <- d %>% 
  # chemical fertilizers
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify applied unit:","nut_chem_unit",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the amount applied","nut_chem_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}","nut_chem_area",subindicator)) %>%
  
  # organic fertilisers generated on-farm
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify applied unit:" ,"nut_orgF_unit",subindicator))  %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify the amount applied:","nut_orgF_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}" , "nut_orgF_area",subindicator)) %>%
  
  # organic fertilizers from other sources
    mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify applied unit:","nut_org_unit",subindicator))  %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify the amount applied" ,"nut_org_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}","nut_org_area",subindicator)) 

# Put into wide format to align associated data
temp_kpi_calc <- d %>% filter(indicator =="nutrient_use") %>%
  dcast(kobo_farmer_id+country+sheet_id+index+module+theme+indicator ~subindicator,value.var="name_choice") 

# check which units are present
sort(unique(temp_kpi_calc$nut_chem_unit)) 
sort(unique(temp_kpi_calc$nut_org_unit)) 
sort(unique(temp_kpi_calc$nut_orgF_unit)) 

# To convert L/ha to kg/ha, set Specific Gravity value
nut_conversion_l_to_kg <- 1.23 #https://icl-growingsolutions.com/en-gb/turf-landscape/knowledge-hub/nutrient-calculations/ 

# Calculate nutrient use per unit area
temp_kpi_calc <- temp_kpi_calc %>%
    mutate_at(c("nut_chem_quantity","nut_chem_area",
              "nut_org_quantity","nut_org_area",
              "nut_orgF_quantity","nut_orgF_area"), ~ifelse(is.na(.),0,as.numeric(.))) %>%
  
  # kilograms
  mutate(nut_chem_kg_area = ifelse(nut_chem_quantity>0 & nut_chem_unit =="Kilograms", nut_chem_quantity/nut_chem_area, 0),
         nut_org_kg_area = ifelse(nut_org_quantity>0 & nut_org_unit =="Kilograms", nut_org_quantity/nut_org_area, 0),
         nut_orgF_kg_area = ifelse(nut_orgF_quantity>0 & nut_orgF_unit =="Kilograms", nut_orgF_quantity/nut_orgF_area, 0)) %>%
  
    # litres
  mutate(nut_chem_lt_area_converted = ifelse(nut_chem_quantity>0 & nut_chem_unit =="Liters", nut_chem_quantity/nut_chem_area* nut_conversion_l_to_kg, 0)) %>%
  
  # Total amounts
  mutate(nut_quantity_kg_ha = nut_chem_kg_area + nut_chem_lt_area_converted + nut_org_kg_area + nut_orgF_kg_area) %>%
  mutate(nut_quantity_kg_ha = ifelse(area_unit =="in acres", nut_quantity_kg_ha * 0.404686,nut_quantity_kg_ha)) 

temp_kpi_calc <- temp_kpi_calc %>% mutate(subindicator = "nutrient_use", 
                                          score = nut_quantity_kg_ha)

# Add this back into the main dataset
d <- d %>% full_join(
  temp_kpi_calc %>%
  select(kobo_farmer_id,country,sheet_id,index,module,theme,indicator,subindicator,score)
)

d <- d %>%
    mutate(indicator = ifelse(subindicator=="nutrient_use","kpi4_nutrient_use",indicator),
         subindicator_label = ifelse(subindicator=="kpi4_nutrient_use","Fertilizer use (kg/ha)",subindicator_label),
         indicator_order = ifelse(indicator =="kpi4_nutrient_use",4,indicator_order))

```

### Transfrom KPIs to unform 1 to 100 scale
```{r KPI scaling, include=TRUE, echo=FALSE}
data = d
ind="kpi4_nutrient_use"
method="data_driven"

indicator_scaling <- function(data, ind, method, min,max){
  data_subset <- data %>% filter(indicator %in% c(ind))
  if(method =="none"){
  data_subset$score_scaled <- (data_subset$score)
  }
  if(method =="data_driven"){
  ind_min <- min(data_subset$score,na.rm=TRUE)
  ind_max <- max(data_subset$score,na.rm=TRUE)
  data_subset$score_scaled <- (data_subset$score - ind_min)/(ind_max - ind_min)*100
  }
  if(method =="set"){
  ind_min <- min
  ind_max <- max
  data_subset$score_scaled <- (data_subset$score - ind_min)/(ind_max - ind_min)*100
  }
  data <- data %>%left_join(data_subset)
}

test <- indicator_scaling(data = d, ind="kpi1_crop_health",method="none")
test <- indicator_scaling(data = d, ind="kpi2_animal_health",method="none")
test <- indicator_scaling(data = d, ind="kpi3_soil_health",method="set",min=1,max=5)
test <- indicator_scaling(data = d, ind="kpi4_nutrient_use",method="data_driven")

ggplot(d %>% filter(indicator %in% c("kpi1_crop_health" , "kpi2_animal_health", "kpi3_soil_health" )),
       aes(x=indicator,y=score_scaled))+
  geom_violin()
```

## Extract context indicators of interest 

HOLPA collects data on multiple context, agroecology, and performance themes. For the context module, there are several indicators per theme and several measurements per indicator. We need to separate and name the indicators and measurements to include them into the analysis.

```{r context variables, include=TRUE, echo=FALSE}

# ERRORS:
#temp <- temp %>% filter(kobo_farmer_id == 274186917) # MISSING from context (no district information)
# 	name_question == _4_1_1_6_1 is wrongly assigned to context section

#### Location ####
#temp <- d[d$indicator =="location",] 
#sort(unique(temp[temp$subindicator=="District",]$name_choice))
d <- d %>% 
  mutate(subindicator = ifelse(label_question == "Please specify the COUNTRY","Country",subindicator),
         subindicator = ifelse(label_question == "Please specify the LOCALITY or DISTRICT","District",subindicator),
         subindicator = ifelse(label_question == "Please specify the VILLAGE","Village",subindicator),
         subindicator = ifelse(label_question == "Please specify the GPS point","GPS",subindicator)) %>%
  # create dummy variable to allow district to be added to factor analysis
  mutate(score = ifelse(subindicator=="District" & name_choice == "mbire",1,
                        ifelse(subindicator=="District" & name_choice == "murehwa",2,
                               ifelse(subindicator=="District" & !(name_choice %in% c("mbire", "murehwa")),NA,score))))

#### Access to markets and more ####
# This is a select one question - sort if using
#temp <- d[d$indicator =="accessibility",] 
#sort(unique(temp$label_question))

#### Age community ####
#temp <- d[d$indicator =="age_community",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "For how many years have you lived in this community?","Time_in_community",subindicator))

#### Age DOB ####
#temp <- d[d$indicator =="age_dob",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Year of birth","Age_years",subindicator))

#### Agroecology understanding ####
#temp <- d_cn[d_cn$indicator =="agroecology_knowledge",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Do you know what Agroecology means?","Ae_understanding",subindicator)) %>%
  mutate(label_choice_short = ifelse(name_choice=="0" & subindicator == "Ae_understanding","No",
                                     ifelse(name_choice=="1" & subindicator == "Ae_understanding","Some",
                                            ifelse(name_choice=="2" & subindicator == "Ae_understanding","Yes",label_choice_short)))) %>%
    mutate(score = ifelse(subindicator=="Ae_understanding",as.numeric(name_choice),score)) 

#### Insurance against losses ####
#temp <- d[d$indicator =="climate_resilience",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Do you have insurance against agricultural losses?","Insurance_ag_losses",subindicator)) %>%
  mutate(subindicator= ifelse(label_question=="What is covered, e.g. losses to crops/livestock/buildings from weather events, pest outbreaks, market shocks?","Insurance_ag_losses_detail",subindicator)) %>%
  mutate(label_choice_short = ifelse(name_choice=="0" & subindicator == "Insurance_ag_losses","No",
                                     ifelse(name_choice=="1" & subindicator == "Insurance_ag_losses","Some",
                                            ifelse(name_choice=="2" & subindicator == "Insurance_ag_losses","Yes",label_choice_short)))) %>%
    mutate(score = ifelse(subindicator=="Insurance_ag_losses",as.numeric(name_choice),score))
           
#### CONTINUE HERE to sort context variables as needed ####
# credit_access
# education
# literacy
# gender
# household_labour
# income (this is a performance indicator too)
# training
# membership
# personal_factors
# societal_factor
# climate_rainfall_change
# climate_temp
# USE THIS pattern:
#sort(unique(d$indicator))
#temp <- d[d$indicator =="climate_resilience",] 
#table(temp$label_choice,temp$subindicator)
#table(temp$label_choice,temp$name_choice)
#table(temp$label_choice,temp$label_choice_short)

#### Attach key context variables to rest of data in wide format ####

d_cn_wide <- d %>%
  filter(module=="context") %>%
  select(c("kobo_farmer_id", "subindicator","name_choice")) %>%
  filter(subindicator %in% c("District","Age_years","Time_in_community","Ae_understanding", "Insurance_ag_losses"))  %>% 
  pivot_wider(names_from=c(subindicator),
              values_from=c(name_choice), # OR use score here if everything needs to be numeric
              names_sort=TRUE,
              #names_glue="{subindicator}_{.value}",
              names_vary = "slowest")

d_wide <- d %>% filter(!(module=="context")) %>% left_join(d_cn_wide,by="kobo_farmer_id",relationship="many-to-many") 

d <- d %>% mutate(indicator = factor(indicator,levels=unique(indicator[order(indicator_order)])))
levels(d_wide$indicator)
d_wide <- d_wide %>% mutate(indicator = factor(indicator,levels=unique(indicator[order(indicator_order)])))

```

## Agroecology adherence of farm-households

Agroecology adherence assessed using Likert scale responses from 1 (low adherence) to 5 (high adherence).

```{r basic figures, include=TRUE, echo=FALSE}

ggplot(d_wide %>% filter(module=="agroecology", !(indicator %in% c("extra_economic_diversification/economic","extra_participation"))), aes(x=indicator,y=score,fill=indicator))+
  geom_boxplot()+
  ggtitle(paste0("Agroecology adherence across n= ",length(unique(d_wide$kobo_farmer_id))," farm-households"))+
  labs(x="",y="Score\n(1 = low adherence, 5 = high adherence)")+
  #geom_violin()+
  scale_fill_viridis_d()+
  facet_wrap(~District,ncol=1)+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90,hjust=1),
        plot.title=element_text(hjust=0.5))


```


