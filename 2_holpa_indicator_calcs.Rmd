---
title: "HOLPA farm-household indicator calculation"
output:
  word_document: default
  pdf_document: default
  html_document: default
date: "2024-04-18"
editor_options:
  chunk_output_type: console
---
## Specify settings to use for data analysis

In this section, the user needs to specify which country to analyse, where the cleaned HOLPA survey data are stored on their computer, and any country/landscape specific conversion parameters. This is the only section of the script that needs user input. Subsequent code chunks can be run without making changes.

```{r set user parameters, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr) # for piping
library(tidyverse) #for formatting data
library(ggplot2) # for plots
library(readr) 
library(reshape2) # for changing data layout
library(stringr) # for wrapping text
library(readxl) # for reading and writing excel files
library(ggsci) # ggplot colours for scientific journals
library(ggforce) # for gauge plots

### Set parameters ####

# Specify country being processed (specify ONE only. You will need to rerun the code to process each country)

country <- "burkina"
#country <- "india"
#country <- "laos"
#country <- "kenya"
#country <- "peru"
#country <- "senegal" # formatted fieldwork csv needs saving to folder
#country <- "tunisia"
#country <- "zimbabwe"

# for area unit conversions
acre_to_hectare = 0.404686

# replace these file paths with the location where your data are saved:

ref.values.data.path <- "C:/Users/sjones/CGIAR/One CGIAR - Agroecology Initiative Implementation Team - Documents/WP2 Coordination/Task2_Framework/HOLPA implementation/HOLPA_data_use/"

fw_survey_mapping <- read_excel("C:/Users/sjones/CGIAR/One CGIAR - Agroecology Initiative Implementation Team - Documents/WP2 Coordination/Task2_Framework/HOLPA implementation/HOLPA_master/HOLPA_global_field_survey_20231106_mapped_to_indicators.xlsx",sheet="survey")
fw_choices_mapping <- read_excel("C:/Users/sjones/CGIAR/One CGIAR - Agroecology Initiative Implementation Team - Documents/WP2 Coordination/Task2_Framework/HOLPA implementation/HOLPA_master/HOLPA_global_field_survey_20231106_mapped_to_indicators.xlsx",sheet="choices")

global.data.path <- "C:/Users/sjones/OneDrive - CGIAR/Documents/HOLPA/"

bfa.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Burkina_Faso/burkina_faso_data_clean/bfa/"
ind.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/India/india_data_clean/ind/"
ken.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Kenya/kenya_data_clean/ken/"
lao.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Laos/laos_data_clean/lao/"
per.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Peru/peru_data_clean/per/"
sen.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Senegal/senegal_data_clean/sen/"
tun.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Tunisia/tunisia_data_clean/tun/"
zwe.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Zimbabwe/zimbabwe_data_clean/zwe/"

```

## Import data

Run this chunk to import the relevant HOLPA datasets.

```{r import data,include=FALSE}

#### Import data ####

# reference values for kpi climate mitigation: practice net GHG contributions
ref_values_cc <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet="kpi_CC_mitigation")

# reference values for kpi nutrient use: fertilizer unit conversions
ref_values_nut <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet="kpi_nutrient_conversion")

# function to import cleaned data


#country_short = "bfa"
#country.data.path = bfa.data.path

import.data <- function(country_short,country.data.path){
  cn <- read_csv(paste0(country.data.path,country_short,"_context_format.csv"),show_col_types = FALSE)
  ae <- read_csv(paste0(country.data.path,country_short,"_agroecology_format.csv"),show_col_types = FALSE)
  ae_scores <- read_csv(paste0(country.data.path,country_short,"_agroecology_score.csv"),show_col_types = FALSE)
  pf <- read_csv(paste0(country.data.path,country_short,"_performance_format.csv"),show_col_types = FALSE)
  fw <- read_csv(paste0(country.data.path,country_short,"_fieldwork_format.csv"),show_col_types = FALSE)

# reshape and classify fieldwork data to enable join with household
# (!!! fieldwork indicator extraction work in progress - not finished !!!)
  if(!(c("country") %in% colnames(fw))){
    fw <- fw %>% mutate(country = country)
    fw <- melt(fw,id.vars=c("kobo_farmer_id","country"),variable.name="name_question",value.name="name_choice")
  } else{
  fw <- melt(fw[,c(1,2,33:length(fw))],id.vars=c("kobo_farmer_id","country"),variable.name="name_question",value.name="name_choice")}
  
fw <- fw %>% left_join(fw_survey_mapping %>%
                             select(-c("hint::English ((en))" , "appearance",
                                       "relevant" , "constraint" , "choice_filter",
                                       "calculation", "repeat_count",   
                                       "media::image::English ((en))","required")) %>% rename(label_question  = "label::English ((en))"), by=c("name_question"="name_survey"))  %>%
    left_join(fw_choices_mapping %>%
                rename(label_choice  = "label::English ((en))") %>%
                select(c("name_survey" ,"name_choice","label_choice")),
              by=c("name_question"="name_survey","name_choice"="name_choice")) %>%
    filter(!is.na(module)) %>%
  filter(!(subindicator %in% c("respondent_first_name","respondent_last_name"))) %>%
  select(kobo_farmer_id,country,module,theme,indicator,subindicator, fw_site,name_question,label_question, name_choice,label_choice, type) %>% unique()

  image_list <- fw %>% filter(type=="image") %>%
    select(kobo_farmer_id,country,fw_site,name_question,label_question, name_choice)  %>% unique()
  
  country_data <- ae %>% full_join(cn) %>% full_join(pf)  %>% 
    full_join(fw %>% select(-fw_site) %>% unique()) %>%
  full_join(ae_scores) %>% unique() %>% 
    mutate(across(where(is.character),str_trim)) %>% 
    mutate(across(where(is.numeric),str_trim))
  
  assign(paste0(country_short,"_data"),country_data,envir=.GlobalEnv)
  assign(paste0(country_short,"_ae_scores"),ae_scores,envir=.GlobalEnv)
  assign(paste0(country_short,"_cn"),cn,envir=.GlobalEnv)
  assign(paste0(country_short,"_fw"),fw,envir=.GlobalEnv)
  
  if(country == "burkina"){
    write.csv(fw,paste0(bfa.data.path,"bfa_fieldwork_scores.csv"),row.names=FALSE)
    write.csv(image_list,paste0(bfa.data.path,"bfa_fieldwork_photo_list.csv"),row.names=FALSE)}
  
  if(country=="india"){
    write.csv(fw,paste0(ind.data.path,"ind_fieldwork_scores.csv"),row.names=FALSE)
    write.csv(image_list,paste0(ind.data.path,"ind_fieldwork_photo_list.csv"),row.names=FALSE)}
  
  if(country=="laos"){
  write.csv(fw,paste0(lao.data.path,"lao_fieldwork_scores.csv"),row.names=FALSE)
  write.csv(image_list,paste0(lao.data.path,"lao_fieldwork_photo_list.csv"),row.names=FALSE)}
  
  if(country=="kenya"){
    write.csv(fw,paste0(ken.data.path,"ken_fieldwork_scores.csv"),row.names=FALSE)
    write.csv(image_list,paste0(ken.data.path,"ken_fieldwork_photo_list.csv"),row.names=FALSE)}
  
  if(country=="peru"){
  write.csv(fw,paste0(per.data.path,"per_fieldwork_scores.csv"),row.names=FALSE)
  write.csv(image_list,paste0(per.data.path,"per_fieldwork_photo_list.csv"),row.names=FALSE)}
  
  if(country=="senegal"){
  write.csv(fw,paste0(sen.data.path,"sen_fieldwork_scores.csv"),row.names=FALSE)
  write.csv(image_list,paste0(sen.data.path,"sen_fieldwork_photo_list.csv"),row.names=FALSE)}
  
  if(country=="tunisia"){
  write.csv(fw,paste0(tun.data.path,"tun_fieldwork_scores.csv"),row.names=FALSE)
  write.csv(image_list,paste0(tun.data.path,"tun_fieldwork_photo_list.csv"),row.names=FALSE)}
  
  if(country == "zimbabwe"){
  write.csv(kpi_scores_final,paste0(zwe.data.path,"zwe_fieldwork_scores.csv"),row.names=FALSE)
  write.csv(image_list,paste0(zwe.data.path,"zwe_fieldwork_photo_list.csv"),row.names=FALSE)}
}

set_d <- function(country){
  if(country == "burkina"){
  import.data("bfa",bfa.data.path)
  d <- bfa_data
  ref_values_country <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet=paste0("BFA","_inputs"))
  iso <- "BFA"
  
  } 
  if(country=="india"){
    import.data("ind",ind.data.path)
    d <- ind_data
    ref_values_country <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet=paste0("IND","_inputs"))
    iso <- "IND"
  }
  if(country=="laos"){
      import.data("lao",lao.data.path)
      d <- lao_data
      ref_values_country <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet=paste0("LAO","_inputs"))
      iso <- "LAO"
  }
  if(country=="kenya"){
    import.data("ken",ken.data.path)
    d <- ken_data
    ref_values_country <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet=paste0("KEN","_inputs"))
    iso <- "KEN"
      }
  if(country=="peru"){
    import.data("per",per.data.path)
    d <- per_data
    ref_values_country <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet=paste0("PER","_inputs"))
    iso <- "PER"
  }
  if(country=="senegal"){
    import.data("sen",sen.data.path)
    d <- sen_data
    ref_values_country <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet=paste0("SEN","_inputs"))
    iso <- "SEN"
  }
  if(country=="tunisia"){
    import.data("tun",tun.data.path)
    d <- tun_data
    ref_values_country <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet=paste0("TUN","_inputs"))
    iso <- "TUN"
  }
  if(country == "zimbabwe"){
    import.data("zwe",zwe.data.path)
    d <- zwe_data
    ref_values_country <- read_excel(paste0(ref.values.data.path,"HOLPA data post-processing.xlsx"),sheet=paste0("ZWE","_inputs"))
    iso <- "ZWE"
  }
  assign("d",d,envir=.GlobalEnv)
  assign("ref_values_country",ref_values_country,envir=.GlobalEnv)
  assign("iso",iso,envir=.GlobalEnv)
}

set_d(country)

d <- d %>%
  mutate(module = ifelse(indicator %in% c("extra_economic_diversification/economic","extra_participation"), "performance", module)) %>%
  mutate(subindicator = ifelse(is.na(subindicator),indicator,subindicator)) %>%
  mutate(subindicator_label = "") %>%
  mutate(score = ifelse(score_agroecology_module=="no_answer",NA,score_agroecology_module)) %>%
  mutate(score = as.numeric(score)) %>% 
  mutate(score_label = label_score_agroecology_module) %>%
  mutate(indicator_order = ifelse(module=="agroecology",sub('_.*', "", indicator),NA)) %>%
  mutate(indicator_order = as.numeric(indicator_order)) %>%
  select(-c(label_score_agroecology_module, score_agroecology_module))

```

## Make functions to make plots for rapid viewing of data as code runs
```{r plot functions, include=FALSE, echo=FALSE}

col.theme <- c("agricultural"="#305127", "environmental"= "#699E5C", "social" = "#511F47" , "economic"= "#B36971")

#data <- d
#kpi <- "kpi1_crop_health"
kpi_histogram <- function(data, kpi){
  
  subindicator_label <- data %>% filter(indicator %in% c(kpi)) %>% select(subindicator_label) %>% unique()
  subindicator_label <- subindicator_label[1,1]
  
  g <- ggplot(data %>% filter(indicator %in% c(kpi) & !is.na(score)),aes(x=score))+
    geom_histogram()+ 
    coord_cartesian(expand=c(0))+
    ggtitle(paste0(subindicator_label, " in ",country))+ labs(x="")+
    theme_classic()+ theme(plot.title = element_text(hjust=0.5))
  print(g)
}

kpi_all_histogram <- function(data){
   data <- data %>%
    mutate(subindicator_label = factor(subindicator_label,levels=unique(subindicator_label[order(indicator_order)]))) %>%
     mutate(kpi_label= paste0(gsub("(.+?)(\\_.*)","\\1", indicator),": ",subindicator_label)) %>%
     mutate(kpi_label = factor(kpi_label, levels=unique(kpi_label[order(indicator_order)])))
     
  g <- ggplot(data %>% filter(module %in% c("performance kpi") & !is.na(score)), aes(x=score))+  
  ggtitle(paste0("KPIs for ",country," (n = ",length(unique(data$kobo_farmer_id)), ")"))+labs(x="")+
  geom_histogram()+ coord_cartesian(expand=c(0))+
      facet_wrap(~kpi_label, labeller=labeller(kpi_label = label_wrap_gen(40)), scale="free",strip.position=c("bottom"))+ 
    theme_classic()+ theme(plot.title = element_text(hjust=0.5),  strip.background = element_blank(),strip.placement = c("outside"))
  print(g)
}

kpi_all_boxplot <- function(data){
   data <- data %>%
    mutate(subindicator_label = factor(subindicator_label,levels=unique(subindicator_label[order(indicator_order)]))) %>%
     mutate(kpi_label= paste0(gsub("(.+?)(\\_.*)","\\1", indicator),": ",subindicator_label)) %>%
     mutate(kpi_label = factor(kpi_label, levels=unique(kpi_label[order(indicator_order)])))
     
  g <- ggplot(data %>% filter(module %in% c("performance kpi") & !is.na(score)), aes(y=score,x=factor(indicator,levels=unique(indicator[order(indicator_order)])), fill=theme))+ # geom_histogram()+  
  ggtitle(paste0("KPIs for ",country," (n = ",length(unique(ae_scores$kobo_farmer_id)), ")"))+labs(x="")+
  geom_boxplot()+  geom_count()+ scale_fill_manual(values=terrain.colors(5))+
  facet_wrap(~indicator, scale="free")+
  #facet_wrap(~kpi_label, labeller=labeller(kpi_label = label_wrap_gen(40)), scale="free",strip.position=c("bottom"))+
    theme_classic()+ theme(plot.title = element_text(hjust=0.5), axis.text.x = element_blank(), strip.background = element_blank(),strip.placement = c("outside"))
  print(g)
}

kpi_all_barchart <- function(data){
  
  data <- data %>%
     filter(!is.na(theme)) %>%
     group_by(theme,indicator,indicator_order) %>%
     summarise(score_scaled_mean = mean(score_scaled,na.rm=TRUE),
               score_scaled_sd = sd(score_scaled,na.rm=TRUE),
               score_scaled_med = median(score_scaled,na.rm=TRUE)) %>%
     mutate(score_scaled_mean_unattained = ifelse(between(score_scaled_mean,0,100), 100-score_scaled_mean,NA)) %>% 
     arrange(indicator_order) %>%
     mutate(indicator = factor(indicator, levels = unique(indicator[order(as.numeric(indicator_order))])))
  
    g <- ggplot(data %>% filter(!is.na(score_scaled_mean)), aes(x=score_scaled_mean,y=reorder(indicator,score_scaled_mean),fill=theme))+
    geom_col(width=0.5,show.legend=TRUE) + 
    geom_errorbar(aes(x=score_scaled_mean, 
                      xmin=ifelse(score_scaled_mean - score_scaled_sd >=0, score_scaled_mean - score_scaled_sd , 0), 
                      xmax=ifelse(score_scaled_mean + score_scaled_sd<=100, score_scaled_mean + score_scaled_sd, 100)),linewidth=0.5,colour="grey50", width=0.2)+
    geom_text(aes(label=round(score_scaled_mean,0),colour=theme), hjust=0,size=5,fontface="bold",show.legend=FALSE)+
    ggtitle(paste0("KPIs for ",country))+labs(x="KPI score (scaled from 0-100)")+
    coord_cartesian(expand=c(0),clip="off")+
    scale_x_continuous(breaks=seq(0,100,20),limits=c(0,110))+
    scale_fill_manual(values=col.theme)+
    scale_colour_manual(values=col.theme)+
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          axis.title.y=element_blank(), 
          legend.position="bottom")
  print(g)  
}

kpi_all_gauge <- function(data){
   data <- data %>%
     filter(!is.na(theme)) %>%
    mutate(subindicator_label = factor(subindicator_label,levels=unique(subindicator_label[order(indicator_order)]))) %>%
     mutate(score_scaled = ifelse(between(score_scaled,0,100), score_scaled,NA)) %>%
     group_by(theme,indicator,indicator_order,kpi_label, kpi_label_short) %>%
     summarise(score_scaled_mean = mean(score_scaled,na.rm=TRUE),
               score_scaled_sd = sd(score_scaled,na.rm=TRUE),
               score_scaled_med = median(score_scaled,na.rm=TRUE)) %>%
     mutate(score_scaled_mean_unattained = ifelse(between(score_scaled_mean,0,100), 100-score_scaled_mean,NA)) %>% 
     arrange(kpi_order) %>%
     mutate(indicator = factor(indicator, levels = unique(indicator[order(indicator_order)]))) %>%
     mutate(kpi_label_short = factor(str_wrap(kpi_label_short,20), levels=unique(str_wrap(kpi_label_short,20)[order(indicator_order)])))
     
  g <- ggplot(data %>% filter(!is.na(score_scaled_mean)))+
    # part showing score scaled from 0 to 100%
    geom_arc_bar(aes(x0=1,y0=1, 
                   start= (score_scaled_mean/100)*(2*pi),
                   end=((score_scaled_mean/100)*(2*pi))+((score_scaled_mean_unattained/100)*(2*pi)),
                   r0=0.75,r=1),
                 fill="grey80",colour="white",show.legend=FALSE)+
    # colour in the gap between score and 100%
    geom_arc_bar(aes(x0=1,y0=1, 
                   start=0,
                   end = (score_scaled_mean/100)*2*pi,
                   r0=0.75,r=1, fill=theme), colour="white", show.legend=FALSE) + 
        
    geom_text(aes(x=1,y=1,label=round(score_scaled_mean,0),colour=theme),
             size=5,fontface="bold",vjust=0.5,show.legend=FALSE)+
    coord_fixed()+
    ggtitle(paste0("KPIs for ",country," scaled from 0 (undesirable) to 100 (desirable)"))+labs(x="")+
    scale_fill_manual(values=col.theme)+
    scale_colour_manual(values=col.theme)+
    # add labels in centre
    facet_wrap(~kpi_label_short, strip.position=c("bottom"))+
    theme_void()+ 
      theme(plot.title = element_text(hjust=0.5), strip.background = element_blank())
  print(g)
  
}

```


## Calculate agroecology indicator scores
Agroecology adherence indicator scores are pre-calculated in another code.

```{r agroecology indicator calcs, include=TRUE, echo=FALSE}
#### Overall agroecology score ####

ae_scores <- d %>%
  filter(module == "agroecology" & !is.na(score)) %>%
  group_by(kobo_farmer_id,module, indicator, indicator_order) %>%
  summarise(score = median(score,na.rm=TRUE),
            score_mean = mean(score,na.rm=TRUE),
            score_sum = sum(score,na.rm=TRUE),
            score_count = n(),.groups="keep") 

ae_calc_temp <- ae_scores %>%
  group_by(kobo_farmer_id,module) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "score_ae_overall",
         indicator_order=14)

ae_scores<- ae_scores %>% full_join(ae_calc_temp)

#d <- d %>% full_join(ae_calc_temp,by=c(kobo_farmer_id))

ggplot(ae_scores, aes(y=score, x=factor(indicator,levels=unique(indicator[order(indicator_order)])), fill=factor(indicator,levels=unique(indicator[order(indicator_order)]))))+ 
  geom_boxplot()+ geom_count()+ 
  ggtitle(paste0("Agroecology scores for ",country," (n = ",length(unique(ae_scores$kobo_farmer_id)), ")")) + 
  labs(x="")+ 
  scale_fill_manual(values=c(terrain.colors(14)[1:13],"purple3"),name="Indicators")+
  theme_bw()+ theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),plot.title=element_text(hjust=0.5))

ggsave(paste0(global.data.path,"figures/1_agroecology_scores_",country,".tif"),width=7,height=6,units="in")

```
## Calculate Key Performance Indicator scores
Key performance indicator scores are calculated here from survey responses.

```{r KPI calcs, include=TRUE, echo=FALSE}

#### Performance KPI1 crop health ###

#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="crop_health")
#temp <- d %>% filter(indicator =="crop_health_fw")
#temp <- d %>% filter(grepl("What percentage of the total crop production",label_question))

#table(temp$label_question)
#table(temp$name_question)
#table(temp$label_question,temp$name_question)

d <- d %>% 
  mutate(subindicator = ifelse(grepl("What percentage of the total crop production was lost or damaged",label_question), "crop_loss",subindicator)) %>%
  mutate(subindicator = ifelse(grepl("What was the main cause of crop loss or damage?",label_question), "crop_loss_cause", subindicator)) %>%
  
  #mutate(subindicator = ifelse(name_question =="_3_4_2_1_8_2","crop_loss",
  #                             ifelse(name_question == "_3_4_2_1_8_3","crop_loss_cause",subindicator))) %>%
  
  mutate(subindicator_label = ifelse(subindicator=="crop_loss", "Avoided crop production lost or damaged in last 12 months (%)", subindicator_label)) %>% 
  mutate(indicator = ifelse(subindicator %in% c("crop_loss"), "kpi1_crop_health", indicator)) %>%
    mutate(indicator_order = ifelse(indicator %in% c("kpi1_crop_health"), 1, indicator_order))

# Remove out of bounds responses
temp_kpi_calc <- d %>%
  filter(subindicator %in% c("crop_loss")) %>%
  mutate(score = ifelse(indicator %in% c("kpi1_crop_health"), name_choice, score)) %>%
  mutate(score = as.numeric(score)) %>%
  # Compute 100 - % loss, so that higher values are better ('Avoided crop loss')
  mutate(score = ifelse(indicator %in%  c("kpi1_crop_health") & score>100,0,100-score)) %>%
  mutate(module = ifelse(indicator %in%  c("kpi1_crop_health"),"performance kpi",module))

kpi_scores <- temp_kpi_calc %>% 
  select(kobo_farmer_id,country, module, theme, indicator, indicator_order, subindicator, subindicator_label, name_question,label_question, name_choice,label_choice,score,score_label)

kpi_histogram(kpi_scores,"kpi1_crop_health")
kpi_all_boxplot(kpi_scores)

### Performance KPI1b Crop health from fieldwork ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="crop_health_fw") %>% filter(!is.na(name_choice))
#table(temp$label_question)
#table(temp$name_question)
#table(temp$label_question,temp$name_question)

temp_kpi_calc <- d %>% filter(indicator =="crop_health_fw") %>% filter(!is.na(name_choice)) %>%
  mutate(subindicator = gsub("\\_.*", "\\1", name_choice),
         score = as.numeric(gsub(".*_(*)", "\\1", name_choice)),
         label_question = gsub("^([^_]*_[^_]*_[^_]*)_.*$","\\1",name_question)) %>%
         #label_question = gsub(".*_.*_(.*)$","\\1",name_question)) %>%
  mutate(subindicator = ifelse(subindicator == "apperance","appearance",subindicator )) %>% unique() %>%
  dcast(kobo_farmer_id+country+label_question~subindicator,value.var="score",fun=median) %>%
  
  # assign scores from 1 to 5 noting response 0 means "I am not sure, or the question is not applicable" 
  mutate_at(c("appearance" ,    "appearance", "disease"  ,      "enemy"  ,        "growth" ,        "management"  ,   "natural", "pest"  , "weed"  ),~na_if(.,0))  %>%
  rowwise() %>%
  mutate(score = median(c(appearance , disease ,      enemy  ,   growth ,        management ,   natural, pest  , weed ),na.rm=T)) %>%
  group_by(kobo_farmer_id,country) %>%
  summarise(score = median(score,na.rm=T)) %>%
  
  # add indicator name
  mutate(indicator = "kpi1b_crop_health_fieldwork",
         subindicator = "crop_health_fw",
         subindicator_label = "Crop health assessed in-field on a scale of 1 (unhealthy) to 5 (healthy)",
         indicator_order = 1.2) 

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc) %>%
  mutate(module = ifelse(indicator %in% c("kpi1b_crop_health_fieldwork"),"performance kpi",module)) %>% mutate(theme = ifelse(indicator %in% c("kpi1b_crop_health_fieldwork"),"agricultural",theme))

kpi_histogram(kpi_scores,"kpi1b_crop_health_fieldwork")
kpi_all_boxplot(kpi_scores)

### Performance KPI2 animal health ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="animal_health")
#table(temp$label_question)
#table(temp$name_choice)
#table(temp$label_choice)
#table(temp$name_question,temp$label_question)

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "What was the extent of injury, illness or death of livestock due to diseases in the last 12 months","livestock_loss",
                               ifelse(label_question=="Over the past 12 months [add country meaning], how did you manage livestock diseases","livestock_disease_management",subindicator))) %>%
  #mutate(subindicator = ifelse(name_question %in% c( "_1_4_3_8/1","_1_4_3_8/2","_1_4_3_8/3","_1_4_3_8/4","_1_4_3_8/5","_1_4_3_8/6","_1_4_3_8/7","_1_4_3_8/8"),"livestock_loss", ifelse(name_question %in% c("_1_4_3_8/1","_1_4_3_8/2","_1_4_3_8/3","_1_4_3_8/4","_1_4_3_8/5","_1_4_3_8/6","_1_4_3_8/7","_1_4_3_8/8"),"livestock_disease_management",subindicator))) %>%
    mutate(subindicator_label = ifelse(subindicator=="livestock_loss","Extent of livestock injury, illness or death due to diseases in last 12 months (score 1-5)",subindicator_label)) 

temp_kpi_calc <- d %>%
  mutate(score = ifelse(subindicator =="livestock_loss" & label_choice=="None",5,
                        ifelse(subindicator =="livestock_loss" & label_choice=="Low",3.66,
                               ifelse(subindicator =="livestock_loss" & label_choice=="Medium",2.33,
                                      ifelse(subindicator =="livestock_loss" & label_choice=="High",1, as.numeric(score)))))) %>%
  
  mutate(score_label = ifelse(subindicator =="livestock_loss" & label_choice=="None","No livestock injury, illness or death",
                        ifelse(subindicator =="livestock_loss" & label_choice=="Low","Low level of livestock injury, illness or death",
                               ifelse(subindicator =="livestock_loss" & label_choice=="Medium","Medium level of livestock injury, illness or death",
                                      ifelse(subindicator =="livestock_loss" & label_choice=="High","High level of livestock injury, illness or death",score_label))))) %>%
  
  mutate(indicator = ifelse(subindicator=="livestock_loss" & module=="performance","kpi2_animal_health",indicator)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi2_animal_health", 2, indicator_order))  %>%
  mutate(module = ifelse(indicator == "kpi2_animal_health","performance kpi",module)) %>% mutate(theme = ifelse(indicator %in% c("kpi2_animal_health"),"agricultural",theme)) %>%
  filter(indicator=="kpi2_animal_health")

#kpi_scores <-  temp_kpi_calc # For Senegal - temporary fix
kpi_scores <-  kpi_scores %>% full_join(temp_kpi_calc)

kpi_histogram(kpi_scores,"kpi2_animal_health")
kpi_all_boxplot(kpi_scores)

### Performance KPI3 soil health ####
#temp <- d %>% filter(indicator =="soil_health")
#table(temp$label_question)
#table(temp$subindicator)
#table(temp$name_choice,temp$label_question)
#table(temp$label_choice,temp$name_choice)
#table(temp$label_choice_short,temp$name_choice)
#table(temp$label_choice_short,temp$score)

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "How would you describe the fertility of your soil on your farmland?","soil_fertility",
                               ifelse(label_question=="How would you describe the level of soil erosion problem on your farmland?","soil_erosion",subindicator))) %>%
  
  # NOTE that soil erosion label_choice is the 'wrong' way around, i.e. lower scores are better         
  mutate(score = ifelse(subindicator=="soil_erosion" & name_choice=="0",5,
                        ifelse(subindicator=="soil_erosion" & name_choice=="1",3,
                               ifelse(subindicator=="soil_erosion" & name_choice=="2",1,score)))) %>%
  
  # soil fertility
  mutate(score = ifelse(subindicator=="soil_fertility" & name_choice=="0",1,
                        ifelse(subindicator=="soil_fertility" & name_choice=="1",2.33,
                               ifelse(subindicator=="soil_fertility" & name_choice=="2",3.66,
                                      ifelse(subindicator=="soil_fertility" & name_choice=="3",5,score)))))

# combine soil erosion and fertility scores
temp_kpi_calc <- d %>% filter(subindicator %in% c("soil_erosion","soil_fertility")) %>%
  mutate(score = as.numeric(score)) %>%
  group_by(kobo_farmer_id,country) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "kpi3_soil_health",
         subindicator = "soil_health_overall")

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score")) %>%
  mutate(subindicator_label = ifelse(subindicator=="soil_health_overall","Perceived soil erosion and fertility from 1 (infertile and major soil erosion) to 3 (highly fertile with no soil erosion)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi3_soil_health",3,indicator_order)) %>%
  mutate(module = ifelse(indicator == "kpi3_soil_health","performance kpi",module)) %>% mutate(theme = ifelse(indicator == "kpi3_soil_health","agricultural",theme))
  
kpi_histogram(kpi_scores,"kpi3_soil_health")
kpi_all_boxplot(kpi_scores)

### Performance KPI3b soil carbon from fieldwork - NEEDS COMPLETING ####

### Performance KPI4 nutrient use ratio ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="nutrient_use") # or inputs
#sort(unique(temp$subindicator))
#sort(unique(temp$label_question))

# set reference fertiliser use (kg/ha) used as the benchmark to determine the under or over use of fertilizer
# default is -9999 meaning NO DATA, and in this case the MEDIAN fertilizer use in the country-specific HOLPA survey data is used

# activate this only if information in ref_values_country on fertilizer recommendations covers enough crops to justify using an average across all crops
if(iso %in% c("ZWE")){
ref_nut_quantity_kg_ha <- ref_values_country %>%
  select(nut_ref_rainfed_clean,nut_ref_irr_clean) %>%
  summarise(nut_ref_med = median(nut_ref_rainfed_clean,na.rm=TRUE),
            nut_ref_mean = mean(nut_ref_rainfed_clean,na.rm=TRUE)) %>%
  mutate(nut_ref_med = ifelse(is.na(nut_ref_med),-9999,nut_ref_med))
ref_nut_quantity_kg_ha <- ref_nut_quantity_kg_ha$nut_ref_med
} else{
  ref_nut_quantity_kg_ha <- -9999 
}

nut_conversion_factors <- ref_values_nut %>%
  filter(Region == iso) %>%
  rename("fertilizer_unit" = `fertilizer unit`,
    "conversion_factor" = `conversion factor (to convert to kilograms)`) %>%
  select(fertilizer_unit,conversion_type_clean,conversion_factor) %>%
  mutate(conversion_factor = ifelse(is.na(conversion_factor),-9999,conversion_factor))

temp_kpi_calc1 <- d %>% filter(indicator =="nutrient_use") %>% filter(label_question =="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}") %>% select(kobo_farmer_id, label_choice) %>% unique() %>% rename("nut_chem_area_unit"=label_choice) 

temp_kpi_calc2 <- d %>% filter(indicator =="nutrient_use") %>% filter(label_question =="Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}") %>% select(kobo_farmer_id, label_choice) %>% unique() %>% rename("nut_orgF_area_unit"=label_choice)  

temp_kpi_calc3 <- d %>% filter(indicator =="nutrient_use") %>% filter(label_question =="Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}") %>% select(kobo_farmer_id, label_choice) %>% unique() %>% rename("nut_org_area_unit"=label_choice)  

area_unit <- temp_kpi_calc1 %>% left_join(temp_kpi_calc2) %>% left_join(temp_kpi_calc3)

if(iso %in% c("SEN")){
  area_unit <- area_unit %>%
    mutate_at(c("nut_chem_area_unit","nut_org_area_unit","nut_orgF_area_unit"),
               ~ifelse(is.na(.),"hectares",as.character(.)))
}

if(iso %in% c("ZWE")){
  area_unit <- area_unit %>%
    mutate_at(c("nut_chem_area_unit","nut_org_area_unit","nut_orgF_area_unit"),
               ~ifelse(is.na(.),"acres",as.character(.)))
}

d <- d %>% 
  # chemical fertilizers
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify applied unit:","nut_chem_unit",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the amount applied","nut_chem_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="Over the past 12 months [add country meaning], how much CHEMICAL FERTILIZER was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}","nut_chem_area",subindicator)) %>%
  
  # organic fertilisers generated on-farm
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify applied unit:" ,"nut_orgF_unit",subindicator))  %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify the amount applied:","nut_orgF_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE GENERATED ON-FARM was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}" , "nut_orgF_area",subindicator)) %>%
  
  # organic fertilizers from other sources
    mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify applied unit:","nut_org_unit",subindicator))  %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify the amount applied" ,"nut_org_quantity",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "Over the past 12 months [add country meaning], how much ORGANIC FERTILIZER OR MANURE FROM OTHER SOURCES (e.g. puchased) was applied to cropland: Specify the surface area affected in ${_1_4_1_1_calculate}","nut_org_area",subindicator)) 

# Put into wide format to align associated data
temp_kpi_calc <- d %>% filter(indicator =="nutrient_use") %>%
  filter(subindicator %in% c("nut_chem_unit","nut_chem_quantity","nut_chem_area",
                             "nut_orgF_unit","nut_orgF_quantity","nut_orgF_area",
                             "nut_org_unit","nut_org_quantity","nut_org_area")) %>%
  dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="name_choice") 

# Check which fertilizer units are used
sort(unique(temp_kpi_calc$nut_chem_unit))
sort(unique(temp_kpi_calc$nut_org_unit))
sort(unique(temp_kpi_calc$nut_orgF_unit))

temp_kpi_calc <- temp_kpi_calc %>%
    left_join(nut_conversion_factors[,c("fertilizer_unit","conversion_factor")],by=c("nut_chem_unit"="fertilizer_unit")) %>%
  rename("nut_chem_unit_conversion" = conversion_factor) %>%
  left_join(nut_conversion_factors[,c("fertilizer_unit","conversion_factor")],by=c("nut_orgF_unit"="fertilizer_unit")) %>%
  rename("nut_orgF_unit_conversion" = conversion_factor) %>%
  left_join(nut_conversion_factors[,c("fertilizer_unit","conversion_factor")],by=c("nut_org_unit"="fertilizer_unit")) %>%
  rename("nut_org_unit_conversion" = conversion_factor) %>%
  left_join(area_unit) %>%
  
  # set conversion factor to 1 if unit is kilograms
  mutate(nut_chem_unit_conversion = ifelse(nut_chem_unit %in% c("kilograms","kg","Kilograms","Kilogram","kilogram","Kilogrammes","kilogramme"),1,nut_chem_unit_conversion),
         nut_org_unit_conversion = ifelse(nut_org_unit %in% c("kilograms","kg","Kilograms","Kilogram","kilogram","Kilogrammes","kilogramme"),1,nut_org_unit_conversion),
nut_orgF_unit_conversion = ifelse(nut_orgF_unit %in% c("kilograms","kg","Kilograms","Kilogram","kilogram","Kilogrammes","kilogramme"),1,nut_orgF_unit_conversion)) %>%
  
   # set quantities to 0 if there is no information on area unit, or no conversion factor provided
  mutate(nut_chem_quantity = ifelse(nut_chem_quantity>0 & (is.na(nut_chem_area) | nut_chem_area ==0 | is.na(nut_chem_unit_conversion) | nut_chem_unit_conversion<0),0,nut_chem_quantity),
         nut_org_quantity = ifelse(nut_org_quantity>0 & (is.na(nut_org_area) | nut_org_area ==0 | is.na(nut_org_unit_conversion) | nut_org_unit_conversion<0),0,nut_org_quantity),
         nut_orgF_quantity = ifelse(nut_orgF_quantity>0 & (is.na(nut_orgF_area)| nut_orgF_area ==0 | is.na(nut_orgF_unit_conversion) | nut_orgF_unit_conversion<0),0,nut_orgF_quantity)) %>%
  
  # fix missing area unit in Kenya data
  mutate(nut_orgF_area_unit = ifelse(kobo_farmer_id== 286788734,"acre",nut_orgF_area_unit)) 

# Calculate nutrient use per unit area
temp_kpi_calc <- temp_kpi_calc %>%
    mutate_at(c("nut_chem_quantity","nut_chem_area",
              "nut_org_quantity","nut_org_area",
              "nut_orgF_quantity","nut_orgF_area"), 
              ~ifelse(is.na(.),0,as.numeric(.))) %>%
  ungroup() %>%
    mutate_at(c("nut_chem_unit_conversion","nut_org_unit_conversion","nut_orgF_unit_conversion"), ~ifelse(is.na(.),NA,as.numeric(.)))

temp_kpi_calc <- temp_kpi_calc %>%
  # convert areas into hectares
  mutate(nut_chem_area_ha = ifelse(nut_chem_area_unit %in% c("acre", "acres","in acres","Acres"), nut_chem_area * acre_to_hectare, nut_chem_area),
         nut_orgF_area_ha = ifelse(nut_orgF_area_unit %in% c("acre","acres","in acres","Acres"), nut_orgF_area * acre_to_hectare, nut_orgF_area),
         nut_org_area_ha = ifelse(nut_org_area_unit %in% c("acre","acres","in acres","Acres"), nut_org_area * acre_to_hectare, nut_org_area)) %>%
  
  # convert quantities applied into kg
  mutate(nut_chem_kg_ha = ifelse(nut_chem_quantity>0, (nut_chem_quantity*nut_chem_unit_conversion) /nut_chem_area_ha, 0),
         nut_org_kg_ha = ifelse(nut_org_quantity>0, (nut_org_quantity*nut_org_unit_conversion)/nut_org_area_ha, 0),
         nut_orgF_kg_ha = ifelse(nut_orgF_quantity>0, (nut_orgF_quantity*nut_orgF_unit_conversion)/nut_orgF_area_ha, 0)) %>%
  
  # Combine and convert from kg/area to kg/hectare
  mutate(nut_quantity_kg_ha = nut_chem_kg_ha + nut_org_kg_ha + nut_orgF_kg_ha) 

# Calculate ratio of nutrient use to recommended (or median) nutrient use levels
temp_kpi_calc <- temp_kpi_calc %>%
  group_by(country) %>% mutate(med_nut_quantity_kg_ha = median(nut_quantity_kg_ha, na.rm=T), mean_nut_quantity_kg_ha = mean(nut_quantity_kg_ha, na.rm=T)) %>% ungroup()  %>%
  mutate(ref_nut_quantity_kg_ha = ref_nut_quantity_kg_ha) %>%
  mutate(score =  ifelse(ref_nut_quantity_kg_ha > 0 , nut_quantity_kg_ha/ref_nut_quantity_kg_ha, nut_quantity_kg_ha/med_nut_quantity_kg_ha)) 

# NOTE, over use of fertilizers receives the highest score, and under use the lowest. 
# this is an agricultural KPI, so we are interested in having both adequate nutrient applications and no over-use (less efficiency)
# so need to be careful with scaling this indicator

# Add this back into the main dataset
temp_kpi_calc <- temp_kpi_calc %>% mutate(indicator = "kpi4_nutrient_use",
                                          subindicator = "nutrient_use", 
                                          score = as.numeric(score)) %>%
    select(kobo_farmer_id,country,indicator,subindicator,score)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(subindicator_label = ifelse(indicator %in% c("kpi4_nutrient_use"),"Ratio between recorded and reference fertilizer use (kg/ha)",subindicator_label),
         indicator_order = ifelse(indicator %in% c("kpi4_nutrient_use"),4,indicator_order)) %>%
    mutate(module = ifelse(indicator %in% c("kpi4_nutrient_use"),"performance kpi",module)) %>%
  mutate(theme = ifelse(indicator %in% c("kpi4_nutrient_use"),"agricultural",theme))

kpi_histogram(kpi_scores,"kpi4_nutrient_use")
kpi_all_boxplot(kpi_scores)

### Performance KPI5a biodiversity - animals ####
#table(d$indicator,d$module)
#temp <- d %>% filter(indicator %in% c("biodiversity_diversity","biodiversity_abundance"))
#sort(unique(temp$label_question))

d <- d %>% 
  # insect pollinators
  mutate(subindicator = ifelse(label_question == "How would you describe the diversity of insect pollinators on your farm?","bio_pollinators",subindicator)) %>%
  # pests
  mutate(subindicator = ifelse(label_question=="How would you describe the diversity of crop and livestock pests on your farm?","bio_pests",subindicator)) %>%
  # pest enemies
  mutate(subindicator = ifelse(label_question=="How would you describe the diversity of natural crop and livestock pest enemies on your farm?","bio_enemies",subindicator)) %>%
  # mammals
    mutate(subindicator = ifelse(label_question=="How would you describe the diversity of mammals on your farm?"  ,"bio_mammals",subindicator)) 
  
  # assign scores
temp_kpi_calc <- d %>%
  mutate(score = case_when(
      subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals") & name_choice %in% ("none") ~ 1,
      subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals") & name_choice %in% ("low") ~ 2.33, 
      subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals") & name_choice %in% ("medium") ~ 3.66, 
      subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals") & name_choice %in% ("high") ~ 5,   .default = score)) %>% 
  
  # assign score labels
  mutate(score_label = case_when(
      subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals") & name_choice %in% ("none") ~ "None: no animals observed",
      subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals") & name_choice %in% ("low") ~ "Low: animals rarely seen or limited to a few species", 
      subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals") & name_choice %in% ("medium") ~ "Medium: animals regularly seen with several species", 
      subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals") & name_choice %in% ("high") ~ "High: abundant with a wide varity of species",   .default = score_label))
      
temp_kpi_calc <- temp_kpi_calc %>% filter(subindicator %in% c("bio_pollinators","bio_pests","bio_enemies","bio_mammals")) %>%
#dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="score") %>%
  group_by(kobo_farmer_id,country) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "kpi5a_animal_diversity",
         subindicator = "animal_diversity") %>% 
    mutate(subindicator_label = "Animal diversity from 1 (no animals observed) to 5 (animals abundant with a wide varity of species)")

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator","subindicator_label","score"), keep=NULL) %>%
  mutate(indicator_order = ifelse(indicator =="kpi5a_animal_diversity",5.1,indicator_order)) %>%
    mutate(module = ifelse(indicator == "kpi5a_animal_diversity","performance kpi",module)) %>%
    mutate(theme = ifelse(indicator == "kpi5a_animal_diversity","environmental",theme))

kpi_histogram(kpi_scores,"kpi5a_animal_diversity")
kpi_all_boxplot(kpi_scores)

### Performance KPI5b biodiversity - trees ####

d <- d %>% 
  # tree abundance
  mutate(subindicator = ifelse(label_question == "How would you describe the amount of trees (or perennial woody plants) on your farm?","bio_tree_abun",subindicator)) %>%
  # tree diversity
    mutate(subindicator = ifelse(label_question== "How would you describe the diversity of trees (or perennial woody plants) on your farm?" , "bio_tree_diversity",subindicator))
  
#temp_kpi_calc <- d %>% filter(subindicator %in% c("bio_tree_abun","bio_tree_diversity"))
#unique(temp_kpi_calc$name_choice)

# assign scores
temp_kpi_calc <- d %>%
  mutate(score = case_when(
      subindicator %in% c("bio_tree_abun","bio_tree_diversity") & name_choice %in% ("none") ~ 1,
      subindicator %in% c("bio_tree_abun","bio_tree_diversity") & name_choice %in% ("low") ~ 2.33, 
      subindicator %in% c("bio_tree_abun","bio_tree_diversity") & name_choice %in% ("medium") ~ 3.66, 
      subindicator %in% c("bio_tree_abun","bio_tree_diversity") & name_choice %in% ("high") ~ 5,   .default = score)) 
      
temp_kpi_calc <- temp_kpi_calc %>% filter(subindicator %in% c("bio_tree_abun","bio_tree_diversity")) %>%
#dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="score") %>%
  group_by(kobo_farmer_id,country) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "kpi5b_tree_diversity",
         subindicator = "tree_diversity") %>% 
    mutate(subindicator_label = "Tree diversity from 1 (no trees) to 5 (high tree diversity)")

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator","subindicator_label","score"), keep=NULL) %>%
  mutate(indicator_order = ifelse(indicator =="kpi5b_tree_diversity",5.2,indicator_order)) %>%
    mutate(module = ifelse(indicator == "kpi5b_tree_diversity","performance kpi",module)) %>%
    mutate(theme = ifelse(indicator == "kpi5b_tree_diversity","environmental",theme))

kpi_histogram(kpi_scores,"kpi5b_tree_diversity")
kpi_all_boxplot(kpi_scores)

### Performance KPI6a biodiversity - abd crop species concentration ####
#table(d$indicator,d$module)
#temp <- d %>% filter(indicator %in% c("biodiversity_agrobiodiversity"))
#temp <- d %>% filter(indicator %in% c("6_synergy"))
#temp <- d %>% filter(indicator %in% c("productivity_crops"))
#temp <- d %>% filter(indicator %in% c("biodiversity_climate_mitigation"))
#unique(temp$label_question)
#unique(temp$name_choice)

# Extract unit used to measure production area
area_unit_crops <- d %>% filter(indicator =="productivity_crops") %>% filter(label_question =="Area of land under ${_3_4_3_1_3_calculate} production in ${_1_4_1_1_calculate}:") %>% select(label_choice) %>% unique()
area_unit_crops <- area_unit_crops$label_choice

# Extract species richness and production area for three main crops
d <- d %>% 
  # crop species richness
  mutate(subindicator = ifelse(label_question == "In the last 12 months [add country meaning], how many different crops species (including perennial crops) were produced on your farm","abd_crop_richness",subindicator)) %>%
  
  # total cropland area
  mutate(subindicator = ifelse(label_question == "What is the total area of land used for growing crops in ${_1_4_1_1_calculate}?", "abd_crop_area",subindicator))  %>%
  
  # area per crop
  mutate(subindicator = ifelse(label_question == "Name of main crop species","abd_crop_name",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "Area of land under ${_3_4_3_1_3_calculate} production in ${_1_4_1_1_calculate}:","abd_area_per_crop",subindicator)) %>%
  
  # crop variety - local/exotic 
  mutate(subindicator = ifelse(label_question == "Do the crops you grow come from certified quality seeds or locally adapted varieties (e.g. traditional cultivars, landraces)?"   ,"abd_crop_local",subindicator)) %>%
  
  # extract area of cropland under diversified practices
  mutate(subindicator = ifelse(label_question == "On the grazing land (owned, leased or shared), did you apply in the last 12 months any of the following practices?","abd_practices_pasture",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "Practices used on your cropland in the past [localised description of 12 months]","abd_practices_cropland", subindicator )) %>%
  mutate(subindicator = ifelse(label_question =="Provide the approximate area of land under this practice in hectares or acres:","abd_practices_area",subindicator )) %>%
  
  # correct indicator names
  mutate(indicator = ifelse(subindicator %in% c("abd_crop_name", "abd_area_per_crop","abd_crop_area","abd_crop_richness", "abd_practices_pasture", "abd_practices_cropland",  "abd_practices_area"), "biodiversity_agrobiodiversity",indicator)) 

# Extract total crop production area 
temp_kpi_calc1 <- d %>%
  filter(subindicator %in% c("abd_crop_name", "abd_area_per_crop")) %>%
  dcast(kobo_farmer_id+country+indicator+index~subindicator,value.var="name_choice")

temp_kpi_calc2 <- d %>%
  filter(subindicator %in% c("abd_crop_area","abd_crop_richness")) %>% select(kobo_farmer_id,country,indicator,subindicator,name_choice) %>% unique() %>%
   dcast(kobo_farmer_id+country+indicator~subindicator,value.var="name_choice")

temp_kpi_calc3 <- d %>% filter(theme=="environmental") %>%
  filter(subindicator %in% c("abd_practices_cropland","abd_practices_area")) %>% select(kobo_farmer_id,country,indicator,subindicator,name_choice,index) %>% unique() %>%
   dcast(kobo_farmer_id+country+indicator+index~subindicator,value.var="name_choice")

temp_kpi_calc <- temp_kpi_calc1 %>% left_join(temp_kpi_calc2) %>% left_join(temp_kpi_calc3) %>%
  mutate(abd_crop_name= ifelse(kobo_farmer_id == 273955054 & abd_crop_name=="None","Groundnut",abd_crop_name))

# Calculate agrobiodiversity concentration score
temp_kpi_calc <- temp_kpi_calc %>%
  mutate_at(c("abd_area_per_crop","abd_crop_area","abd_crop_richness","abd_practices_area"), ~as.numeric(.))  %>%
  # correct cases where area covered by the main crops is more than total cropland area on the farm
  group_by_at(c("kobo_farmer_id","country","indicator")) %>%
  mutate(abd_area_per_crop_summed = sum(abd_area_per_crop)) %>% ungroup() %>%
    mutate(abd_concentration = abd_area_per_crop/abd_crop_area) %>%
  mutate(abd_concentration = ifelse(abd_crop_area < abd_area_per_crop_summed,abd_area_per_crop/abd_area_per_crop_summed, abd_area_per_crop/abd_crop_area)) %>%
  # convert to % by summing the individual crop concentration scores per farm
  group_by_at(c("kobo_farmer_id","country")) %>%
  mutate(abd_concentration_sum = sum(abd_concentration)) %>% ungroup() %>%
  mutate(abd_concentration_score = ifelse(abd_concentration_sum<=1, (1 - abd_concentration_sum)*100,0)) 
  
# Calculate crop richness gap
temp_kpi_calc <- temp_kpi_calc %>%
  group_by_at(c("country")) %>%
  mutate(abd_crop_richness_max = max(abd_crop_richness, na.rm=T),
         abd_crop_richness_min = min(abd_crop_richness, na.rm=T),
         abd_crop_richness_med = median (abd_crop_richness, na.rm=T)) %>% ungroup() %>%
  mutate(abd_crop_richness_index_score = (abd_crop_richness - abd_crop_richness_min)/(abd_crop_richness_max-abd_crop_richness_min)*100)

temp_kpi_calc <- temp_kpi_calc %>%
  select(kobo_farmer_id,country,abd_crop_richness_index_score) %>%
  # remove ABD concentration indicator because I am not convinced it is useful
  # #select(kobo_farmer_id,country, abd_concentration_score,abd_crop_richness_gap_score) %>%
  unique() %>%  
  melt(id.vars=c("kobo_farmer_id","country"),variable.name="subindicator",value.name="score") %>%
  mutate(indicator = ifelse(subindicator== "abd_concentration_score", "kpi6a_abd_concentration",
                            ifelse(subindicator == "abd_crop_richness_index_score","kpi6a_abd_crop_richness_index",NA)))

# Add this back into the main dataset
kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(subindicator_label = ifelse(indicator=="kpi6a_abd_concentration","Crop concentration index (0-100)",subindicator_label),
         subindicator_label = ifelse(indicator=="kpi6a_abd_crop_richness_index","Crop richness index (0-100)",subindicator_label),
         indicator_order = ifelse(indicator =="kpi6a_abd_concentration",6.11,indicator_order),
         indicator_order = ifelse(indicator =="kpi6a_abd_crop_richness_index",6.12,indicator_order)) %>%
    mutate(module = ifelse(indicator %in% c("kpi6a_abd_concentration","kpi6a_abd_crop_richness_index"),"performance kpi",module)) %>% mutate(theme = ifelse(indicator %in% c("kpi6a_abd_concentration","kpi6a_abd_crop_richness_index"),"environmental",theme))

#kpi_histogram(kpi_scores,"kpi6a_abd_concentration")
kpi_histogram(kpi_scores,"kpi6a_abd_crop_richness_index")
kpi_all_boxplot(kpi_scores)

### Performance KPI6b biodiversity - abd varietal/breed richness ####
#table(d$indicator,d$module)
#temp <- d %>% filter(indicator %in% c("biodiversity_agrobiodiversity"))
#unique(temp$label_question)

area_unit_crops <- d %>% filter(indicator =="biodiversity_agrobiodiversity") %>% filter(label_question =="What is the total area of land used for growing crops in ${_1_4_1_1_calculate}?") %>% select(label_choice) %>% unique()
area_unit_crops <- area_unit_crops$label_choice

area_unit_livestock <- d %>% filter(indicator =="biodiversity_agrobiodiversity") %>% filter(label_question =="What is the area of land used for livestock production in ${_1_4_1_1_calculate}: Land you own:" ) %>% select(label_choice) %>% unique()
area_unit_livestock <- area_unit_livestock$label_choice

d <- d %>% 
  # crop species richness
  mutate(subindicator = ifelse(label_question == "In the last 12 months [add country meaning], how many different crops species (including perennial crops) were produced on your farm","abd_crop_richness",subindicator)) %>%
  mutate(subindicator = ifelse(label_question == "What is the total area of land used for growing crops in ${_1_4_1_1_calculate}?", "abd_crop_area",subindicator)) %>%
  # crop variety - local/exotic 
  mutate(subindicator = ifelse(label_question == "Do the crops you grow come from certified quality seeds or locally adapted varieties (e.g. traditional cultivars, landraces)?"   ,"abd_crop_local",subindicator)) %>%
  
  # livestock species richness
    mutate(subindicator = ifelse(label_question== "In the last 12 months [add country meaning], how many different livestock species were produced in your farm?"    , "abd_livestock_richness",subindicator)) %>%
   mutate(subindicator = ifelse(label_question ==  "What is the area of land used for livestock production in ${_1_4_1_1_calculate}: Land you own:" , "abd_livestock_area_owned",subindicator)) %>%
  mutate(subindicator = ifelse(label_question =="What is the area of land used for livestock production in ${_1_4_1_1_calculate}: Share grazing land:","abd_livestock_area_shared",subindicator)) %>%
    # livestock breed - local/exotic  
  mutate(subindicator = ifelse(label_question ==  "Are the livestock you keep exotic or local?"   ,"abd_livestock_local",subindicator)) %>%
  
  # fish richness
  ### RECHECK THIS WHEN A COUNTRY HAS FISH DATA:
  mutate(subindicator = ifelse(label_question== "In the last 12 months [add country meaning], how many different fish species were produced in your farm?"    , "abd_fish_richness",subindicator)) %>%
  mutate(subindicator = ifelse(label_question== "What is the area of land used for fish production in ${_1_4_1_1_calculate}:"  ,"abd_fish_area", subindicator)) %>%
  mutate(subindicator = ifelse(label_question ==  "Are the fish you keep exotic or local?"   ,"abd_fish_local",subindicator)) %>%
  
  # assign scores
  mutate(score = ifelse(subindicator %in% c("abd_crop_richness", "abd_crop_local","abd_crop_area", "abd_livestock_local", "abd_livestock_richness","abd_livestock_area_owned","abd_livestock_area_shared", "abd_fish_richness","abd_fish_area","abd_fish_local"), name_choice,score))

# Assign scores to crop and livestock based on proportion of local 
#temp <- d %>% filter(subindicator %in% c( "abd_crop_local", "abd_livestock_local")) %>% select(subindicator,label_choice,name_choice, score) %>% unique()
#arrange(temp,subindicator,score)

temp_kpi_calc <- d %>% 
  filter(subindicator %in% c( "abd_crop_local", "abd_livestock_local")) %>%
  mutate(score = case_when(subindicator == "abd_crop_local" & label_choice =="Only or mainly locally adapted varieties are grown."~5,
                           subindicator == "abd_crop_local" & label_choice =="Mainly certified seeds and some locally adapted varieties are grown (e.g. traditional cultivars, landraces)."~4,
                           subindicator == "abd_crop_local" & label_choice =="Some certified seeds and some locally adapted varieties are grown (e.g. traditional cultivars, landraces)."~3,
                           subindicator == "abd_crop_local" & label_choice =="Only or mainly certified quality seeds are grown."~2,
                           subindicator == "abd_crop_local" & label_choice =="I don't know, or seeds are neither certified or locally adapted."~1,.default=as.numeric(score))) %>%
  
    mutate(score = case_when(subindicator == "abd_livestock_local" & label_choice =="Only local breeds are kept."~5,
                           subindicator == "abd_livestock_local" & label_choice =="25% are exotic breeds and 75% are local breeds."~4,
                           subindicator == "abd_livestock_local" & label_choice =="Equal numbers of exotic breeds and local breeds are kept"~3,
                           subindicator == "abd_livestock_local" & label_choice =="75% are exotic breeds and 25% are local breeds."~2,
                           subindicator == "abd_livestock_local" & label_choice =="Only exotic breeds are kept."~1,
                           subindicator == "abd_livestock_local" & label_choice =="No exotic or local breeds are kept."~NA,.default=as.numeric(score))) 
  

temp_kpi_calc <- temp_kpi_calc %>%
 dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="score") %>%
  mutate_at(c( "abd_crop_local","abd_livestock_local"), ~as.numeric(.)) %>%
  group_by_at(c("kobo_farmer_id","country")) %>%
  #rowwise() %>%
  mutate(score = median(c_across(c("abd_crop_local","abd_livestock_local")),na.rm=TRUE)) %>% ungroup() %>%
  mutate(indicator = "kpi6b_abd_variety_diversity",
         subindicator = "abd_variety_breed_diversity",
         subindicator_label = "Use of local varieties and breeds from 1 (only exotic varieties/breeds) to 5 (only local varieties/breeds)") %>%
  select(c("kobo_farmer_id","country","indicator","subindicator","subindicator_label","score"))

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
  mutate(indicator_order = ifelse(indicator =="kpi6b_abd_variety_diversity",6.2,indicator_order)) %>%
    mutate(module = ifelse(indicator == "kpi6b_abd_variety_diversity","performance kpi",module)) %>% mutate(theme = ifelse(indicator %in% c("kpi6b_abd_variety_diversity"),"environmental",theme))

kpi_histogram(kpi_scores,"kpi6b_abd_variety_diversity")
kpi_all_boxplot(kpi_scores)

### Performance KPI7 biodiversity - landscape complexity ####
#table(d$indicator,d$module)
#temp <- d %>% filter(indicator %in% c("landscape_complexity","biodiversity_cover"))
#unique(temp$label_question)

d <- d %>%
  # landscape complexity
  mutate(subindicator = ifelse(grepl("How much land area is covered by natural and semi-natural vegetation on land owned, rented or used by the household: Any natural",label_question), "landscape_complexity",subindicator)) %>%
  
  # plant diversity in landscape features
  mutate(subindicator = ifelse(label_question %in% 
                                 c("How would you describe the plant diversity (i.e., number of plant species) in: Bushland patches", 
                                   "How would you describe the plant diversity (i.e., number of plant species) in: Fallow land which is unproductive for at least 1 year", 
                                   "How would you describe the plant diversity (i.e., number of plant species) in: Hedgerows/Live fences", 
                                   "How would you describe the plant diversity (i.e., number of plant species) in: Natural grassland",  
                                   "How would you describe the plant diversity (i.e., number of plant species) in: Remnant forest patches",
                                   "How would you describe the plant diversity (i.e., number of plant species) in: Wetlands", 
                                   "How would you describe the plant diversity (i.e., number of plant species) in: Woodlots"),
                               "landscape_diversity_by_feature",subindicator))

# assign scores
#temp <- d %>% filter(subindicator %in% c( "landscape_complexity", "landscape_diversity_by_feature")) %>% select(subindicator,label_choice,name_choice, score) %>% unique()
#arrange(temp,subindicator,score)

temp_kpi_calc <- d  %>% filter(subindicator %in% c( "landscape_complexity", "landscape_diversity_by_feature")) %>%
  mutate(score = case_when(subindicator == "landscape_complexity" & label_choice =="51-100%"~5,
                           subindicator == "landscape_complexity" & label_choice =="21-50%"~4,
                           subindicator == "landscape_complexity" & label_choice =="11-20%"~3,
                           subindicator == "landscape_complexity" & label_choice =="1-10%"~2,
                           subindicator == "landscape_complexity" & label_choice =="No presence or occurrence."~1,.default=as.numeric(score))) %>%
  
  mutate(score = case_when(subindicator == "landscape_diversity_by_feature" & name_choice %in% c("high")~5,
                           subindicator == "landscape_diversity_by_feature" & name_choice %in% c("medium")~3.67,
                           subindicator == "landscape_diversity_by_feature" & name_choice %in% c("low")~2.34,
                           subindicator == "landscape_diversity_by_feature" & name_choice %in% c("none")~NA, .default=as.numeric(score)))

temp_kpi_calc <- temp_kpi_calc %>% filter(!(module=="agroecology")) %>%
   #filter(subindicator %in% c( "landscape_diversity_by_feature")) %>%
  group_by(kobo_farmer_id,country,subindicator) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  dcast(kobo_farmer_id+country~subindicator,value.var="score") %>%
  group_by(kobo_farmer_id, country,landscape_complexity,landscape_diversity_by_feature) %>%
  mutate(score_med = median(landscape_complexity, landscape_diversity_by_feature, na.rm=TRUE)) %>%
  mutate(score = ifelse(landscape_complexity==1,1,
                        ifelse(is.na(landscape_diversity_by_feature), landscape_complexity, score_med)))

temp_kpi_calc <- temp_kpi_calc %>% #filter(subindicator=="landscape_diversity_by_feature") %>%
  mutate(score = as.numeric(score)) %>%
  group_by_at(c("kobo_farmer_id","country")) %>%
  mutate(score = median(score,na.rm=TRUE)) %>% ungroup() %>%
  mutate(indicator = "kpi7_landscape_complexity",
         subindicator = "landscape_complexity",
         subindicator_label = "Proportion and diversity of natural features in the landscape from 1 (no natural features) to 5 (>50% natural features with functionally diverse plant species)") %>%
  select(c("kobo_farmer_id","country","indicator","subindicator","subindicator_label","score")) %>% unique()

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
  mutate(indicator_order = ifelse(indicator =="kpi7_landscape_complexity", 7, indicator_order)) %>%
    mutate(module = ifelse(indicator == "kpi7_landscape_complexity","performance kpi",module)) %>% mutate(theme = ifelse(indicator %in% c("kpi7_landscape_complexity"),"environmental",theme))

kpi_histogram(kpi_scores,"kpi7_landscape_complexity")
kpi_all_boxplot(kpi_scores)

### Performance KPI8 climate mitigation ####
#ort(unique(d$indicator))
#temp <- d %>% filter(indicator %in% c("biodiversity_climate_mitigation") | subindicator %in% c("abd_practices_cropland","abd_practices_area"))
#table(temp$subindicator)
#sort(unique(temp$label_question))
#table(temp$name_choice)
#table(temp$label_choice)

d <- d %>%
  mutate(subindicator = ifelse(label_question %in% c("Since when has your household been farming this land?"),"land_use_history",subindicator)) %>%
  mutate(subindicator = ifelse(label_question %in% c("What was the main previous land cover?"),"land_use_previous",subindicator))

temp_kpi_calc <- d %>% filter(theme=="environmental") %>%
  filter(subindicator %in% c("abd_practices_cropland","abd_practices_area")) %>% select(kobo_farmer_id,country,indicator,subindicator,name_choice,index) %>% unique() %>%
  dcast(kobo_farmer_id+country+indicator+index~subindicator,value.var="name_choice") %>%
  mutate(abd_practices_area = as.numeric(abd_practices_area)) %>%
  group_by(kobo_farmer_id) %>% mutate(abd_practices_area_total = sum(abd_practices_area)) %>% ungroup() %>%
  mutate(practice_share = abd_practices_area/abd_practices_area_total)

#sort(unique(temp_kpi_calc$abd_practices_cropland))

# Classify practices in the survey into the practice groups listed in our climate change reference values sheet
temp_kpi_calc <- temp_kpi_calc %>%
  mutate(practice_cc_group = case_when(abd_practices_cropland %in% c("Agroforestry","Homegarden")~"Agroforestry",
                                       abd_practices_cropland %in% c("Cover crops")~"Green manure",
                                       abd_practices_cropland %in% c("Mulching")~"Mulching",
                                       abd_practices_cropland %in% c("Crop rotation")~"Crop rotation",
                                       abd_practices_cropland %in% c("Fallow (leave land unproductive)","Hedgerows/Live fences", "Natural strips/vegetation"  )~"Embedded natural (hedgerows)",
                                       abd_practices_cropland %in% c("Intercropping","Pull-push"  )~"Intercropping",
                                       abd_practices_cropland %in% c("Land clearing for agriculture","Burning crop residues")~"Vegetation clearance",
                                       abd_practices_cropland %in% c("Monoculture with perennial crops","None")~"Monocultures perennial",
                                       abd_practices_cropland %in% c("Monoculture with annual crops","None")~"Monocultures annual",.default="Check")) %>%
  # Append climate mitigation scores associated with each practice
  left_join(ref_values_cc,by=c("practice_cc_group"="Practice"))

# Calculate a weighted average
temp_kpi_calc <- temp_kpi_calc %>% 
  mutate(weighted_cc_score = score_overall*practice_share) %>%
  group_by(kobo_farmer_id,country) %>%
  summarise(score = mean(weighted_cc_score,na.rm=TRUE)) 

# set indicator names
temp_kpi_calc <- temp_kpi_calc %>%
  mutate(indicator = "kpi8_climate_mitigation",
         subindicator = "climate_mitigation",
         subindicator_label = "Climate mitigation score from 1 to 5, where 1 represents a farm with high GHG emitting and low carbon sequestrating practices, and 5 a farm with low emitting and high sequestrating practices",
         score = ifelse(is.nan(score),NA,score)) 

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
  mutate(indicator_order = ifelse(indicator =="kpi8_climate_mitigation", 8, indicator_order)) %>%
  mutate(module = ifelse(indicator == "kpi8_climate_mitigation","performance kpi",module)) %>% mutate(theme = ifelse(indicator %in% c("kpi8_climate_mitigation"),"environmental",theme))

kpi_histogram(kpi_scores,"kpi8_climate_mitigation")
kpi_all_boxplot(kpi_scores)

### Performance KPI9 water use ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="water" )
#table(temp$name_question)
#table(temp$label_question)
#table(temp$name_choice)
#table(temp$label_choice)

d <- d %>% 
  # months with water stress
  mutate(subindicator = ifelse(label_question %in% c("During which months of the year do you find it difficult to access enough water for your agricultural needs (e.g. growing crops, drinking water for livestock): During a normal year"),"water_stress_normal",subindicator)) 
  
temp_kpi_calc <- d %>% filter(subindicator == "water_stress_normal") %>%
  mutate(score = 1) %>%
  dcast(kobo_farmer_id+country+module+theme~indicator,value.var="score",fun=sum) %>%
  rename("score"=water) %>% mutate(score = as.numeric(score)) %>%
  mutate(score = (1- score/12)*100) %>%
  mutate(indicator = "kpi9_avoided_water_stress",
         subindicator = "avoided_ag_water_stress",
         subindicator_label = "Share of months WITHOUT agricultural water stress in a normal year (%)",
         indicator_order = 9)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
    mutate(module = ifelse(indicator %in% c("kpi9_avoided_water_stress"),"performance kpi",module)) %>% mutate(theme = ifelse(indicator %in% c("kpi9_avoided_water_stress"),"environmental",theme))

kpi_histogram(kpi_scores,"kpi9_avoided_water_stress")
kpi_all_boxplot(kpi_scores)

### Performance KPI10 energy use ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="energy" )
#table(temp$name_question)
#table(temp$label_question)
#table(temp$name_choice)
#table(temp$label_choice)

d <- d %>% 
  mutate(subindicator = ifelse(indicator=="energy" & label_question == "Where do you source most of your energy?", "energy_source", subindicator)) %>%
  mutate(score = ifelse(subindicator %in% c("energy_source"), name_choice, score)) %>% mutate(score = as.numeric(score)) 

# Check what 'other' energy sources were listed
#temp <- d %>% filter(indicator =="energy" ) %>% filter(label_choice =="other")
#sort(unique(temp$label_choice))

temp_kpi_calc <- d %>% select(-theme) %>% filter(indicator == "energy") %>% filter(!(subindicator =="energy_source")) %>% unique() %>%
  mutate(energy_type = case_when(label_choice %in% 
                                   c("Animal traction", 
                                     "Burning plant materials",       
                                     "Human power/by hand only",
                                     "Solar panel") ~ "Renewable",
                                 label_choice %in% 
                                   c("Electricity (national grid)",
                                     "Gas LPG" ,
                                     "Biogas" ,
                                     "Gas",
                                     "Petrol or diesel")~"Non_renewable", 
                                 label_choice %in% c("other") & 
                                   name_choice %in% c("Human power",
                                                      "Water from underground") ~ "Renewable", .default=label_choice))

# Get count of renewable and non-renewable energy sources
temp_kpi_calc <-temp_kpi_calc %>%
  dcast(kobo_farmer_id+country~energy_type,value.var="energy_type",fun=length) 
# Score based on share of renewable
temp_kpi_calc <-temp_kpi_calc %>%
  mutate(energy_type_score = ifelse(Renewable>0 & Non_renewable<1,5,
                       ifelse(Renewable>0 & Non_renewable>0, 3,
                              ifelse(Renewable<1 & Non_renewable>0, 1, NA)))) %>%
  mutate(energy_type_score = as.numeric(energy_type_score))

# Combine with information on energy production source
temp_kpi_calc <- temp_kpi_calc %>% left_join(
  d %>% filter(subindicator =="energy_source") %>% 
    select(kobo_farmer_id,score) %>%
    rename("energy_source_score" = score))

temp_kpi_calc <- temp_kpi_calc %>%
  group_by(kobo_farmer_id,country,energy_type_score,energy_source_score) %>%
  mutate(score = median(c(energy_type_score,energy_source_score),na.rm=T)) %>% ungroup() %>%
  select(kobo_farmer_id,country,score) %>%
  mutate(indicator = "kpi10_energy_use",
         subindicator = "energy_use_sustainability",
         subindicator_label = "Sustainability of energy use with scores from 1 (Non-renewable and externally produced) to 5 (Renewable and self-produced)",
         indicator_order = 10)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc) %>%
  mutate(module = ifelse(indicator %in% c("kpi10_energy_use"),"performance kpi",module))  %>% mutate(theme = ifelse(indicator %in% c("kpi10_energy_use"),"environmental",theme))

kpi_histogram(kpi_scores,"kpi10_energy_use")
kpi_all_boxplot(kpi_scores)

### Performance KPI11 income ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="income")
#sort(unique(temp$label_question))

# set reference national annual income (local currency per year) used as the benchmark to determine how household incomes compare to this
# default is to use the MEDIAN income recorded in the country-specific HOLPA survey data 
# alternative is to use country-sourced data: activate this option only if information on income is provided in ref_values_country
ref_income <- ref_values_country %>%
  select(income_ref_clean) 
ref_income <- ref_income$income_ref_clean[1]
#ref_income <- NA

d <- d %>%
  mutate(subindicator = case_when(grepl("In the past 12 months, approximately how much income", label_question)~"income_amount",
                                  grepl("Does the household earn enough income",label_question)~"income_sufficiency", 
         grepl("How would you rate the stability of the household income?",label_question) ~ "income_stability",
         grepl("In the last 12 months, did the household spend more",label_question)~"income_versus_expenditures",
                                  .default=subindicator)) 
  
temp_kpi_calc <- d %>% filter(subindicator =="income_amount") %>%
  mutate(score = ifelse(name_choice %in% c("9999","nd"),NA,name_choice)) %>%
  mutate(score = as.numeric(score)) %>%
  filter(!(is.na(score))) %>%
  group_by(kobo_farmer_id,country) %>%
  summarise(income=sum(score),
            income_sources = n()) %>%
  group_by(country) %>%
  mutate(mean_income = mean(income,na.rm=T)) %>%
  mutate(ref_income = ifelse(!is.na(ref_income),ref_income,mean_income)) %>%
  mutate(score = income/ref_income)

temp_kpi_calc <- temp_kpi_calc %>%
  select(kobo_farmer_id,country,score) %>%
  mutate(indicator = "kpi11_hh_income_v_mean",
       subindicator = "hh_income_compared_to_average",
       subindicator_label = "Ratio of household income compared to the average",
       indicator_order = 11.1)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
  mutate(module = ifelse(indicator %in% c("kpi11_hh_income_v_mean"),"performance kpi",module)) %>%
  mutate(theme = ifelse(indicator %in% c("kpi11_hh_income_v_mean"),"economic",theme)) 

kpi_histogram(kpi_scores,"kpi11_hh_income_v_mean")
kpi_all_boxplot(kpi_scores)

### Performance KPI11b income stability ####
temp_kpi_calc <- d %>% filter(subindicator =="income_stability") %>% select(-module,-index, -theme) %>%unique()

table(temp_kpi_calc$label_choice,temp_kpi_calc$name_choice)

temp_kpi_calc <- temp_kpi_calc %>%
  mutate(score = ifelse(name_choice %in% c("9999","nd"),NA,name_choice)) %>%
  mutate(score = as.numeric(score)) %>%
  filter(!(is.na(score)))

temp_kpi_calc <- temp_kpi_calc %>%
  select(kobo_farmer_id,country,score) %>%
  mutate(indicator = "kpi11b_hh_income_stability",
       subindicator = "hh_income_stability",
       subindicator_label = "Income stability from 1 (income declining) to 5 (income increasing)",
       indicator_order = 11.2)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
  mutate(module = ifelse(indicator %in% c("kpi11b_hh_income_stability"),"performance kpi",module)) %>%
  mutate(theme = ifelse(indicator %in% c("kpi11b_hh_income_stability"),"economic",theme)) 

kpi_histogram(kpi_scores,"kpi11b_hh_income_stability")
kpi_all_boxplot(kpi_scores)

### Performance KPI11c income-expenditures ####
temp_kpi_calc <- d %>% filter(subindicator =="income_versus_expenditures") %>% select(-module,-index, -theme) %>%unique()

table(temp_kpi_calc$label_choice,temp_kpi_calc$name_choice)

temp_kpi_calc <- temp_kpi_calc %>%
  mutate(score = ifelse(name_choice %in% c("2","nd","-9999"),NA,name_choice)) %>%
  mutate(score = as.numeric(score)) %>%
  filter(!(is.na(score)))

temp_kpi_calc <- temp_kpi_calc %>%
  select(kobo_farmer_id,country,score) %>%
  mutate(indicator = "kpi11c_hh_income_v_expenditures",
       subindicator = "hh_income_v_expenditure",
       subindicator_label = "Income higher than expenditures",
       indicator_order = 11.3)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
  mutate(module = ifelse(indicator %in% c("kpi11c_hh_income_v_expenditures"),"performance kpi",module)) %>%
  mutate(theme = ifelse(indicator %in% c("kpi11c_hh_income_v_expenditures"),"economic",theme)) 

kpi_histogram(kpi_scores,"kpi11c_hh_income_v_expenditures")
kpi_all_boxplot(kpi_scores)

### Performance KPI11d income sufficiency ####
temp_kpi_calc <- d %>% filter(subindicator =="income_sufficiency") %>% select(-module,-index, -theme) %>%unique()

table(temp_kpi_calc$label_choice,temp_kpi_calc$name_choice)

temp_kpi_calc <- temp_kpi_calc %>%
  mutate(score = ifelse(name_choice %in% c("nd","-9999"),NA,name_choice)) %>%
  mutate(score = as.numeric(score)) %>%
  filter(!(is.na(score)))

temp_kpi_calc <- temp_kpi_calc %>%
  select(kobo_farmer_id,country,score) %>%
  mutate(indicator = "kpi11d_hh_income_sufficiency",
       subindicator = "hh_income_sufficiency",
       subindicator_label = "Income sufficiency",
       indicator_order = 11.4)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
  mutate(module = ifelse(indicator %in% c("kpi11d_hh_income_sufficiency"),"performance kpi",module)) %>%
  mutate(theme = ifelse(indicator %in% c("kpi11d_hh_income_sufficiency"),"economic",theme)) 

kpi_histogram(kpi_scores,"kpi11d_hh_income_sufficiency")
kpi_all_boxplot(kpi_scores)

### Performance KPI12 yield gap ####
sort(unique(d$indicator))
temp <- d %>% filter(indicator =="productivity_crops" | name_question %in% c("_3_4_3_1_3_calculate"))
#sort(unique(temp$label_question))

area_unit <- d %>% filter(name_question %in% c("_1_4_1_1_calculate")) %>% select(kobo_farmer_id,name_question,name_choice) %>% unique()

temp_kpi_calc <- d %>%
  filter(name_question %in% c("_3_4_3_1_3_calculate","_3_4_2_1_5_1_calculate","_3_4_2_1_5_2","_3_4_2_1_3")) %>%
  dcast(kobo_farmer_id+index ~ name_question,value.var = "name_choice") %>%
  left_join(area_unit) 

# CONTINUE HERE

### Performance KPI13 labour productivity ####

### Performance KPI14 climate resilience ####

### Performance KPI15 diet quality ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="nutrition")
#sort(unique(temp$label_question))

# Calculate food group diversity scores
temp_kpi_calc <- d %>% filter(indicator == "nutrition") %>%
  mutate(food_group = case_when(name_question %in% c("_3_1_3_1_1", "_3_1_3_1_2","_3_1_3_1_3")~"grains, roots, tubers",
                                # pulses
                                name_question %in% c("_3_1_3_1_4")~"pulses",
                                name_question %in% c("_3_1_3_1_21")~"nuts and seeds",
                                name_question %in% c("_3_1_3_1_14", "_3_1_3_1_15","_3_1_3_1_25")~"dairy",
                                name_question %in% c("_3_1_3_1_16", "_3_1_3_1_17","_3_1_3_1_18","_3_1_3_1_19", "_3_1_3_1_20")~"meat, poultry, fish",
                                name_question %in% c("_3_1_3_1_13") ~ "eggs",
                                name_question %in% c("_3_1_3_1_6")~"dark leafy vegetables",
                                name_question %in% c("_3_1_3_1_5","_3_1_3_1_8")~"other vit-A rich fruits and vegetables",
                                name_question %in% c("_3_1_3_1_7")~"other vegetables",
                                name_question %in% c("_3_1_3_1_9","_3_1_3_1_10") ~ "other fruits",.default="other FG"))


temp_kpi_calc <- temp_kpi_calc %>%
  dcast(kobo_farmer_id+country+food_group~label_choice,value.var="name_choice",fun=length) %>%  mutate(score_fgds = ifelse(Yes>0 & !(food_group %in% c("other FG")),1,0)) %>%
    group_by(kobo_farmer_id,country) %>%
    summarise(score = sum(score_fgds,na.rm=TRUE)) %>%
  mutate(indicator = "kpi15_diet_diversity",
         subindicator = "FGDS_food_group_diversity_score",
         subindicator_label = "Semi-continuous score of food groups consumed in individual diets from 0 (no diversity) to 10 (high diversity)",
         indicator_order = 15)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, keep=NULL) %>%
  mutate(module = ifelse(indicator %in% c("kpi15_diet_diversity"),"performance kpi",module)) %>%
  mutate(theme = ifelse(indicator %in% c("kpi15_diet_diversity"),"social",theme)) 

kpi_histogram(kpi_scores,"kpi15_diet_diversity")
kpi_all_boxplot(kpi_scores)

### Performance KPI16 farmer agency ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="farmer_agency")
#sort(unique(temp$label_question))

d <- d %>% 
  # household agency
    mutate(subindicator = ifelse(label_question ==  "On which step of the ladder would you position the majority of women in your household today?"   ,"agency_hh_f",subindicator)) %>%
  mutate(subindicator = ifelse(label_question ==  "On which step of the ladder would you position the majority of men in your household today?"    ,"agency_hh_m",subindicator)) 
  
  # Put into wide format to align associated data
temp_kpi_calc <- d %>% filter(subindicator %in% c("agency_hh_f","agency_hh_m")) %>%
  dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="name_choice") 

# Calculate indicators of interest
temp_kpi_calc <- temp_kpi_calc %>%
    mutate_at(c("agency_hh_f","agency_hh_m"), ~as.numeric(.)) %>%
  mutate(agency_hh = median(c(agency_hh_f,agency_hh_m),na.rm=T)) %>%
  mutate(indicator = "kpi16_farmer_agency",
         subindicator = "agency_hh",
         score = agency_hh)

temp_kpi_calc <-  temp_kpi_calc %>% 
    select(kobo_farmer_id,country,indicator,subindicator,score)

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(module = ifelse(indicator %in% c("kpi16_farmer_agency"),"performance kpi",module))  %>%
  mutate(subindicator_label = ifelse(indicator %in% c("kpi16_farmer_agency"),"Perceived household agency (median for men and women) to make decisions from 1 (no power or freedom) to 5 (total power and freedom)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator %in% c("kpi16_farmer_agency"),16,indicator_order)) %>%
  mutate(theme = ifelse(indicator %in% c("kpi16_farmer_agency"),"social",theme)) 

kpi_histogram(kpi_scores,"kpi16_farmer_agency")
kpi_all_boxplot(kpi_scores)

#### Performance KPI17a land tenure security and KPI17b land owned as share of total used ###
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="land_tenure_security")
#sort(unique(temp$label_question))

d <- d %>% 
  # total land
  mutate(subindicator = ifelse(label_question ==  "What is the total area in hectares (or acres) of land (agricultural or not) that your household: Currently OWNS:"    ,"land_owned_hh",subindicator)) %>%
  mutate(subindicator = ifelse(label_question ==  "What is the total area in hectares (or acres) of land (agricultural or not) that your household: Currently LEASES from another person:" ,"land_leased_hh",subindicator)) %>% 
  mutate(subindicator = ifelse(label_question ==  "What is the total area in hectares (or acres) of land (agricultural or not) that your household: Currently HOLDS USE RIGHTS, either alone or jointly with someone else:" ,"land_rights_hh",subindicator)) %>%
  
  # land owned
  mutate(subindicator = ifelse(label_question == "From the ${_1_4_1_1_1} ${_1_4_1_1_calculate} of land that your household OWNS, please specify how much is owned by: A FEMALE member/members:" ,"land_owned_f",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="From the ${_1_4_1_1_1} ${_1_4_1_1_calculate} of land that your household OWNS, please specify how much is owned by: A MALE member/members:" ,"land_owned_m",subindicator)) %>%
  
  # land leased
  mutate(subindicator = ifelse(label_question=="From the ${_1_4_1_1_2} ${_1_4_1_1_calculate} of land that your household LEASES from another person, please specify how much is rented by: A FEMALE member/members:" ,"land_leased_f",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="From the ${_1_4_1_1_2} ${_1_4_1_1_calculate} of land that your household LEASES from another person, please specify how much is rented by: A MALE member/members:"  ,"land_leased_m",subindicator)) %>%
  
    # land use rights
  mutate(subindicator = ifelse(label_question=="From the ${_1_4_1_1_3} ${_1_4_1_1_calculate} of land (agricultural or not) that your household HOLDS USE RIGHTS, either alone or jointly with someone else, please specify how much is held by: A FEMALE member/members:" ,"land_rights_f",subindicator)) %>%
  mutate(subindicator = ifelse(label_question== "From the ${_1_4_1_1_3} ${_1_4_1_1_calculate} of land (agricultural or not) that your household HOLDS USE RIGHTS, either alone or jointly with someone else, please specify how much is held by: A MALE member/members:", "land_rights_m",subindicator)) %>%
  
  # land area that is vulnerable
    mutate(subindicator = ifelse(label_question=="What is the total area of your land that could be affected?"  ,"land_vulnerable_area",subindicator)) %>%
  mutate(subindicator = ifelse(label_question=="Do you perceive that you could involuntarily lose ownership or use rights to any of the land (agricultural or not) you currently own or hold use rights to in the next 5 years?" ,"land_security_perceived",subindicator)) %>%
  
  # For perceived loss of land access, make sure that name_choice values are in format 5 = no risk of loss, 1 = high risk of loss
  mutate(name_choice = ifelse(subindicator=="land_security_perceived" & label_choice=="Extremely likely",1,
                ifelse(subindicator=="land_security_perceived" & label_choice == "Very likely",2,
                       ifelse(subindicator=="land_security_perceived" & label_choice == "Moderately likely",3,
                              ifelse(subindicator=="land_security_perceived" & label_choice == "Slightly likely" ,4,
                                     ifelse(subindicator=="land_security_perceived" & label_choice == "Not at all" ,5,name_choice)))))) 

# Put into wide format to align associated data
temp_kpi_calc <- d %>% filter(indicator =="land_tenure_security") %>%
  dcast(kobo_farmer_id+country+indicator ~subindicator,value.var="name_choice") 

# Calculate indicators of interest

temp_kpi_calc <- temp_kpi_calc %>%
    mutate_at(c("land_leased_f" , "land_leased_hh"    ,   "land_leased_m" ,       "land_owned_f"     ,    "land_owned_hh"   ,  "land_owned_m"  ,       "land_rights_f",        "land_rights_hh" ,      "land_rights_m" ,  "land_vulnerable_area","land_security_perceived"), ~ifelse(is.na(.),0,as.numeric(.))) %>%
  
  mutate(land_vulnerable_share = land_vulnerable_area/(land_owned_hh+land_leased_hh + land_rights_hh)*100) %>%
  mutate(land_vulnerable_share = ifelse(land_vulnerable_share>100,100,land_vulnerable_share)) %>%
  mutate(land_owned_share = land_owned_hh/(land_owned_hh+land_leased_hh + land_rights_hh)*100) %>%
   mutate(land_owned_share = ifelse(land_owned_share>100,100,land_owned_share)) %>%
  mutate(land_security_perceived_weighted = ifelse(land_vulnerable_share>0 & !is.na(land_vulnerable_share),land_security_perceived * (land_vulnerable_share/100),land_security_perceived)) %>%
  # cap the minimum to a score of 1
  mutate(land_security_perceived_weighted = ifelse(land_security_perceived_weighted<1,1,land_security_perceived_weighted))

temp_kpi_calc <- temp_kpi_calc %>% 
  melt(id.vars=c("kobo_farmer_id","country","indicator"), measure.vars=c("land_owned_share","land_security_perceived","land_security_perceived_weighted"),variable.name="subindicator",value.name="score") 

# Add this back into the main dataset

temp_kpi_calc <- temp_kpi_calc %>%
  select(kobo_farmer_id,country,indicator,subindicator,score) %>%
  mutate(indicator = ifelse(subindicator == "land_security_perceived_weighted", "kpi17a_land_tenure", indicator)) %>%
  mutate(indicator = ifelse(subindicator=="land_owned_share","kpi17b_land_tenure",indicator)) 
    
kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(subindicator_label = ifelse(indicator=="kpi17a_land_tenure","Perceived land tenure security from 1 = (Extremely likely to lose access to all land) to 5 (Not at all likely to lose access to any land)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi17a_land_tenure",17.1,indicator_order)) %>%
  mutate(subindicator_label = ifelse(indicator=="kpi17b_land_tenure","Share of household land that is owned (%)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi17b_land_tenure",17.2,indicator_order)) %>%
  mutate(module = ifelse(indicator %in%  c("kpi17a_land_tenure", "kpi17b_land_tenure"), "performance kpi",module)) %>%
  mutate(theme = ifelse(indicator %in% c("kpi17a_land_tenure","kpi17b_land_tenure"),"social",theme)) 

kpi_histogram(kpi_scores,"kpi17a_land_tenure")
kpi_histogram(kpi_scores,"kpi17b_land_tenure")
kpi_all_boxplot(kpi_scores)
  
### Performance KPI18 human wellbeing ####
#sort(unique(d$indicator))
#temp <- d %>% filter(indicator =="wellbeing")
#sort(unique(temp$subindicator))
#sort(unique(temp$label_question))
#sort(unique(temp$label_choice))

d <- d %>% 
  mutate(subindicator = ifelse(label_question == "How satisfied are you with feeling part of your community?" ,"satisfaction_community",
                               ifelse(label_question == "How satisfied are you with how safe you feel?" , "satisfaction_safety",
                                      ifelse(label_question =="How satisfied are you with the amount of time you have to do the things that you like doing?","satisfaction_time",
                                             ifelse(label_question == "How satisfied are you with the quality of your local environment?", "satisfaction_environment",
                                                    ifelse(label_question == "How satisfied are you with what you are achieving in life?","satisfaction_achievements",
                                                           ifelse(label_question=="How satisfied are you with your economic security?", "satisfaction_economic",
                                                                  ifelse(label_question== "How satisfied are you with your health?","satisfaction_health",
                                                                         ifelse(label_question=="How satisfied are you with your nutritional security?","satisfaction_nutritional",
                                                                                ifelse(label_question=="How satisfied are you with your occupation?" ,"satisfaction_occupation",
                                                                                       ifelse(label_question=="How satisfied are you with your personal relationships?" ,"satisfaction_relationships",
                                                                                              ifelse(label_question=="How satisfied are you with your standard of living?","satisfaction_livingstandard",
                                                                                                     ifelse(label_question=="Thinking about your own life and personal circumstances, how satisfied are you with your life as a whole?","satisfaction_overall",subindicator))))))))))))) %>%
  mutate(score = ifelse(indicator=="wellbeing" & label_choice=="Completely satisfied.",5,
                ifelse(indicator=="wellbeing" & label_choice == "Somewhat satisfied.",4,
                       ifelse(indicator=="wellbeing" & label_choice == "Neutral",3,
                              ifelse(indicator=="wellbeing" & label_choice == "Somewhat dissatisfied.",2,
                                     ifelse(indicator=="wellbeing" & label_choice == "Completely dissatisfied.",1,score)))))) 

temp_kpi_calc <- d %>% filter(indicator=="wellbeing") %>%
  mutate(score = as.numeric(score)) %>%
  group_by(kobo_farmer_id, country, indicator) %>%
  summarise(score = median(score,na.rm=TRUE)) %>%
  mutate(indicator = "kpi18_human_wellbeing",
           subindicator = "wellbeing_average")

kpi_scores <- kpi_scores %>% full_join(temp_kpi_calc, by = c("kobo_farmer_id", "country", "indicator", "subindicator", "score"), keep=NULL) %>%
  mutate(subindicator_label = ifelse(indicator=="kpi18_human_wellbeing","Perceived life satisfaction from 1 (Completely dissatisfied) to 5 (Completely satisfied)",subindicator_label)) %>%
  mutate(indicator_order = ifelse(indicator =="kpi18_human_wellbeing",18,indicator_order)) %>%
  mutate(module = ifelse(indicator == "kpi18_human_wellbeing","performance kpi",module)) %>%
    mutate(theme = ifelse(indicator %in% c("kpi18_human_wellbeing"),"social",theme)) 

kpi_histogram(kpi_scores,"kpi18_human_wellbeing")
kpi_all_boxplot(kpi_scores)

ggsave(paste0(global.data.path,"figures/kpi boxplots ",country,".tif"),width=12,height=12,units="in")

```


## Transfrom KPIs to unform 1 to 100 scale
```{r KPI scaling, include=TRUE, echo=FALSE}

#table(d$indicator)

# Make function to transform KPI scores from 0 to 100 scale
#indicators_scaled <- d[0,]
indicators_scaled <- data.frame(kobo_farmer_id=as.numeric(NA),
                      theme=as.character(NA),
                      indicator=as.character(NA),
                      indicator_order=as.numeric(NA),
                      subindicator = as.character(NA), 
                      subindicator_label = as.character(NA),
                      score=as.numeric(NA),
                      score_scaled=as.numeric(NA))
indicators_scaled <- indicators_scaled[-1,]

#data = kpi_scores
#ind="kpi11_hh_income_v_mean"
#method="set"
#min=0.5
#max=2 

indicator_scaling <- function(data, ind, method, min=NA,max=NA){
  data_subset <- data %>% filter(indicator %in% c(ind))
  # no scaling needed (e.g. scores in %)
  if(method =="none"){
  data_subset$score_scaled <- as.numeric(data_subset$score)
  }
  # scaling based on min and max values recorded in the survey
  if(method =="data_driven"){
  ind_min <- min(as.numeric(data_subset$score),na.rm=TRUE)
  ind_max <- max(as.numeric(data_subset$score),na.rm=TRUE)
  data_subset$score_scaled <- (data_subset$score - ind_min)/(ind_max - ind_min)*100
  }
  # inverse scaling based on min and max values recorded in the survey
  if(method =="data_driven_inverse"){
  ind_min <- min(as.numeric(data_subset$score),na.rm=TRUE)
  ind_max <- max(as.numeric(data_subset$score),na.rm=TRUE)
  data_subset$score_scaled <- 100 - ((data_subset$score - ind_min)/(ind_max - ind_min)*100)
  }
  # scaling based on pre-defined min and max values 
  if(method =="set"){
  ind_min <- as.numeric(min)
  ind_max <- as.numeric(max)
  data_subset <- data_subset %>% mutate(score = ifelse(score <= ind_min,ind_min,ifelse(score>=ind_max, ind_max, score)))
  data_subset$score_scaled <- (data_subset$score - ind_min)/(ind_max - ind_min)*100
  }
  data_subset <- data_subset %>% select(c("kobo_farmer_id","theme", "indicator","indicator_order","subindicator","subindicator_label", "score", "score_scaled"))
  indicators_scaled <- indicators_scaled %>% rbind(data_subset)
  assign("indicators_scaled",indicators_scaled,envir = globalenv())
  rm(data, ind, method, min,max)
}

indicator_scaling(kpi_scores, ind="kpi1_crop_health",method="none") 
indicator_scaling(kpi_scores, ind="kpi1b_crop_health_fieldwork",method="set", min=1,max=5)
indicator_scaling(kpi_scores, ind="kpi2_animal_health", method="set", min=1,max=5)
indicator_scaling(kpi_scores, ind="kpi3_soil_health",method="set",min=1,max=5)
indicator_scaling(kpi_scores, ind="kpi4_nutrient_use",method="set",min=0.5,max=2) 
indicator_scaling(kpi_scores, ind="kpi5a_animal_diversity", method="set",min=1,max=5)
indicator_scaling(kpi_scores, ind="kpi5b_tree_diversity", method="set",min=1,max=5)
indicator_scaling(kpi_scores, ind="kpi6a_abd_crop_richness_index", method="none") 
indicator_scaling(kpi_scores, ind="kpi6b_abd_variety_diversity", method="set" ,min=1,max=5) 
indicator_scaling(kpi_scores, ind="kpi7_landscape_complexity", method="set" ,min=1,max=5)
indicator_scaling(kpi_scores, ind="kpi8_climate_mitigation", method="set" ,min=1,max=5) 
indicator_scaling(kpi_scores, ind="kpi9_avoided_water_stress", method="none")
indicator_scaling(kpi_scores, ind="kpi10_energy_use", method="set" ,min=1,max=5) 
indicator_scaling(kpi_scores, ind="kpi11_hh_income_v_mean", method="set", min=0.5, max=2) 
indicator_scaling(kpi_scores, ind="kpi11b_hh_income_stability",method="set",min=1,max=5) 
indicator_scaling(kpi_scores, ind="kpi11c_hh_income_v_expenditures",method="set",min=0,max=1) 
indicator_scaling(kpi_scores, ind="kpi11d_hh_income_sufficiency",method="set",min=1,max=5) 
#indicator_scaling(data = d, ind="kpi12", method="none") # CHECK
#indicator_scaling(data = d, ind="kpi13", method="none") # CHECK
#indicator_scaling(data = d, ind="kpi14", method="none") # CHECK
indicator_scaling(kpi_scores, ind="kpi15_diet_diversity", method="set",min=0,max=10) 
indicator_scaling(kpi_scores, ind="kpi16_farmer_agency", method="set",min=1,max=5)
indicator_scaling(kpi_scores, ind="kpi17a_land_tenure", method="set",min=1,max=5)
indicator_scaling(kpi_scores, ind="kpi17b_land_tenure", method="none")
indicator_scaling(kpi_scores, ind="kpi18_human_wellbeing", method="set",min=1, max=5)

# Add scaled scores to main dataset
kpi_scores_final <- kpi_scores %>% left_join(indicators_scaled %>% select(-score))  %>%
  mutate(kpi_order = gsub("(.+?)(\\_.*)","\\1", indicator)) %>%
  mutate(kpi_label= paste0(gsub("(.+?)(\\_.*)","\\1", indicator),": ",subindicator_label)) %>%
     mutate(kpi_label_short = case_when(
       indicator %in% c("kpi1_crop_health") ~ "kpi1a crop health (% loss)",
       indicator %in% c("kpi1b_crop_health_fieldwork") ~ "kpi1b crop health (SOCLA)",
       indicator %in% c("kpi2_animal_health") ~ "kpi2 animal health (qual)",
       indicator %in% c("kpi3_soil_health" ) ~ "kpi3 soil health (qual)",
       indicator %in% c("kpi4_nutrient_use" ) ~ "kpi4 nutrient use (versus average)",
       indicator %in% c("kpi5a_animal_diversity" ) ~ "kpi5a animal diversity (qual)",
       indicator %in% c("kpi5b_tree_diversity" ) ~ "kpi5b tree diversity (qual)",
       indicator %in% c("kpi6a_abd_crop_richness_gap" ) ~ "kpi6a crop richness (versus max)",
        indicator %in% c("kpi6b_abd_variety_diversity" ) ~ "kpi6b varietal diversity (qual)",
        indicator %in% c("kpi7_landscape_complexity" ) ~ "kpi7 landscape complexity (%)",
        indicator %in% c("kpi8_climate_mitigation" ) ~ "kpi8 climate mitigation (qual)",
        indicator %in% c("kpi9_avoided_water_stress" ) ~ "kpi9 avoided ag water stress (% months)",
        indicator %in% c("kpi10_energy_use" ) ~ "kpi10 energy sustainability (qual)",
        indicator %in% c("kpi11_hh_income_v_mean" ) ~ "kpi11a HH income (versus average)",
       indicator %in% c("kpi11b_hh_income_stability" ) ~ "kpi11b HH income stability (qual)",
       indicator %in% c("kpi11c_hh_income_v_expenditures" ) ~ "kpi11c HH income versus expenditures (binary)",
       indicator %in% c("kpi11d_hh_income_sufficiency" ) ~ "kpi11d HH income sufficiency (qual)",
        indicator %in% c("kpi15_diet_diversity" ) ~ "kpi15 diet diversity (MFGD)",
        indicator %in% c("kpi16_farmer_agency" ) ~ "kpi16 farmer agency (qual)",
        indicator %in% c("kpi17a_land_tenure" ) ~ "kpi17a land security (qual)",
        indicator %in% c("kpi17b_land_tenure" ) ~ "kpi17b land security (% owned)",
        indicator %in% c("kpi18_human_wellbeing" ) ~ "kpi18 human wellbeing (qual)", .default=indicator))  %>%
     mutate(kpi_label = factor(kpi_label, levels=unique(kpi_label[order(indicator_order)]))) %>%
  select(c("kobo_farmer_id","country","module", "theme", "indicator","indicator_order","kpi_order", "kpi_label","kpi_label_short", "subindicator","subindicator_label", "score", "score_scaled")) %>% 
  filter(!is.na(module))

# Save data for re-use in next script
export_kpi_scores <- function(country){
  if(country == "burkina"){
    write.csv(d,paste0(bfa.data.path,"bfa_data.csv"),row.names=FALSE)
    write.csv(kpi_scores_final,paste0(bfa.data.path,"bfa_kpi_scores.csv"),row.names=FALSE) }
  if(country=="india"){
    write.csv(d,paste0(ind.data.path,"ind_data.csv"),row.names=FALSE)
    write.csv(kpi_scores_final,paste0(ind.data.path,"ind_kpi_scores.csv"),row.names=FALSE)}
  if(country=="laos"){
    write.csv(d,paste0(lao.data.path,"lao_data.csv"),row.names=FALSE)
    write.csv(kpi_scores_final,paste0(lao.data.path,"lao_kpi_scores.csv"),row.names=FALSE)}
  if(country=="kenya"){
    write.csv(d,paste0(ken.data.path,"ken_data.csv"),row.names=FALSE)
    write.csv(kpi_scores_final,paste0(ken.data.path,"ken_kpi_scores.csv"),row.names=FALSE)}
  if(country=="peru"){
    write.csv(d,paste0(per.data.path,"per_data.csv"),row.names=FALSE)
    write.csv(kpi_scores_final,paste0(per.data.path,"per_kpi_scores.csv"),row.names=FALSE)}
  if(country=="senegal"){
    write.csv(d,paste0(sen.data.path,"sen_data.csv"),row.names=FALSE)
    write.csv(kpi_scores_final,paste0(sen.data.path,"sen_kpi_scores.csv"),row.names=FALSE)  }
  if(country=="tunisia"){
    write.csv(d,paste0(tun.data.path,"tun_data.csv"),row.names=FALSE)
    write.csv(kpi_scores_final,paste0(tun.data.path,"tun_kpi_scores.csv"),row.names=FALSE)
  }
  if(country == "zimbabwe"){
    write.csv(d,paste0(zwe.data.path,"zwe_data.csv"),row.names=FALSE)
    write.csv(kpi_scores_final,paste0(zwe.data.path,"zwe_kpi_scores.csv"),row.names=FALSE)
  }
}

export_kpi_scores(country)

# Gauge plots showing scaled indicator scores
kpi_all_gauge(kpi_scores_final)
#ggsave(paste0(global.data.path,"figures/kpi_scaled_gauge_plots_",country,".tif"),width=7,height=12,units="in")

# Bar chart with errorbars with scaled indicator scores
kpi_all_barchart(kpi_scores_final)
ggsave(paste0(global.data.path,"figures/kpi_scaled_barplot_",country,".tif"),width=7,height=5.5,units="in")

```

