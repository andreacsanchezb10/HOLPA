---
title: "HOLPA farm-household performance predictor analysis"
output:word_document
date: "2024-12-11"
author: "Sarah Jones (s.jones@cgiar.org)"
editor_options:
  chunk_output_type: console
---
## Specify settings to use for data analysis

In this section, the user needs to specify where the HOLPA indicator data are stored on their computer. 

```{r set user parameters, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr) # for piping
library(tidyverse) #for formatting data
library(ggplot2) # for plots
library(readr) 
library(reshape2) # for changing data layout
library(stringr) # for wrapping text
library(readxl) # for reading and writing excel files
library(ggsci) # ggplot colours for scientific journals
library(ggforce) # for gauge plots
library(lme4) # for linear modelling
library(GGally)
library(ggcorrplot)
library(corrgram)
library(ellipse) # correlograms
library(RColorBrewer)
library(corrplot) # correlograms
library(ggpmisc)
library(ggpubr) # scatterplots

### Set parameters ####

global.data.path <- "C:/Users/sjones/OneDrive - CGIAR/Documents/HOLPA/"

bfa.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Burkina_Faso/burkina_faso_data_clean/bfa/"
ind.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/India/india_data_clean/ind/"
ken.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Kenya/kenya_data_clean/ken/"
lao.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Laos/laos_data_clean/lao/"
per.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Peru/peru_data_clean/per/"
sen.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Senegal/senegal_data_clean/sen/"
tun.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Tunisia/tunisia_data_clean/tun/"
zwe.data.path <- "C:/Users/sjones/CGIAR/Sanchez, Andrea Cecilia (Alliance Bioversity-CIAT) - HOLPA_data/Zimbabwe/zimbabwe_data_clean/zwe/"

# plotting colours
col.ae.class <- c("Not AE"="navy", "Weak AE" = "purple","Moderate AE" = "gold","Strong AE" = "green3","Very strong AE" = "forestgreen")

col.theme <- c("agricultural"="#305127", "environmental"= "#699E5C", "social" = "#511F47" , "economic"= "#B36971")

col.ae.principle = c("lightyellow","yellow","gold", "yellow3","tan", "orange","orange3","brown3", "brown","violet", "purple","purple4","navy")
col.ae.principle = c("darkgreen", "forestgreen","green3","lightgreen", "lightblue","steelblue","navy", "grey90","grey80","grey70","grey60","grey50","grey40" )

col.country = c("yellow","tan", "orange", "brown","violet", "purple","steelblue")
col.country = c("yellow","gold", "orange", "brown","grey80" , "grey50","grey20")

```

## Import data

Run this chunk to import the relevant HOLPA datasets.

```{r}
#### Import data ####

import.data <- function(country_short,country.data.path, scores_date){
  d <- read_csv(paste0(country.data.path,country_short,"_data.csv"),show_col_types = FALSE)
  kpi_scores <- read_csv(paste0(country.data.path,country_short,"_kpi_scores_" , scores_date, ".csv"),show_col_types = FALSE) %>%
    # fill in missing country and theme data
    fill(country, .direction ="down") %>%
    fill(theme, .direction ="down") 
  assign(paste0(country_short,"_d"),d,envir=.GlobalEnv)
  assign(paste0(country_short,"_kpi_scores"),kpi_scores,envir=.GlobalEnv)
}

import.data("bfa",bfa.data.path, "20241211")
#import.data("ind",ind.data.path)
import.data("ken",ken.data.path, "20241211")
import.data("lao",lao.data.path, "20241211")
import.data("per",per.data.path, "20241211")
import.data("sen",sen.data.path, "20241211")
import.data("tun",tun.data.path, "20241211")
import.data("zwe",zwe.data.path, "20241211")
  
d <- rbind(bfa_d, ken_d, lao_d, per_d, sen_d, tun_d, zwe_d)
#d <- rbind( ken_d, sen_d)

kpi_scores <- rbind(bfa_kpi_scores, ken_kpi_scores, lao_kpi_scores, per_kpi_scores, sen_kpi_scores, tun_kpi_scores, zwe_kpi_scores)
#kpi_scores <- rbind(ken_kpi_scores,  sen_kpi_scores)

rm(list=ls(pattern="bfa_*"))
#rm(list=ls(pattern="ind_*"))
rm(list=ls(pattern="ken_*"))
rm(list=ls(pattern="lao_*"))
rm(list=ls(pattern="per_*"))
rm(list=ls(pattern="sen_*"))
rm(list=ls(pattern="tun_*"))
rm(list=ls(pattern="zwe_*"))

```

## Extract and append context indicators of interest 

HOLPA collects data on multiple context, agroecology, and performance themes. For the context module, there are several indicators per theme and several measurements per indicator. We need to separate and name the indicators and measurements to include them into the analysis.

```{r context variables, include=TRUE, echo=FALSE}

####-------------- Select and format required context variables -----------####

cn_info <- d %>% filter(module=="context") %>%
  select(kobo_farmer_id, country, module, theme, indicator, indicator_order, subindicator, subindicator_label, name_question,name_question_recla, label_question, name_choice,label_choice, type, score ) %>% 
  filter(!(subindicator %in% c( "accessibility","consent",  "income", "income_stability", "income_sufficiency", "income_versus_expenditures","inputs", "nut_chem_area","nut_org_area","nut_orgF_area","nut_chem_quantity","nut_org_quantity","nut_orgF_quantity","nut_chem_unit","nut_org_unit","nut_orgF_unit","photo","practice_3")))

cn_info <- cn_info %>%
  mutate(score_cn_text = case_when(type %in% c("text")~name_choice,
                                   grepl("select_one*",type)~label_choice,
                                   grepl("select_multiple*",type)~label_choice, .default=NA)) %>%
  mutate(score_cn_num = case_when(type %in% c("integer", "decimal", "geopoint")~name_choice,.default=NA)) 

### Climate change perceptions ###

temp_cn_var_calc <- cn_info %>% filter(subindicator =="climate_rainfall_timing")# %>% filter(!is.na(name_choice)) %>%
  mutate(subindicator = gsub("\\_.*", "\\1", name_choice),
         score = as.numeric(gsub(".*_(*)", "\\1", name_choice)),
         label_question = gsub("^([^_]*_[^_]*_[^_]*)_.*$","\\1",name_question)) %>%
         #label_question = gsub(".*_.*_(.*)$","\\1",name_question)) %>%
  mutate(subindicator = ifelse(subindicator == "apperance","appearance",subindicator )) %>% unique() %>%
  dcast(kobo_farmer_id+country+label_question~subindicator,value.var="score",fun=median) 
  
cn_info <- cn_info %>%
  mutate(subindicator = case_when(subindicator =="climate_rainfall_timing" ~ paste0(subindicator,"_",name_choice),
                                  subindicator =="education" ~ paste0(subindicator,"_",name_choice),
                                  
                                  subindicator %in% c("structure") & grepl("How many Male adults of working age",label_question) ~ "hh_structure_male_working_age",
                                  subindicator %in% c("structure") & grepl("How many Female adults of working age",label_question) ~ "hh_structure_female_working_age",
                                  subindicator %in% c("structure") & grepl("How many Male adults not of working age",label_question) ~ "hh_structure_male_not_working_age",
                                  subindicator %in% c("structure") & grepl("How many Female adults not of working age",label_question) ~ "hh_structure_female_not_working_age",
                                  subindicator %in% c("structure") & grepl("How many Male children",label_question) ~ "hh_structure_male_children",
                                  subindicator %in% c("structure") & grepl("How many Female children",label_question) ~ "hh_structure_female_children",
                                  
                                  subindicator %in% c("household_labour") & name_question_recla %in% c("_3_4_1_1_1_1")~"hh_labour_male_adult_permanent",
                                  subindicator %in% c("household_labour") & name_question_recla %in% c("_3_4_1_1_1_2")~"hh_labour_male_adult_seasonal",
                                  subindicator %in% c("household_labour") & name_question_recla %in% c("_3_4_1_1_2_1")~"hh_labour_female_adult_permanent",
                                  subindicator %in% c("household_labour") & name_question_recla %in% c("_3_4_1_1_2_2")~"hh_labour_female_adult_seasonal",
                                  subindicator %in% c("household_labour") & name_question_recla %in% c("_3_4_1_1_5_1")~"hh_labour_male_child_permanent",
                                  subindicator %in% c("household_labour") & name_question_recla %in% c("_3_4_1_1_5_2")~"hh_labour_male_child_seasonal",
                                  subindicator %in% c("household_labour") & name_question_recla %in% c("_3_4_1_2_1")~"hh_labour_hired",
                                  subindicator %in% c("household_labour") & name_question_recla %in% c("_3_4_1_2_1_2")~paste0("hh_labour_hired_groups",name_choice),
                                  
                                  subindicator %in% c("housing") & name_question_recla %in% c("_3_2_1_3_1")~"hh_roof",
                                          subindicator %in% c("housing") & name_question_recla %in% c("_3_2_1_3_2")~"hh_walls",
                                  subindicator %in% c("location") & grepl("COUNTRY",label_question)~"country",
                                  subindicator %in% c("location") & grepl("DISTRICT",label_question)~"district",
                                  subindicator %in% c("location") & grepl("VILLAGE",label_question)~"village",
                                  subindicator %in% c("location") & grepl("GPS",label_question)~"gps",
                                  
                                  subindicator %in% c("name") & grepl("first name",label_question)~"respondent_first_name",
                                  subindicator %in% c("name") & grepl("last name",label_question)~"respondent_last_name",
                                  
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_1_1_1" ~"motivations_personal_nature_care",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_1_1_10" ~"motivations_personal_worker_conditions",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_1_1_2" ~"motivations_personal_nature_benefits",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_1_1_4" ~"motivations_personal_land_care",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_1_1_5" ~"motivations_personal_agroecological_farmer",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_1_1_6" ~"motivations_personal_farm_agency",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_1_1_7" ~"motivations_personal_system_agency",
                                   subindicator %in% c("personal_factors") & name_question_recla =="_1_3_2_1_3" ~"motivations_personal_business_sense",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_2_1_5" ~"motivations_personal_food_price",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_2_1_6" ~"motivations_personal_food_no_chem_pref",
                                  subindicator %in% c("personal_factors") & name_question_recla =="_1_3_2_1_7" ~"motivations_personal_food_local",
                                  subindicator %in% c("societal_factor") & name_question_recla =="_1_3_1_1_3" ~"motivations_societal_land_care",
                                  subindicator %in% c("societal_factor") & name_question_recla =="_1_3_2_1_4" ~"motivations_societal_system_working_well",
                                  
                                  subindicator %in% c("production_end_use") & name_question_recla =="_1_4_2_2_1" ~"production_end_use_hh_consumption",
                                  subindicator %in% c("production_end_use") & name_question_recla =="_1_4_2_2_2" ~"production_end_use_hh_livestock_consumption",
                                  subindicator %in% c("production_end_use") & name_question_recla =="_1_4_2_2_3" ~"production_end_use_sales",
                                  subindicator %in% c("production_end_use") & name_question_recla =="_1_4_2_2_4" ~"production_end_use_gifts",
                                  subindicator %in% c("production_end_use") & name_question_recla =="_1_4_2_2_5" ~"production_end_use_waste_loss",
                                  subindicator %in% c("production_end_use") & name_question_recla =="_1_4_2_2_6" ~"production_end_use_other",
                          subindicator %in% c("production_systems") & name_question_recla =="_4_1_7_1" ~"production_system_slope",
                          subindicator %in% c("production_systems") & name_question_recla =="_3_3_4_1" ~"production_system_irrigation",
                          subindicator %in% c("production_systems") & name_question_recla =="_1_4_2_1" ~"production_system_produce",
                          
                           subindicator %in% c("training") & name_question_recla =="_4_1_1_4_1" ~"training_best_practices",
                          subindicator %in% c("training") & name_question_recla =="_4_1_1_4_3" ~"training_agribusiness",
                          subindicator %in% c("training") & name_question_recla =="_4_1_1_4_4" ~"training_other",
                                  .default=subindicator))

unique(cn_info$label_question)
unique(cn_info$subindicator)
  
temp <- cn_info_text %>% filter( subindicator_count>1) %>% select(subindicator,label_question,name_question) %>% unique()
sort(unique(cn_info$subindicator))

cn_info_text <- cn_info %>%
  filter(!is.na(score_cn_text)) %>% filter(!is.na(name_question_recla)) %>%
  group_by(kobo_farmer_id,subindicator) %>%
  mutate(subindicator_count = n()) %>% ungroup() %>%
  mutate(subindicator = ifelse(subindicator_count >1,paste0(subindicator,"_",name_choice),subindicator)) %>%
  dcast(kobo_farmer_id+country~subindicator,value.var="score_cn_text")

# I NEED TO CONTINUE IMPROVING CODE HERE ####

#### Access to markets and more ####
# This is a select one question
#temp <- d[d$indicator =="accessibility",] 
#sort(unique(temp$label_question))

#### Age community ####
#temp <- d[d$indicator =="age_community",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "For how many years have you lived in this community?","Time_in_community",subindicator)) %>%
  mutate(score = ifelse(subindicator=="Time_in_community",as.numeric(name_choice),score))

#### Age DOB ####
#temp <- d[d$indicator =="age_dob",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Year of birth","Age_years",subindicator)) %>%
  mutate(score = ifelse(subindicator=="Age_years",as.numeric(name_choice),score))

#### Agroecology understanding ####
#temp <- d_cn[d_cn$indicator =="agroecology_knowledge",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Do you know what Agroecology means?","Ae_understanding",subindicator)) %>%
  mutate(subindicator_label = ifelse(name_choice=="0" & subindicator == "Ae_understanding","No",
                                     ifelse(name_choice=="1" & subindicator == "Ae_understanding","Some",
                                            ifelse(name_choice=="2" & subindicator == "Ae_understanding","Yes",subindicator_label)))) %>%
    mutate(score = ifelse(subindicator=="Ae_understanding",as.numeric(name_choice), score)) 

#### Insurance against losses ####
#temp <- d[d$indicator =="climate_resilience",] 
d <- d %>%
  mutate(subindicator = ifelse(label_question == "Do you have insurance against agricultural losses?","Insurance_ag_losses",subindicator)) %>%
  mutate(subindicator= ifelse(label_question=="What is covered, e.g. losses to crops/livestock/buildings from weather events, pest outbreaks, market shocks?","Insurance_ag_losses_detail",subindicator)) %>%
  mutate(subindicator_label = ifelse(name_choice=="0" & subindicator == "Insurance_ag_losses","No",
                                     ifelse(name_choice=="1" & subindicator == "Insurance_ag_losses","Some",
                                            ifelse(name_choice=="2" & subindicator == "Insurance_ag_losses","Yes",subindicator_label)))) %>%
    mutate(score = ifelse(subindicator=="Insurance_ag_losses",as.numeric(name_choice),score))
           
#### CONTINUE HERE to sort context variables as needed ####
# credit_access
# education
# literacy
# gender
# household_labour
# income (this is a performance indicator too)
# training
# membership
# personal_factors
# societal_factor
# climate_rainfall_change
# climate_temp


```

# Compare kpi scores across households in different contexts and different levels of agroecology adherence
```{r kpi comparisons across content and ae, include=TRUE, echo=FALSE}

# Merge kpi with cn and ae datasets in wide format for visualisation
ae_scores <- d %>%
  filter(module == "agroecology" & !is.na(score)) %>% 
  filter(!(indicator %in% c("biodiversity_agrobiodiversity"))) %>%
  group_by(kobo_farmer_id,country,module, indicator, indicator_order) %>%
  summarise(score = median(score,na.rm=TRUE),
            score_mean = mean(score,na.rm=TRUE),
            score_sum = sum(score,na.rm=TRUE),
            score_count = n(),.groups="keep") 

#sort(unique(ae_scores$indicator))

ae_calc_temp <- ae_scores %>%
  group_by(kobo_farmer_id,country,module) %>%
  summarise(score = median(score,na.rm=TRUE),
            score_mean = mean(score,na.rm=TRUE),
            score_sum = sum(score,na.rm=TRUE),
            score_count = n(),.groups="keep") %>%
  mutate(indicator = "score_ae_overall",
         indicator_order=14)

ae_scores<- ae_scores %>% full_join(ae_calc_temp)

ae_scores <-   ae_scores %>% mutate(indicator_label = case_when(indicator=="score_ae_overall"~"Overall score", 
                                     grepl("13_*", indicator)~"13.Participation",
                                     grepl("12_*",indicator)~"12.Governance",
                                     grepl("11_*",indicator)~"11.Connectivity",
                                     grepl("10_*",indicator)~"10.Fairness",
                                     grepl("9_*",indicator)~"9.Social\nvalues",
                                     grepl("8_*",indicator)~"8.Knowledge",
                                     grepl("7_*",indicator)~"7.Economic\ndiversification",
                                     grepl("6_*",indicator)~"6.Synergy",
                                     grepl("5_*",indicator)~"5.Biodiversity",
                                     grepl("4_*",indicator)~"4.Animal\nhealth",
                                     grepl("1_*", indicator)~"1.Recycling",
                                     grepl("2_*",indicator)~"2.Input\nreduction",
                                     grepl("3_*",indicator)~"3.Soil\nhealth",
                                     .default=indicator)) 

ae_scores_cn <- ae_scores %>% full_join(cn_info_text)

ae_scores_wide <- ae_scores %>%
  filter(!is.na(score)) %>%
  dcast(kobo_farmer_id+country~indicator,value.var="score")

kpi_scores_full <- kpi_scores %>% full_join(cn_info_text) %>% full_join(ae_scores_wide) 
  
# Make figures of ae and kpi scores split by village, district and other context variables

country = "kenya" # change this to view results for other countries

indicator_levels <- ae_scores %>% ungroup() %>%
  distinct(indicator_label, indicator_order) %>% unique() %>%
  arrange(indicator_order) %>%
  pull(indicator_label)

ae_scores_nat <- filter(ae_scores, .data$country == !!country) %>%
  arrange(indicator_order) %>%
  mutate(indicator_order = as.numeric(indicator_order)) %>%
  mutate(indicator_label = factor(indicator_label, levels=indicator_levels))
n_kobo_id <- ae_scores_nat %>% ungroup() %>% summarise(n = n_distinct(kobo_farmer_id)) %>% pull(n)

g_ken <- ae_scores_nat %>%
  ggplot(aes(y=score, x=indicator_label))+
  geom_boxplot(aes(fill=indicator_label))+
  ggtitle(paste0("Agroecology scores for ",country,"\n(n=",n_kobo_id,")")) + 
  labs(x="")+ 
  scale_fill_manual(values=c(terrain.colors(13),"purple"),name="")+
  #facet_wrap(~District)+
  theme_bw()+ 
  theme(plot.title=element_text(hjust=0.5),
        #axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())#+theme(legend.position="none")
g_ken

ggsave(paste0(global.data.path,"figures/1_agroecology_scores_",country,".tif"),width=7,height=4,units="in")

country = "senegal" 
ae_scores_nat <- filter(ae_scores, .data$country == !!country)
n_kobo_id <- ae_scores_nat %>% ungroup() %>% summarise(n = n_distinct(kobo_farmer_id)) %>% pull(n)

g_sen <-  ae_scores_nat %>%
  mutate(indicator_label = factor(indicator_label,levels=indicator_levels)) %>%
  ggplot(aes(y=score, x=indicator_label))+ 
  geom_boxplot(aes(fill=indicator_label))+ 
  ggtitle(paste0("Agroecology scores for ", country,"\n(n=",n_kobo_id ,")")) +
  labs(x="")+ 
  scale_fill_manual(values=c(terrain.colors(13),"purple"),name="")+
  theme_bw()+ 
  theme(plot.title=element_text(hjust=0.5),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())#+theme(legend.position="none")
g_sen

ggsave(paste0(global.data.path,"figures/1_agroecology_scores_",country,".tif"),width=7,height=4,units="in")

plot_legend <-ae_scores %>%
  mutate(indicator_label = factor(indicator_label,levels=indicator_levels)) %>%
  ggplot(aes(y=score, x=indicator_label))+ 
  geom_boxplot(aes(fill=indicator_label))+
  scale_fill_manual(values=c(terrain.colors(13),"purple"),name="")+
   theme_void() + 
  theme(legend.position = "right")

plot_legend <- get_legend(plot_legend)
plot_grid(plot_legend)

ggsave(paste0(global.data.path,"figures/1_agroecology_scores_plot_legend.tif"),width=2,height=4,units="in")

#### ----------Compare kpi scores across HH with different AE adherence ----------#### 

kpi_scores_full <- kpi_scores_full  %>%
  mutate(score_ae_overall_classes = case_when(score_ae_overall<=1~"Not AE",
                                              score_ae_overall<=2~"Weak AE",
                                              score_ae_overall<=3~"Moderate AE",
                                              score_ae_overall<=4~"Strong AE",
                                              score_ae_overall<=5~"Very strong AE",
                                              .default="Check")) 

landscape_kpi_scores_full <- kpi_scores_full %>%
     #filter(!is.na(theme)) %>%
     group_by(country,theme,indicator,indicator_order,kpi_label,kpi_label_short, score_ae_overall, score_ae_overall_classes) %>%
     summarise(kpi_score_scaled_mean = mean(score_scaled,na.rm=TRUE),
               kpi_score_scaled_sd = sd(score_scaled,na.rm=TRUE),
               kpi_score_scaled_med = median(score_scaled,na.rm=TRUE),
               n = n()) %>%
     arrange(indicator_order) %>%
     mutate(indicator = factor(indicator, levels = unique(indicator[order(as.numeric(indicator_order))])),
            score_ae_overall_classes = factor(score_ae_overall_classes, levels = c("Not AE","Weak AE","Moderate AE","Strong AE", "Very strong AE")))

####--------- Cluster households by context ---------------------#####

library(cluster)
library(FactoMineR)
library(factoextra)


### Factorial Analysis of Mixed Data (FAMD) + HCPC

names(kpi_scores_full[,c(1,2,15:50)])


d_clust <- kpi_scores_full[,c(1,2,15:461)] %>% unique()
d_clust <- na.omit(d_clust)

famd_d <- FAMD(d_clust, graph = FALSE)

# Hierarchical clustering on principal components
hcpc_d <- HCPC(famd_d, nb.clust = 4)

# View clusters
hcpc_d$data.clust$clust

# Plot individuals with clusters on FAMD dimensions
plot(hcpc_d, choice = "map")  # Individuals with cluster colors

# Plot with clusters on FAMD dimensions 1 & 2
fviz_cluster(hcpc_d, geom = "point", repel = TRUE)+theme_bw()

#to see which variables explain the axes:
fviz_famd_var(famd_res, repel = TRUE)

# For Dimension 1
fviz_contrib(famd_res, "var", axes = 1, top = 10)

# For Dimension 2
fviz_contrib(famd_res, "var", axes = 2, top = 10)

# View summary of cluster description
print(hcpc_res$desc.var)

# Plot categories contributing to clusters
plot(hcpc_res, choice = "bar")  # Barplot of significant variables by cluster

# Individuals + Variables Biplot
fviz_famd_biplot(famd_res, repel = TRUE, habillage = hcpc_res$data.clust$clust)

# Scree plot to check if variance is spread across many dimensions 
# Often with mixed data, you need 5–10 dimensions to capture meaningful variance
fviz_screeplot(famd_res)

### Methods to select fewer variables for use in clustering
library(ClustOfVar)

# For mixed data, automatic clustering of variables
tree <- hclustvar(X.quali = data[, quali_vars], X.quanti = data[, quanti_vars])

# Plot dendrogram of variables
plot(tree)

# Select variables (e.g., top 10 clusters)
stab <- stability(tree, B = 50)
cutreevar(tree, k = 10)$var

####------------------ HOUSEHOLD LEVEL---------------------------#####

ggplot(kpi_scores_full %>% filter(!is.na(score_scaled) & !is.na(score_ae_overall_classes)), aes(y=score_scaled,x=score_ae_overall))+
    geom_point(alpha=0.7, size=3) +
  geom_smooth(method = "lm", se=FALSE, show.legend=FALSE)+
    #ggtitle(paste0("KPIs for ",country))+
    labs(y="KPI score (scaled from 0-100)", 
         x="AE score (from 1 to 5)")+
    coord_cartesian(expand=c(0),clip="off")+
  scale_x_continuous(breaks=seq(1,5,1),limits=c(1,5))+  
  scale_y_continuous(breaks=seq(0,100,20),limits=c(0,110))+
    #scale_fill_manual(values=col.ae.class)+ #terrain.colors(5))+
    #scale_colour_manual(values=col.ae.class)+#terrain.colors(5))+
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          legend.position="bottom",
          legend.title=element_blank())+
  facet_wrap(~factor(kpi_label_short,levels=unique(kpi_label_short[order(indicator_order)])))


#plot_scatter("kpi5b_tree_diversity", "Tree diversity (from 1 to 5)")
#ind = "kpi5b_tree_diversity"
#label ="Tree diversity (from 1 to 5)"

plot_scatter <- function(ind, label){
  plot_data <- kpi_scores_full %>% filter(indicator == ind & !is.na(score_ae_overall))
  
   g <- ggscatter(plot_data ,aes(y=score_scaled,x=score_ae_overall))+
    geom_point(alpha=0.7, size=3) +
  geom_smooth(method = "lm", se=FALSE, show.legend=FALSE)+
     labs(y= paste0(label, " (scaled from 0-100)"), 
         x="AE score (from 1 to 5)")+
    coord_cartesian(expand=c(0),clip="off")+
  scale_x_continuous(breaks=seq(1,5,1),limits=c(1,5))+  
  scale_y_continuous(breaks=seq(0,100,20),limits=c(0,110))+
    #scale_fill_manual(values=col.ae.class)+ #terrain.colors(5))+
    #scale_colour_manual(values=col.ae.class)+#terrain.colors(5))+
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          legend.position="bottom",
          legend.title=element_blank())
  print(g)
}

plot_scatter <- function(ind, label){
  plot_data <- kpi_scores_full %>% filter(indicator ==ind & !is.na(score_ae_overall))
  
   g <- ggscatter(plot_data ,x="score_ae_overall", y="score_scaled", add="reg.line")
  #labs(y=paste0(label), 
  #       x="AE score (from 1 to 5)")#+stat_cor(method="pearson",label.x-3,label.y=30
  print(g)
}

ggplot(kpi_scores_full %>% filter( indicator =="kpi5b_tree_diversity"), aes(y=score,x=score_ae_overall))+
    geom_point(alpha=0.7, size=3) +
  geom_smooth(method = "lm", se=FALSE, show.legend=FALSE)+
  stat_poly_eq(
    aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")),
    formula = y ~ x,
    parse = TRUE
  ) +
    #ggtitle(paste0("KPIs for ",country))+
    labs(y="Tree diversity (from 1 to 5)", 
         x="AE score (from 1 to 5)")+
    coord_cartesian(expand=c(0),clip="off")+
  scale_x_continuous(breaks=seq(1,5,1),limits=c(1,5))+  
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          legend.position="bottom",
          legend.title=element_blank())

ggplot(kpi_scores_full %>% filter( indicator =="kpi16_farmer_agency"), aes(y=score,x=score_ae_overall))+
    geom_point(alpha=0.7, size=3) +
  geom_smooth(method = "lm", se=FALSE, show.legend=FALSE)+
  stat_poly_eq(
    aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")),
    formula = y ~ x,
    parse = TRUE
  ) +
    #ggtitle(paste0("KPIs for ",country))+
    labs(y="Farmer agency (from 1 to 5)", 
         x="AE score (from 1 to 5)")+
    coord_cartesian(expand=c(0),clip="off")+
  scale_x_continuous(breaks=seq(1,5,1),limits=c(1,5))+  
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          legend.position="bottom",
          legend.title=element_blank())

ggplot(kpi_scores_full %>% filter( indicator =="kpi8_climate_mitigation"), aes(y=score,x=score_ae_overall))+
    geom_point(alpha=0.7, size=3) +
  geom_smooth(method = "lm", se=FALSE, show.legend=FALSE)+
  stat_poly_eq(
    aes(label = paste(after_stat(eq.label), after_stat(rr.label), sep = "~~~")),
    formula = y ~ x,
    parse = TRUE
  ) +
    #ggtitle(paste0("KPIs for ",country))+
    labs(y="Climate mitigation (from 1 to 5)", 
         x="AE score (from 1 to 5)")+
    coord_cartesian(expand=c(0),clip="off")+
  scale_x_continuous(breaks=seq(1,5,1),limits=c(1,5))+  
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          legend.position="bottom",
          legend.title=element_blank())

plot_violin <- function(ind, label){
  plot_data <- kpi_scores_full %>% filter(indicator == ind & !is.na(score_ae_overall))
  
   g <- ggplot(plot_data , aes(y=score,x=factor(score_ae_overall_classes,levels=c("Not AE"  , "Weak AE","Moderate AE", "Strong AE", "Very strong AE")),fill=factor(score_ae_overall_classes,levels=c("Not AE"  , "Weak AE","Moderate AE", "Strong AE", "Very strong AE"))))+
  geom_violin(show.legend=FALSE) +
  labs(y=paste0(label), 
         x="AE score (from 1 to 5)")+
  scale_fill_manual(values=col.ae.class)+
    coord_cartesian(expand=c(0),clip="off")+
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          legend.position="bottom",
          legend.title=element_blank())
  print(g)
}

plot_violin("kpi5b_tree_diversity", "Tree diversity (from 1 to 5)")
plot_violin("kpi8_climate_mitigation", "Climate mitigation (from 1 to 5)")
plot_violin("kpi14a_climate_resilience", "Climate resilience (from 0 to 20)")
plot_violin("kpi12_yield_gap", "Yield gap (%)")
plot_violin("kpi16_farmer_agency", "Farmer agency (from 1 to 5)")
plot_violin("kpi18_human_wellbeing", "Human wellbeing (from 1 to 5)")

#### Boxplot of agroecology scores ####

g <- ggplot(ae_scores %>% filter(indicator=="score_ae_overall"), aes(y=score,x=country,fill=country))+
    geom_boxplot(notch=FALSE,staplewidth=0.1, show.legend=FALSE) +
  labs(y="Overall AE score (from 1 to 5)", 
         x="")+
  scale_fill_manual(values=col.country)+
  coord_cartesian(expand=c(0),clip="off")+
  theme_classic()+ 
  theme(plot.title = element_text(hjust=0.5),
          axis.text=element_text(size=10,colour="black"),
          legend.position="bottom",
          legend.title=element_blank())
g

tiff(paste0(global.data.path,"figures/ae_boxplot_global.png"),width=6,height=3.5,units="in", res=300)
g
dev.off()

#### Spider or bar chart showing ae scores per principle ####

ae_scores_country <-  ae_scores %>% 
  filter(!indicator == "score_ae_overall") %>%
  group_by(country,indicator,indicator_label,indicator_order) %>% 
  summarise(score = mean(score,na.rm=TRUE)) %>%
  ungroup() %>%
  rbind(ae_scores %>% filter(!indicator=="score_ae_overall") %>%
              group_by(indicator,indicator_label,indicator_order) %>%
              summarise(score = mean(score,na.rm=TRUE)) %>%
              ungroup() %>%
              mutate(country="All")) %>%
    mutate(indicator_label = factor(indicator_label,levels=unique(indicator_label[order(indicator_order)]))) %>%
  mutate(indicator = factor(indicator,levels=unique(indicator[order(indicator_order)])))
  
g <- ggplot(ae_scores_country %>% filter(!(country=="All")), aes(y=score,x=indicator_label,fill=country,group=country,colour=country))+
  geom_point(size=3,alpha=0.7,show.legend=FALSE)+
  geom_line(linejoin="mitre",linewidth=1,alpha=0.7) + 
  labs(y="",  x="")+
  coord_radial(clip="off",start=0,end=2*pi, expand=TRUE, r.axis.inside=TRUE,inner.radius=0.1)+
  scale_fill_manual(values=col.country)+
  scale_colour_manual(values=col.country)+
  scale_y_continuous(limits=c(1,5),breaks=seq(1,5,1))+
    theme_minimal()+ 
    theme(plot.title = element_text(hjust=0.5),
          axis.text=element_text(size=10,colour="black"),
          #axis.text.y=element_blank(),
          legend.text=element_text(size=10,colour="black"),
          legend.position="none", legend.location="plot",
          #legend.box.spacing=(unit(2,"cm")),
          #plot.margin=(unit(c(0.5,0.5,0.5,1.5),"cm")),
          legend.title=element_blank())
g

tiff(paste0(global.data.path,"figures/ae_spider_diagram_global.png"),width=5.5,height=5,units="in", res=300)
g
dev.off()

g <- ggplot(ae_scores, aes(y=score,x=country))+
  geom_boxplot(notch=TRUE, staplewidth=0.1)+
  geom_point(data=ae_scores_country,aes(colour=factor(indicator_label, levels=unique(indicator_label[order(indicator_order)]))),size=3.8)+
  labs(y="Agroecology score (1 to 5)",  x="")+
  coord_cartesian(clip="off")+
  #scale_fill_manual(values=col.ae.principle)+
  scale_colour_manual(values=col.ae.principle)+
  #scale_y_continuous(limits=c(1,5),breaks=seq(1,5,1))+
    theme_minimal()+ 
    theme(plot.title = element_text(hjust=0.5),
          axis.text=element_text(size=10,colour="black"),         
          legend.position="right",
          legend.title=element_blank())

g

tiff(paste0(global.data.path,"figures/ae_boxplot_w_points_global.png"),width=7,height=4.5,units="in", res=300)
g
dev.off()

#### Tile plot of agroecology scores v kpi scores ####

kpi_scores_full <- kpi_scores_full %>% mutate(score_ae_overall_classes = factor(score_ae_overall_classes,levels=c("Not AE","Weak AE","Moderate AE","Strong AE","Very strong AE")))

check <- kpi_scores_full %>% filter(score_ae_overall_classes == "Check")
# These are missing ind_group, score_scaled, kpi_label_short:
#check <- kpi_scores_full %>% filter(indicator =="kpi8_climate_mitigation")
#check <- kpi_scores_full %>% filter(indicator =="kpi7_landscape_complexity")

ggplot(kpi_scores_full %>% filter(!(score_ae_overall_classes == "Check")),aes(y=score_scaled,x=score_ae_overall_classes,fill=theme))+ 
  geom_boxplot(outlier.colour="red",notch=TRUE)+
  labs(y="Performance score (0 to 100)",
       x="Agroecology adherence")+
  scale_fill_manual(values=col.theme)+
  theme_classic()

g <- ggplot(kpi_scores_full %>% filter(!(score_ae_overall_classes == "Check")),aes(y=score_scaled,x=theme,fill=score_ae_overall_classes))+ 
  geom_boxplot(notch=TRUE, staplewidth=0.3, linewidth=0.5)+
  labs(y="Performance score (0 to 100)",
       x="Performance dimension")+
  scale_fill_manual(values=col.ae.class,name="Adherence to\nagroecology (AE)")+
  theme_classic()+theme(text = element_text(size=10,colour="black"))
g

tiff(paste0(global.data.path,"figures/kpi_by_ae_boxplot_global.png"),width=6,height=3.5,units="in", res=300)
g
dev.off()

g <- kpi_scores_full %>% filter(!(score_ae_overall_classes == "Check")) %>% filter(!is.na(score_scaled)) %>%
group_by(country,indicator, kpi_label_short,theme,score_ae_overall_classes) %>% summarise(score_scaled=mean(score_scaled,na.rm=TRUE)) %>% ungroup() %>% 
  rbind(kpi_scores_full %>%
  filter(!(score_ae_overall_classes == "Check")) %>% filter(!is.na(score_scaled)) %>%
  group_by(indicator,kpi_label_short,theme,score_ae_overall_classes) %>%
    summarise(score_scaled=mean(score_scaled,na.rm=TRUE)) %>%
    mutate(country="All") %>% ungroup()) %>%
  ggplot(aes(y=factor(kpi_label_short,levels=unique(kpi_label_short[order(theme, indicator)])),x=score_ae_overall_classes,fill=score_scaled),colour="grey80")+ 
  geom_tile()+
  scale_fill_binned(breaks=c(0,20,40,60,80,100),low="pink", high="forestgreen", name="Mean\nperformance\nscores (0 to 100)")+
  labs(x="",y="")+
  theme_classic()+
  facet_wrap(~country,nrow=1)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
        axis.text.y=element_text(colour=c(rep("#305127",5),rep("#B36971",9),rep("#699E5C",9),rep("#511F47",5))),
        strip.background = element_blank(), strip.placement = "outside")
g

tiff(paste0(global.data.path,"figures/kpi_by_ae_geomtile_global.png"),width=10,height=5,units="in", res=300)
g
dev.off()


#### Compute correlation between overall ae score and each KPI #####

kpi_scores_full <- kpi_scores_full %>%
  mutate(indicator_label = sub("^kpi[0-9]+[a-z]?_", "",indicator)) %>%
  mutate(indicator_label = gsub("_"," ",indicator_label))

cor.basic <- kpi_scores_full %>%
  group_by(country,theme,indicator) %>%
  summarize(correlation = cor(score_ae_overall, score, method = "pearson", use = "pairwise.complete.obs"))%>% 
  filter(!is.na(correlation)) %>%
  rbind(kpi_scores_full %>%
  group_by(theme,indicator) %>%
  summarize(correlation = cor(score_ae_overall, score, method = "pearson", use = "pairwise.complete.obs"))%>% 
  filter(!is.na(correlation)) %>%
    mutate(country = "All")) %>%
  mutate(order_all = ifelse(country=="All",correlation,NA)) %>%
  left_join(data.frame(col.theme) %>% mutate(theme = row.names(.))) 

cor.vars <- kpi_scores_full %>% 
  select(country,kobo_farmer_id,indicator,score) %>% unique() %>%
  filter(!(score ==Inf)) %>%
  pivot_wider(id_cols=c(country,kobo_farmer_id),names_from=indicator,values_from=score, values_fn = ~ mean(.x, na.rm = TRUE)) %>%
  left_join(kpi_scores_full %>% select(kobo_farmer_id, country, score_ae_overall, score_ae_overall_classes) %>% unique())

#data = cor.vars
#var1=names(cor.vars)[31]
#var2=names(cor.vars)[23]

cor.func <- function(var1, var2,data) {
  #data <- data %>% mutate_at(vars(-country,-kobo_farmer_id,-score_ae_overall_classes),~ifelse(is.na(.),0,.))
    data <- na.omit(data[c(var1, var2)])
    #data <- data %>% filter(!(is.infinite(c(var2))==TRUE)) #not working...labour has one infinite value
  # Check if there are enough data points (at least 3 for correlation to be meaningful)
  if (nrow(data) < 6) {
    # Return a placeholder result if insufficient data
    return(data.frame(
      var1 = var1, 
      var2 = var2, 
      estimate = NA, 
      p.value = NA, 
      statistic = NA, 
      method = "Not enough data", 
      stringsAsFactors = FALSE
    ))
  }
      result = cor.test(data[[var1]], data[[var2]])
      data.frame(var1, var2, result[c("estimate","p.value","statistic","method")], 
             stringsAsFactors=FALSE)
}

names(cor.vars) # set v1 to column with agroecology score, v2 to columns which should be excluded form correlation analysis
vars = data.frame(v1=names(cor.vars)[31], v2=names(cor.vars)[-c(1,2,31,32)])

cor = do.call(rbind, mapply(cor.func, var1=vars[,1], var2=vars[,2], MoreArgs=list(data=cor.vars), SIMPLIFY=FALSE))
rownames(cor) <- NULL

# by country
cor.vars.split <- split(cor.vars,cor.vars$country) 

cor.country = do.call(rbind, lapply(names(cor.vars.split), function(country){
  country_data <- cor.vars.split[[country]]
  results <- do.call(rbind, mapply(
    cor.func, 
    var1=vars[,1], 
    var2=vars[,2],
    MoreArgs=list(data=country_data), SIMPLIFY=FALSE))
   results$country <- country
  return(results)
}))

rownames(cor.country) <- NULL
#cor.test(cor.vars$kpi1_crop_health, cor.vars$score_ae_overall)
#cor.test(cor.vars[["kpi1_crop_health"]], cor.vars[["score_ae_overall"]])

cor <- cor %>% mutate(country = "All") %>% rbind(cor.country) %>%
  rename(indicator = var2) %>%
  mutate(order_all = ifelse(country=="All",estimate,NA)) %>%
  left_join(kpi_scores_full %>% select (theme, indicator, indicator_label) %>% unique()) %>%
  left_join(data.frame(col.theme) %>% mutate(theme = row.names(.))) 

cor <- cor %>% mutate(p.value.label = ifelse(p.value < 0.01, "**",ifelse(p.value<0.05,"*",""))) %>%
  mutate(estimate.label = ifelse(is.na(estimate),"",paste0(round(estimate,1),p.value.label)))

cor <- cor %>% left_join(kpi_scores_full %>%select(indicator,kpi_label_short) %>% unique()) 
cor <- cor %>% 
  mutate(kpi_label_short = case_when(indicator =="kpi7_landscape_complexity"~"Landscape complexity (qual)",
                                     indicator =="kpi8_climate_mitigation"~"Climate mitigation (qual)", .default=kpi_label_short))

#print(cor, n=25)  

g <- ggplot(cor, aes(x=country,y=factor(kpi_label_short, levels=unique(kpi_label_short[order(theme,indicator)])), fill=estimate))+
  #ggplot(cor, aes(x=country,y=factor(indicator, levels=unique(indicator[order(order_all)])), fill=estimate))+
  geom_tile() + scale_fill_gradientn(colours=c("red", "lightyellow","steelblue"),name="Correlation")+
  geom_text(aes(label=estimate.label))+
  theme_minimal()+
  theme(axis.title = element_blank(), text=element_text(size=10,colour="black"),
        axis.text.x = element_text(size=10,colour="black"),
        #axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
        axis.text.y=element_text(size=10, colour=c(rep("#305127",5),rep("#B36971",9),rep("#699E5C",9),rep("#511F47",5))))
g 

tiff(paste0(global.data.path,"figures/kpi_and_ae_correlation_geomtile_global.png"),width=10,height=6,units="in", res=300)
g
dev.off()

#### ANOVA to see if performance differences between ae groups is significant ####

anova

#kpi_scores_cor <- kpi_scores_full %>% dcast(country+kobo_farmer_id+score_ae_overall_classes+score_ae_overall ~indicator,value.var="score",mean) %>% mutate(across(everything(), ~ifelse(is.na(.x), 0, .x))) 

# exclude labour for now, because it's creating empty values
#cor <- cor(kpi_scores_cor[,c(4:11,14:31)], use = "pairwise.complete.obs")
#corrplot(cor, tl.cex=0.5)
#ggcorrplot(cor, method="square",type="full", ggtheme=theme_minimal, colors= c("navy","lightyellow","orange"), tl.cex=9)+#scale_fill_continuous(brewer.pal(5,"Spectral"))+ theme(axis.text=element_text(size=8))
#ggpairs(kpi_scores_cor, columns = 4:31, ggplot2::aes(colour=score_ae_overall_classes))
 
#cor_cols <- brewer.pal(5, "Spectral")
#cor_cols <- colorRampPalette(cor_cols)(100)
#plotcorr(cor , col=cor_cols, mar=c(1,1,1,1))

# simple linear model
# intercept is value of var1 when var2 = 0
# slope (estimate) is the direction of the relationship, specifically the expected change in var1 for a one-unit increase in var2 
# p value shows whether the relationship is significantly different from zero
# R-squared shows how much variance in Var 1 is unexplained by Var2 (R2 = 0 means no variance is explained, R2 = 1 means 100% variance is explained)
#the F-statistic evaluates whether the model explains a significant amount of the variance in the dependent variable compared to a model with no predictors.

model <- lm(score ~  score_ae_overall, data = kpi_scores_full %>% filter(indicator == "kpi1_crop_health"))
summary(model)

model <- lm(score ~  score_ae_overall + Village + training, data = kpi_scores_full %>% filter(indicator == "kpi1_crop_health"))
summary(model)

# Mixed-effects model with random slopes
# shows the variability in the relationship between Var1 and Var2 across groups.
# variance of the random effects (also called sd in the summary) quantifies how much the intercepts and slopes vary across groups.
# residual variance shows the amount of unexplained variation in Var1 after accounting for both the fixed and random effects (R = 0 means no unexplained variance, R = 1 means high amount of unexplained variance)
model <- lmer(score ~  score_ae_overall+ (score_ae_overall | indicator), data = kpi_scores_full)
summary(model) 

# Extract random effects
groupwise_effects <- ranef(model)$indicator
print(groupwise_effects)

# Future analyses to do: 

# PCA to explore how agroecology score and context collectively relate to indicator scores...

# Check correlations when splitting by other variables, like farm size, ALL, income

# Partial correlations, to check the relationship between two variables while controlling confounding effects of a third variable (third variable is held constant)
partial_corr <- pcor.test(cor.vars$indicator, cor.vars$agroecology_score, cor.vars$confounding_variable)
print(partial_corr)

####--------------- LANDSCAPE LEVEL ---------------------
ggplot(ALL_kpi_scores_full %>% filter(!is.na(kpi_score_scaled_mean)& !is.na(score_ae_overall_classes)), aes(x=kpi_score_scaled_mean,y=reorder(indicator,kpi_score_scaled_mean),fill=score_ae_overall_classes))+
    geom_col(width=0.5,show.legend=TRUE, position=position_dodge()) + 
    ggtitle(paste0("KPIs for ",country))+labs(x="KPI score (scaled from 0-100)")+
    coord_cartesian(expand=c(0),clip="off")+
    scale_x_continuous(breaks=seq(0,100,20),limits=c(0,110))+
    scale_fill_manual(values=col.ae.class)+
    scale_colour_manual(values=col.ae.class)+
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          axis.title.y=element_blank(), 
          legend.position="bottom",
          legend.title=element_blank())

ggplot(ALL_kpi_scores_full %>% filter(!is.na(kpi_score_scaled_mean)& !is.na(score_ae_overall_classes)), aes(x=score_ae_overall_classes,y=reorder(indicator,kpi_score_scaled_mean),fill=kpi_score_scaled_mean ))+
    geom_tile(show.legend=TRUE) + 
    ggtitle(paste0("KPIs for ",country))+labs(x="KPI score (scaled from 0-100)")+
    coord_cartesian(expand=c(0),clip="off")+
    #scale_x_continuous(breaks=seq(0,100,20),limits=c(0,110))+
    scale_fill_gradientn(breaks=seq(0,100,20),colours =c("steelblue", "gold", "forestgreen"))+ #low="purple",mid = "gold",high="forestgreen")+
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          axis.title.y=element_blank(), 
          legend.position="bottom",
          legend.title=element_blank())

ggsave(paste0(global.data.path,"figures/kpi_tile_by_ae_score_",country,".tif"),width=7,height=6,units="in")

ggplot(ALL_kpi_scores_full %>% filter(!is.na(kpi_score_scaled_mean) & !is.na(score_ae_overall_classes)), aes(x=kpi_score_scaled_mean,y=reorder(kpi_label_short,kpi_score_scaled_mean),fill=score_ae_overall_classes))+
    geom_point(aes(colour=score_ae_overall_classes),alpha=0.7, size=4) +
  geom_smooth(aes(group=score_ae_overall_classes, colour=score_ae_overall_classes),method = "lm", se=FALSE, show.legend=FALSE)+
    ggtitle(paste0("KPIs for ",country))+labs(x="KPI score (scaled from 0-100)")+
    coord_cartesian(expand=c(0),clip="off")+
    scale_x_continuous(breaks=seq(0,100,20),limits=c(0,110))+
    scale_fill_manual(values=col.ae.class)+ #terrain.colors(5))+
    scale_colour_manual(values=col.ae.class)+#terrain.colors(5))+
    theme_classic()+ 
    theme(plot.title = element_text(hjust=0.5),
          axis.title.y=element_blank(), 
          legend.position="bottom",
          legend.title=element_blank())



```

